<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×‘×—×™×¨×ª ×¤×¨×™×˜×™× ×œ×ª×©×œ×•×</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/styles.css" />
  <script src="/assets/translations.js"></script>
  <style>
    .ck-list { display:flex; flex-direction:column; gap:14px; margin:14px 0; }
    .ck-row  { display:grid; grid-template-columns:auto 90px 1fr; align-items:center; gap:12px; padding:10px;
               border:1px solid #eee; border-radius:10px; background:#fff; cursor: pointer; transition: all 0.2s ease; }
    .ck-row:hover { box-shadow: 0 4px 8px rgba(0,0,0,0.1); background: #fafafa; }
    .ck-row img { width:90px; height:90px; object-fit:cover; border-radius:8px; }
    .quantity-info { background: var(--primary-color); color: white; padding: 6px 12px; border-radius: 16px; font-size: 13px; font-weight: bold; min-width: 50px; text-align: center; box-shadow: var(--shadow-sm); }
    .price-line{ margin-top:4px; font-weight:700; color: var(--primary-color); }
    #sum-box{ margin:10px 0 16px; font-weight:800; border-top:1px solid #ddd; padding-top:10px; color: var(--primary-color); }
    
    /* ×¢×™×¦×•×‘ ××™×•×—×“ ×œ×¢×•×’×•×ª ××•×ª×××•×ª */
    .custom-cake-badge {
      background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-right: 8px;
      display: inline-block;
    }
    
    .design-details-mini {
      background: rgba(255, 107, 157, 0.1);
      border-radius: 6px;
      padding: 4px 8px;
      margin-top: 4px;
      font-size: 11px;
      line-height: 1.3;
      border-right: 2px solid var(--primary-color);
    }
    
    .design-detail-mini {
      display: inline-block;
      margin-left: 8px;
      color: #666;
      font-weight: 500;
    }
    
    .design-detail-mini:first-child {
      margin-left: 0;
    }
    
    .custom-text-preview-mini {
      background: white;
      border: 1px solid var(--primary-color);
      border-radius: 4px;
      padding: 2px 6px;
      font-weight: bold;
      display: inline-block;
      margin-right: 4px;
      font-size: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html" id="nav-home" class="nav-item" data-key="nav.home"> ×‘×™×ª</a>
    <a href="store.html" id="nav-store" data-key="nav.store">×—× ×•×ª</a>
    <a href="cart.html" id="nav-cart" data-key="nav.cart">×¡×œ ×”×§× ×™×•×ª</a>
    <a href="checkout.html" id="nav-checkout" data-key="nav.checkout">×ª×©×œ×•×</a>
    <a href="myitems.html" id="nav-myitems" data-key="nav.myPurchases">×”×¨×›×™×©×•×ª ×©×œ×™</a>
    <a id="login-link" href="login.html" data-key="nav.login">×”×ª×—×‘×¨×•×ª</a>
    <button id="logout" style="display:none" data-key="nav.logout">×”×ª× ×ª×§×•×ª</button>
    <a href="admin.html" id="nav-admin" data-key="nav.admin" style="display:none">× ×™×”×•×œ</a>
    <a href="cake-designer.html" data-key="nav.cakeDesigner">×¢×™×¦×•×‘ ×¢×•×’×”</a>
    <a href="dessert-finder.html" data-key="nav.dessertFinder"> ××¦×™××ª ×§×™× ×•×— ××•×©×œ×</a>
    <a href="wheel.html" data-key="nav.wheel"> ×’×œ×’×œ ××–×œ</a>
    <a href="recipes.html" id="nav-recipes" data-key="nav.recipes"> ××ª×›×•× ×™×</a>
    <button id="theme-toggle">ğŸŒ™ ××¦×‘ ×›×”×”</button>
    <button id="language-toggle">ğŸŒ English</button>
  </nav>

  <h1 id="page-title" data-key="pages.checkoutTitle">×‘×—×™×¨×ª ×¤×¨×™×˜×™× ×œ×ª×©×œ×•×</h1>

  <div id="list" class="ck-list"></div>
  <div style="display:flex;justify-content:flex-end;align-items:center;gap:12px">
    <div id="total" style="font-weight:800"></div>
    <button id="go-pay" class="btn" data-key="checkout.continueToPay">×”××©×š ×œ×ª×©×œ×•×</button>
  </div>

  <script>
    // ×˜×¢×™× ×ª ×”×ª×××•×ª ××™×©×™×•×ª ×-localStorage
    function loadUICustomization() {
      const theme = localStorage.getItem('theme') || 'light';
      const themeToggle = document.getElementById('theme-toggle');
      const languageToggle = document.getElementById('language-toggle');
      
      // ×¢×“×›×•×Ÿ × ×•×©×
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
        if (window.Translations && window.Translations.get) {
          themeToggle.textContent = 'â˜€ï¸ ' + window.Translations.get('themeToggleLight');
        } else {
          themeToggle.textContent = 'â˜€ï¸ ××¦×‘ ×‘×”×™×¨';
        }
      } else {
        document.body.classList.remove('dark-theme');
        if (window.Translations && window.Translations.get) {
          themeToggle.textContent = 'ğŸŒ™ ' + window.Translations.get('themeToggleDark');
        } else {
          themeToggle.textContent = 'ğŸŒ™ ××¦×‘ ×›×”×”';
        }
      }
      
      // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨ ×©×¤×”
      const currentLanguage = localStorage.getItem('language') || 'he';
      if (currentLanguage === 'en') {
        languageToggle.textContent = 'ğŸŒ ×¢×‘×¨×™×ª';
        document.documentElement.dir = 'ltr';
        document.documentElement.lang = 'en';
      } else {
        languageToggle.textContent = 'ğŸŒ English';
        document.documentElement.dir = 'rtl';
        document.documentElement.lang = 'he';
      }
      
      // ×¢×“×›×•×Ÿ ×ª×¨×’×•××™×
      if (window.Translations && window.Translations.updateDomTexts) {
        window.Translations.updateDomTexts();
      }
    }

    // ×”×—×œ×¤×ª × ×•×©×
    document.getElementById('theme-toggle').addEventListener('click', () => {
      const isDark = document.body.classList.contains('dark-theme');
      const newTheme = isDark ? 'light' : 'dark';
      localStorage.setItem('theme', newTheme);
      loadUICustomization();
    });

    // ×”×—×œ×¤×ª ×©×¤×”
    document.getElementById('language-toggle').addEventListener('click', () => {
      if (window.Translations && window.Translations.toggleLanguage) {
        window.Translations.toggleLanguage();
        loadUICustomization();
        render(); // ×˜×¢×™× ×” ××—×“×© ×¢× ×”×©×¤×” ×”×—×“×©×”
      } else {
        // fallback ×× ×”×¤×•× ×§×¦×™×” ×œ× × ×˜×¢× ×”
        const currentLang = localStorage.getItem('language') || 'he';
        const newLang = currentLang === 'he' ? 'en' : 'he';
        localStorage.setItem('language', newLang);
        loadUICustomization();
        render();
      }
    });

    // ===== helpers =====
    const nis = n => `â‚ª${n}`;
    const slug = s => String(s||'').trim().toLowerCase().replace(/[^\p{L}\p{N} ]/gu,'').replace(/\s+/g,'-');

    // ××—×™×¨×•×Ÿ ×•×©××•×ª
    const PRICE_MAP = {
      'chocolate-cake':150, '8-cookies-box':125, 'cupcakes':160, 'minnie-mous-cake':300,
      'nutella-box':70, 'chocolate-pizza-xl':120, 'bento-design-cake':140,
      'chocolate-design-cake':180, 'orange-cake':70, 'white-design-cake':140,
      'pizza-cookie':120, 'pizza cookie':120
    };

    const priceOf = (p) => {
      const keys = [p.id, slug(p.id), p.title, slug(p.title)];
      const hit = keys.find(k => k && PRICE_MAP[k] != null);
      return hit ? PRICE_MAP[hit] : (/(cookie)/i.test(String(p.id)+p.title) ? 17 : 0);
    };

    const nameOf = (p) => {
      if (window.Translations && window.Translations.getProduct) {
        const translated = window.Translations.getProduct(p.id);
        if (translated && translated !== p.id) return translated;
      }
      return p.title || p.id;
    };

    // ××¦×‘ ×”×ª×—×‘×¨×•×ª
    (async () => { 
      try { 
        const r=await fetch('/api/session'); 
        if(r.ok){
          const data = await r.json();
          document.getElementById('login-link').style.display='none'; 
          document.getElementById('logout').style.display='';
          if (data.username === 'admin') {
            document.getElementById('nav-admin').style.display = '';
          }
        } 
      } catch{} 
    })();
    document.getElementById('logout').onclick = async () => { try{await fetch('/api/logout',{method:'POST'})}finally{location.href='/screens/login.html'} };

    let PRODUCTS=[];
    async function loadProducts(){ 
      try{ 
        const r=await fetch('/api/products'); 
        PRODUCTS=r.ok?await r.json():[]; 
      }catch{} 
    }

    // ×¤×•× ×§×¦×™×” ×œ×ª×¨×’×•× ×¦×‘×¢×™×
    function getColorName(color) {
      const currentLang = localStorage.getItem('language') || 'he';
      if (window.Translations && window.Translations.get) {
        const colorKey = `cakeDesigner.colors.${color.replace('-', '')}`;
        const translated = window.Translations.get(colorKey);
        if (translated && translated !== colorKey) return translated;
      }
      
      // fallback
      const colorNames = {
        he: {
          'pink': '×•×¨×•×“', 'white': '×œ×‘×Ÿ', 'green': '×™×¨×•×§', 'red': '××“×•×',
          'purple': '×¡×’×•×œ', 'light-blue': '×›×—×•×œ ×‘×”×™×¨', 'orange': '×›×ª×•×'
        },
        en: {
          'pink': 'Pink', 'white': 'White', 'green': 'Green', 'red': 'Red',
          'purple': 'Purple', 'light-blue': 'Light Blue', 'orange': 'Orange'
        }
      };
      return colorNames[currentLang]?.[color] || color;
    }

    // ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª ××¤×ª×— ×™×™×—×•×“×™ ×œ×¢×•×’×” ××•×ª×××ª
    function getCustomCakeKey(design) {
      return `${design.size}-${design.color}-${design.text || ''}-${design.textColor}`;
    }

    // ×¨×™× ×“×•×¨ ×¢×•×’×” ××•×ª×××ª ×‘-checkout
    function renderCustomCakeForCheckout(customCake, quantity = 1) {
      const design = customCake.design;
      const currentLang = localStorage.getItem('language') || 'he';
      
      const sizeText = currentLang === 'en'
        ? (design.size === 'bento' ? 'Bento (10cm)' : 'Large (22cm)')
        : (design.size === 'bento' ? '×‘× ×˜×• (10 ×¡"×)' : '×’×“×•×œ×” (22 ×¡"×)');
      
      const colorName = getColorName(design.color);
      const total = design.price * quantity;
      
      const customBadge = currentLang === 'en' ? 'ğŸ¨ Custom' : 'ğŸ¨ ××•×ª×××ª';
      const cakeText = currentLang === 'en' ? 'Cake' : '×¢×•×’×”';
      const colorText = currentLang === 'en' ? 'Color:' : '×¦×‘×¢:';
      const textText = currentLang === 'en' ? 'Text:' : '×›×™×ª×•×‘:';
      const noTextText = currentLang === 'en' ? 'No text' : '×œ×œ× ×›×™×ª×•×‘';
      
      const row = document.createElement('label');
      row.className = 'ck-row';
      row.innerHTML = `
        <input type="checkbox" data-custom-ids="${customCake.ids ? customCake.ids.join(',') : customCake.id}" checked>
        <img src="/images/cakes/${design.imageFile || `cake-${design.color}.png`}" alt="×¢×•×’×” ××•×ª×××ª">
        <div>
          <div style="font-weight:700">
            <span class="custom-cake-badge">${customBadge}</span>
            ${cakeText} ${sizeText}
          </div>
          <div class="design-details-mini">
            <span class="design-detail-mini"><strong>${colorText}</strong> ${colorName}</span>
            ${design.text ? `<span class="design-detail-mini"><strong>${textText}</strong> <span class="custom-text-preview-mini" style="color: ${design.textColor}">"${design.text}"</span></span>` : `<span class="design-detail-mini">${noTextText}</span>`}
          </div>
          <div class="price-line">${nis(design.price)} Ã— ${quantity} = <strong>${nis(total)}</strong></div>
        </div>
      `;
      
      return row;
    }

    // ×××™×¨ ×›×œ ×¤×•×¨××˜ ×œâ€{id: qty}
    function toQtyMap(payload){
      if (payload && typeof payload==='object' && Array.isArray(payload.items)) payload = payload.items;
      const q={};
      if (Array.isArray(payload)){
        for (const it of payload){
          if (typeof it==='string'){ q[it]=(q[it]||0)+1; continue; }
          if (it && typeof it==='object'){
            const id = it.id || it.productId;
            const qty = Number(it.qty ?? it.quantity ?? 1);
            if (id) q[id]=(q[id]||0)+qty;
          }
        }
      } else if (payload && typeof payload==='object'){
        for (const [id,val] of Object.entries(payload)){
          q[id] = typeof val==='number' ? val : Number(val?.qty ?? val?.quantity ?? 1);
        }
      }
      return q;
    }

    // ×§×‘×œ×ª × ×ª×•× ×™ ×”×¢×’×œ×” ×¢× ×¢×•×’×•×ª ××•×ª×××•×ª
    async function getCartMap(){
      try {
        const res = await fetch('/api/cart-with-custom');
        if (res.status === 401) { location.href = '/screens/login.html'; return {}; }
        if (res.ok) {
          return await res.json();
        }
      } catch {}

      // fallback ×œ-API ×™×©×Ÿ
      try {
        const r = await fetch('/api/cart');
        if (!r.ok) return {};
        const quantities = toQtyMap(await r.json());
        return { regularItems: quantities, customCakes: [] };
      } catch { 
        return { regularItems: {}, customCakes: [] }; 
      }
    }

    let cartData = {};
    let customCakes = [];
    let groupedCustomCakes = {};

    function computeTotalFromChecked(){
      let total = 0;
      
      // ××•×¦×¨×™× ×¨×’×™×œ×™×
      document.querySelectorAll('.ck-row input[type="checkbox"]:not([data-custom-ids])').forEach(cb => {
        if (!cb.checked) return;
        const id = cb.value;
        const qty = Number(cartData.regularItems?.[id] || 0);
        const p = PRODUCTS.find(x => String(x.id) === String(id)) || {id, title:id};
        const unit = priceOf(p);
        total += (unit || 0) * qty;
      });

      // ×¢×•×’×•×ª ××•×ª×××•×ª
      document.querySelectorAll('.ck-row input[type="checkbox"][data-custom-ids]').forEach(cb => {
        if (!cb.checked) return;
        const customIds = cb.getAttribute('data-custom-ids').split(',');
        customIds.forEach(customId => {
          const cake = customCakes.find(c => c.id === customId);
          if (cake) {
            total += cake.design.price;
          }
        });
      });

      const currentLang = localStorage.getItem('language') || 'he';
      const totalText = currentLang === 'en' ? 'Total: ' : '×¡×”×´×› ××—×™×¨: ';
      document.getElementById('total').textContent = totalText + nis(total);
    }

    async function render(){
      const list = document.getElementById('list');
      list.innerHTML = '';

      cartData = await getCartMap();
      customCakes = cartData.customCakes || [];

      console.log('Cart data:', cartData);
      console.log('Custom cakes:', customCakes);

      const regularEntries = Object.entries(cartData.regularItems || {});
      const hasRegularItems = regularEntries.length > 0;
      const hasCustomCakes = customCakes.length > 0;

      if (!hasRegularItems && !hasCustomCakes) {
        const currentLang = localStorage.getItem('language') || 'he';
        const emptyText = currentLang === 'en' ? 'Cart is empty' : '×”×¢×’×œ×” ×¨×™×§×”';
        document.getElementById('total').textContent = currentLang === 'en' ? 'Total: â‚ª0' : '×¡×”×´×› ××—×™×¨: â‚ª0';
        list.innerHTML = `<p class="empty">${emptyText}</p>`;
        return;
      }

      // ×”×¦×’×ª ××•×¦×¨×™× ×¨×’×™×œ×™×
      if (hasRegularItems) {
        for (const [id, qty] of regularEntries) {
          const p = PRODUCTS.find(x => String(x.id) === String(id)) || {id, title:id, image:''};
          const productName = nameOf(p);
          const unit = priceOf(p);
          const total = unit * Number(qty);

          const row = document.createElement('label');
          row.className = 'ck-row';
          row.innerHTML = `
            <input type="checkbox" value="${id}" checked />
            <img src="/images/${p.image || 'placeholder.png'}" alt="${productName}">
            <div>
              <div style="font-weight:700">${productName}</div>
              <div class="price-line">${nis(unit)} Ã— ${qty} = <strong>${nis(total)}</strong></div>
            </div>
          `;
          list.appendChild(row);
        }
      }

      // ×”×¦×’×ª ×¢×•×’×•×ª ××•×ª×××•×ª
      if (hasCustomCakes) {
        // ×§×™×‘×•×¥ ×¢×•×’×•×ª ××•×ª×××•×ª ×œ×¤×™ ×××¤×™×™× ×™× ×–×”×™×
        groupedCustomCakes = {};
        customCakes.forEach(cake => {
          const key = getCustomCakeKey(cake.design);
          if (!groupedCustomCakes[key]) {
            groupedCustomCakes[key] = {
              cake: cake,
              quantity: 0,
              ids: []
            };
          }
          groupedCustomCakes[key].quantity++;
          groupedCustomCakes[key].ids.push(cake.id);
        });

        // ×”×¦×’×ª ×¢×•×’×•×ª ××•×ª×××•×ª ×¢× ×›××•×™×•×ª ××§×•×‘×¦×•×ª
        Object.values(groupedCustomCakes).forEach(group => {
          const cakeElement = renderCustomCakeForCheckout({
            ...group.cake,
            ids: group.ids
          }, group.quantity);
          list.appendChild(cakeElement);
        });
      }

      computeTotalFromChecked();
      list.addEventListener('change', (e) => {
        if (e.target.matches('input[type="checkbox"]')) computeTotalFromChecked();
      });
    }

    // ×©××™×¨×ª ×”×‘×—×™×¨×” ×•×”××©×š ×œ×ª×©×œ×•×
    document.getElementById('go-pay').onclick = () => {
      const selectedItems = [];
      
      // ××•×¦×¨×™× ×¨×’×™×œ×™×
      document.querySelectorAll('.ck-row input[type="checkbox"]:not([data-custom-ids]):checked').forEach(cb => {
        const id = cb.value;
        const qty = Number(cartData.regularItems?.[id] || 0);
        for (let i = 0; i < qty; i++) {
          selectedItems.push(id);
        }
      });

      // ×¢×•×’×•×ª ××•×ª×××•×ª
      document.querySelectorAll('.ck-row input[type="checkbox"][data-custom-ids]:checked').forEach(cb => {
        const customIds = cb.getAttribute('data-custom-ids').split(',');
        selectedItems.push(...customIds);
      });

      console.log('Selected items for checkout:', selectedItems);
      
      if (selectedItems.length === 0) {
        const currentLang = localStorage.getItem('language') || 'he';
        const alertText = currentLang === 'en' ? 'Please select items for payment' : '× × ×œ×‘×—×•×¨ ×¤×¨×™×˜×™× ×œ×ª×©×œ×•×';
        alert(alertText);
        return;
      }
      
      location.href = '/screens/pay.html';
    };

    (async() => { 
      await loadProducts(); 
      // ×”×©×”×™×” ×§×˜× ×” ×œ×˜×¢×™× ×ª ××¢×¨×›×ª ×”×ª×¨×’×•×
      setTimeout(() => {
        loadUICustomization();
      }, 100);
      await render(); 
    })();
  </script>
</body>
</html>
