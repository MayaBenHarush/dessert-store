<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×‘×—×™×¨×ª ×¤×¨×™×˜×™× ×œ×ª×©×œ×•×</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="/assets/translations.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #ffffff; color: #1a1a1a; line-height: 1.6;
    }

    /* Header */
    .header {
      background: #ffffcc; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .header-left { display: flex; align-items: center; gap: 1rem; }
    .menu-btn { background: none; border: none; font-size: 1.1rem; font-weight: 600; color: #1a1a1a; cursor: pointer; display: flex; align-items: center; gap: .5rem; }
    .menu-btn::before { content: "â˜°"; font-size: 1.2rem; }
    .logo { font-size: 2.2rem; font-weight: 900; color: #1a1a1a; text-decoration: none; letter-spacing: -0.02em; }
    .header-nav { display: flex; align-items: center; gap: 1rem; }
    .header-btn {
      background: none; border: 2px solid #1a1a1a; color: #1a1a1a; padding: .5rem 1rem; border-radius: 20px;
      font-weight: 600; font-size: .9rem; cursor: pointer; transition: all .2s ease; text-decoration: none; display: flex; align-items: center; gap: .3rem;
    }
    .header-btn:hover { background: #1a1a1a; color: white; }
    .header-btn.primary { background: #1a1a1a; color: white; }
    .header-btn.primary:hover { background: #333; }

    /* ×”×¡×¨ ××™×§×•×Ÿ ×¨×§ ×œ×”×ª×—×‘×¨×•×ª â€” ××©××™×¨×™×. ×‘×™×ª/×¡×œ ×˜×§×¡×˜ ×‘×œ×‘×“ */
    .login-btn::before { content: "ğŸ‘¤"; }
    .home-btn::before, .cart-btn::before { content: none !important; display: none !important; }

    /* Navigation Menu */
    .nav-menu {
      position: fixed; top: 0; right: -300px; width: 300px; height: 100vh; background: white;
      box-shadow: -5px 0 15px rgba(0,0,0,0.1); transition: right .3s ease; padding: 2rem; z-index: 2000;
    }
    .nav-menu.active { right: 0; }
    .nav-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; float: left; margin-bottom: 2rem; }
    .nav-item, .nav-menu a, .nav-menu button {
      display: block; padding: .75rem 0; color: #1a1a1a; text-decoration: none; font-weight: 500;
      border-bottom: 1px solid #f0f0f0; transition: color .2s ease; background: none; border: none; text-align: right; width: 100%; cursor: pointer;
    }
    .nav-item:hover, .nav-menu a:hover, .nav-menu button:hover { color: #ffffcc; }

    /* Overlay */
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1500; opacity: 0; visibility: hidden; transition: all .3s ease; }
    .overlay.active { opacity: 1; visibility: visible; }

    /* Main Content */
    .main-content { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    .page-header { text-align: center; margin-bottom: 2rem; }
    #page-title {
      font-size: 3rem; font-weight: 900; color: #1a1a1a; margin-bottom: 1rem; letter-spacing: -0.02em; text-transform: uppercase;
    }

    /* Checkout List */
    .ck-list { display: flex; flex-direction: column; gap: 1.5rem; margin: 2rem 0; }
    .ck-row {
      display: grid; grid-template-columns: auto 90px 1fr; align-items: center; gap: 1rem; padding: 1.5rem;
      border: none; border-radius: 15px; background: white; cursor: pointer; transition: all .3s ease; box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }
    .ck-row:hover { transform: translateY(-2px); box-shadow: 0 15px 40px rgba(0,0,0,0.12); }
    .ck-row input[type="checkbox"] { width: 20px; height: 20px; accent-color: #1a1a1a; cursor: pointer; }
    .ck-row img { width: 90px; height: 90px; object-fit: cover; border-radius: 10px; }

    .quantity-info {
      background: #1a1a1a; color: white; padding: .4rem .8rem; border-radius: 20px; font-size: .9rem; font-weight: bold; min-width: 50px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }
    .price-line { margin-top: .5rem; font-weight: 700; color: #1a1a1a; font-size: 1.1rem; }

    /* Custom Cake Styling */
    .custom-cake-badge {
      background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); color: white; padding: .3rem .8rem; border-radius: 20px; font-size: .8rem; font-weight: bold; margin-left: .5rem; display: inline-block;
    }
    .design-details-mini { background: rgba(255,107,157,.1); border-radius: 8px; padding: .5rem; margin-top: .5rem; font-size: .85rem; line-height: 1.4; border-right: 3px solid #ff6b9d; }
    .design-detail-mini { display: inline-block; margin-left: .5rem; color: #666; font-weight: 500; }
    .design-detail-mini:first-child { margin-left: 0; }
    .custom-text-preview-mini {
      background: white; border: 1px solid #ff6b9d; border-radius: 4px; padding: .2rem .4rem; font-weight: bold; display: inline-block; margin-left: .3rem; font-size: .75rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    /* Summary and Total */
    #sum-box { margin: 2rem 0; font-weight: 800; border-top: 2px solid #f0f0f0; padding-top: 1rem; color: #1a1a1a; font-size: 1.2rem; }
    .checkout-footer {
      display: flex; justify-content: flex-end; align-items: center; gap: 1rem; margin-top: 2rem; padding: 1.5rem; background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }
    #total { font-weight: 800; font-size: 1.3rem; color: #1a1a1a; }

    .btn {
      background: #1a1a1a; color: white; border: none; padding: 1rem 2rem; border-radius: 15px; font-weight: 600; font-size: 1rem;
      cursor: pointer; transition: all .3s ease; text-decoration: none; display: inline-flex; align-items: center; gap: .5rem;
    }
    .btn:hover { background: #333; transform: translateY(-2px); box-shadow: 0 15px 40px rgba(0,0,0,0.12); }

    /* Empty state */
    .empty {
      display: flex; justify-content: center; align-items: center; padding: 4rem 2rem; color: #666; text-align: center;
      font-size: 1.1rem; background: #f8f8f8; border-radius: 15px; margin-top: 2rem;
    }

    /* Dark Theme */
    .dark-theme { background: #1a1a1a; color: white; }
    .dark-theme .header { background: #2d2d2d; }
    .dark-theme .nav-menu { background: #2d2d2d; }
    .dark-theme .nav-menu a, .dark-theme .nav-menu button { color: white; border-bottom-color: #444; }
    .dark-theme .ck-row, .dark-theme .checkout-footer { background: #2d2d2d; }
    .dark-theme .ck-row h3, .dark-theme .price-line, .dark-theme #total, .dark-theme #page-title { color: white; }
    .dark-theme .quantity-info { background: #ffffcc; color: #1a1a1a; }
    .dark-theme .btn { background: #ffffcc; color: #1a1a1a; }
    .dark-theme .btn:hover { background: #ffff99; }
    .dark-theme .empty { background: #2d2d2d; color: #ccc; }

    /* Responsive Design */
    @media (max-width: 968px) {
      .header-nav { gap: .5rem; }
      .header-btn { padding: .4rem .8rem; font-size: .8rem; }
      #page-title { font-size: 2.5rem; }
      .ck-row { grid-template-columns: auto 70px 1fr; gap: .8rem; padding: 1rem; }
      .ck-row img { width: 70px; height: 70px; }
    }
    @media (max-width: 768px) {
      .header { padding: 1rem; flex-wrap: wrap; gap: 1rem; }
      .header-left { order: 1; }
      .logo { font-size: 1.8rem; order: 2; }
      .header-nav { order: 3; width: 100%; justify-content: center; gap: .5rem; }
      .header-btn { padding: .4rem .6rem; font-size: .75rem; }
      .main-content { padding: 1rem; }
      #page-title { font-size: 2rem; }
      .ck-row { grid-template-columns: 1fr; text-align: center; gap: 1rem; }
      .checkout-footer { flex-direction: column; text-align: center; }
    }
    @media (max-width: 480px) {
      .header-btn { padding: .3rem .5rem; font-size: .7rem; }
      .header-btn::before { display: none; }
      .ck-row { padding: 1rem; }
    }
  </style>
</head>
<body>
  <div class="overlay" id="overlay"></div>
  
  <header class="header">
    <div class="header-left">
      <button class="menu-btn" id="menuBtn">Menu</button>
      <a href="/" class="logo">dessert</a>
    </div>
    
    <nav class="header-nav">
      <a href="index.html" class="header-btn home-btn">×‘×™×ª</a>
      <!-- ×›×¤×ª×•×¨ ×—× ×•×ª â€” ×˜×§×¡×˜ ×‘×œ×‘×“, ×‘×œ×™ ×œ×•×’×• -->
      <a href="store.html" class="header-btn">×—× ×•×ª</a>
      <a href="cart.html" class="header-btn cart-btn">×¡×œ ×§× ×™×•×ª</a>
      <a href="login.html" class="header-btn login-btn" id="header-login">×”×ª×—×‘×¨×•×ª</a>
    </nav>
  </header>

  <nav class="nav-menu" id="navMenu">
    <button class="nav-close" id="navClose">Ã—</button>

    <a href="store.html" id="nav-store">×—× ×•×ª</a>
    <a href="cart.html" id="nav-cart">×¡×œ ×”×§× ×™×•×ª</a>
    <a href="checkout.html" id="nav-checkout">×ª×©×œ×•×</a>
    <a href="myitems.html" id="nav-myitems">×”×¨×›×™×©×•×ª ×©×œ×™</a>
    <a href="admin.html" id="nav-admin" style="display:none">× ×™×”×•×œ</a>
    <a href="dessert-finder.html">××¦×™××ª ×”×§×™× ×•×— ×”××•×©×œ×</a>
    <a href="wheel.html">×’×œ×’×œ ××–×œ</a>
    <a href="cake-designer.html">×¢×™×¦×•×‘ ×¢×•×’×”</a>
    <a href="recipes.html" id="nav-recipes">××ª×›×•× ×™×</a>
    <button id="logout" style="display:none">×”×ª× ×ª×§×•×ª</button>
    <button id="theme-toggle">ğŸŒ™ ××¦×‘ ×›×”×”</button>
    <button id="language-toggle">ğŸŒ English</button>
  </nav>


  <main class="main-content">
    <div class="page-header">
      <h1 id="page-title" data-key="pages.checkoutTitle">×‘×—×™×¨×ª ×¤×¨×™×˜×™× ×œ×ª×©×œ×•×</h1>
    </div>

    <div id="list" class="ck-list"></div>
    
    <div class="checkout-footer">
      <div id="total" style="font-weight:800"></div>
      <button id="go-pay" class="btn" data-key="checkout.continueToPay">×”××©×š ×œ×ª×©×œ×•×</button>
    </div>
  </main>

  <script>
    // Menu functionality
    const menuBtn = document.getElementById('menuBtn');
    const navMenu = document.getElementById('navMenu');
    const navClose = document.getElementById('navClose');
    const overlay = document.getElementById('overlay');
    function openMenu(){ navMenu.classList.add('active'); overlay.classList.add('active'); document.body.style.overflow='hidden'; }
    function closeMenu(){ navMenu.classList.remove('active'); overlay.classList.remove('active'); document.body.style.overflow='auto'; }
    menuBtn.addEventListener('click', openMenu); navClose.addEventListener('click', closeMenu); overlay.addEventListener('click', closeMenu);

    // ×˜×¢×™× ×ª ×”×ª×××•×ª ××™×©×™×•×ª ×-localStorage
    function loadUICustomization() {
      const theme = localStorage.getItem('theme') || 'light';
      const themeToggle = document.getElementById('theme-toggle');
      const languageToggle = document.getElementById('language-toggle');
      if (theme === 'dark') { document.body.classList.add('dark-theme'); themeToggle.textContent = 'â˜€ï¸ ××¦×‘ ×‘×”×™×¨'; }
      else { document.body.classList.remove('dark-theme'); themeToggle.textContent = 'ğŸŒ™ ××¦×‘ ×›×”×”'; }

      const currentLanguage = localStorage.getItem('language') || 'he';
      if (currentLanguage === 'en') {
        languageToggle.textContent = 'ğŸŒ ×¢×‘×¨×™×ª';
        document.documentElement.lang = 'en';
        document.documentElement.dir = 'rtl'; /* â† × ×©××¨ RTL ×’× ×‘×× ×’×œ×™×ª */
      } else {
        languageToggle.textContent = 'ğŸŒ English';
        document.documentElement.lang = 'he';
        document.documentElement.dir = 'rtl';
      }
      updateInterfaceLanguage(currentLanguage);
    }

    function updateInterfaceLanguage(lang) {
      const t = {
        he:{'nav-store':'×—× ×•×ª','nav-cart':'×¡×œ ×§× ×™×•×ª','nav-checkout':'×ª×©×œ×•×','nav-myitems':'×”×¨×›×™×©×•×ª ×©×œ×™','nav-login':'×”×ª×—×‘×¨×•×ª','nav-logout':'×”×ª× ×ª×§×•×ª','nav-admin':'× ×™×”×•×œ','page-title':'×‘×—×™×¨×ª ×¤×¨×™×˜×™× ×œ×ª×©×œ×•×','continue-pay':'×”××©×š ×œ×ª×©×œ×•×','total':'×¡×”"×› ××—×™×¨: ','theme-dark':'ğŸŒ™ ××¦×‘ ×›×”×”','theme-light':'â˜€ï¸ ××¦×‘ ×‘×”×™×¨'},
        en:{'nav-store':'Store','nav-cart':'Shopping Cart','nav-checkout':'Checkout','nav-myitems':'My Purchases','nav-login':'Login','nav-logout':'Logout','nav-admin':'Admin','page-title':'Select Items for Payment','continue-pay':'Continue to Payment','total':'Total: ','theme-dark':'ğŸŒ™ Dark Mode','theme-light':'â˜€ï¸ Light Mode'}
      }[lang];
      if(!t) return;

      const navStore = document.getElementById('nav-store');
      const navCheckout = document.getElementById('nav-checkout');
      const navMyitems = document.getElementById('nav-myitems');
      const loginLink = document.getElementById('header-login');
      const logoutBtn = document.getElementById('logout');
      const navAdmin = document.getElementById('nav-admin');
      const pageTitle = document.getElementById('page-title');
      const goPayBtn = document.getElementById('go-pay');
      const themeToggle = document.getElementById('theme-toggle');

      if(navStore) navStore.textContent = t['nav-store'];
      if(navCheckout) navCheckout.textContent = t['nav-checkout'];
      if(navMyitems) navMyitems.textContent = t['nav-myitems'];
      if(loginLink) loginLink.textContent = t['nav-login'];
      if(logoutBtn) logoutBtn.textContent = t['nav-logout'];
      if(navAdmin) navAdmin.textContent = t['nav-admin'];
      if(pageTitle) pageTitle.textContent = t['page-title'];
      if(goPayBtn) goPayBtn.textContent = t['continue-pay'];
      if(themeToggle) themeToggle.textContent = (localStorage.getItem('theme')||'light')==='dark' ? t['theme-light'] : t['theme-dark'];
    }

    document.getElementById('theme-toggle').addEventListener('click', () => {
      const isDark = document.body.classList.contains('dark-theme');
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
      loadUICustomization();
    });

    document.getElementById('language-toggle').addEventListener('click', () => {
      if (window.Translations && window.Translations.toggleLanguage) {
        window.Translations.toggleLanguage();
        loadUICustomization();
        render();
      } else {
        const currentLang = localStorage.getItem('language') || 'he';
        const newLang = currentLang === 'he' ? 'en' : 'he';
        localStorage.setItem('language', newLang);
        loadUICustomization();
        render();
      }
    });

    // ===== helpers =====
    const nis = n => `â‚ª${n}`;
    const slug = s => String(s||'').trim().toLowerCase().replace(/[^\p{L}\p{N} ]/gu,'').replace(/\s+/g,'-');

    // ×¤×•× ×§×¦×™×” ×œ×§×‘×œ×ª ××—×™×¨ ××•×¦×¨ - ×ª××™×›×” ×‘××—×™×¨×™× ××”×©×¨×ª
    const priceOf = (p) => {
      // ×× ×™×© ××—×™×¨ ××”×©×¨×ª - ×”×©×ª××© ×‘×•
      if (p.price !== undefined && p.price !== null && !isNaN(Number(p.price))) {
        return Number(p.price);
      }
      
      // ××—×¨×ª - fallback ×œ××™×¤×•×™ ×™×©×Ÿ
      const PRICE_MAP = {
        'chocolate-cake':150, 'cookies box':120, 'cupcakes':160, 'minnie-mous-cake':300,
        'nutella-box':70, 'chocolate-pizza-xl':120, 'bento-design-cake':140,
        'chocolate-design-cake':180, 'orange-cake':70, 'white-design-cake':140,
        'pizza-cookie':120, 'pizza cookie':120
      };
      
      const keys = [p.id, slug(p.id), p.title, slug(p.title)];
      const hit = keys.find(k => k && PRICE_MAP[k] != null);
      return hit ? PRICE_MAP[hit] : (/(cookie)/i.test(String(p.id)+p.title) ? 17 : 50);
    };

    const NAMES = {
      he:{'chocolate-cake':'×¢×•×’×ª ×©×•×§×•×œ×“ ××¢×•×¦×‘×ª','8-cookies-box':'×××¨×– 8 ×¢×•×’×™×•×ª','cupcakes':'×§××¤×§×™×™×§×¡','minnie-mous-cake':'×¢×•×’×ª ××™× ×™ ×××•×¡','nutella-box':'×××¨×– ××‘×•×œ×‘×œ×•×ª × ×•×˜×œ×”','chocolate-pizza-xl':'×¤×™×¦×ª ×©×•×§×•×œ×“ ×’×“×•×œ×”','bento-design-cake':'×¢×•×’×ª ×‘× ×˜×• ××¢×•×¦×‘×ª','chocolate-design-cake':'×¢×•×’×ª ×©×•×§×•×œ×“ ××¢×•×¦×‘×ª','orange-cake':'×¢×•×’×ª ×ª×¤×•×–×™×','bagle-cookie':'×¢×•×’×™×™×ª ×‘×™×’×œ','caramel-cookie':'×¢×•×’×™×™×ª ×§×¨××œ','kinder-cookie':'×¢×•×’×™×™×ª ×§×™× ×“×¨','lotus-cookie':'×¢×•×’×™×™×ª ×œ×•×˜×•×¡','nutella-cookie':'×¢×•×’×™×™×ª × ×•×˜×œ×”','white-chocolate-cookie':'×¢×•×’×™×™×ª ×©×•×§×•×œ×“ ×œ×‘×Ÿ','white-design-cake':'×¢×•×’×ª ×‘× ×˜×• ××¢×•×¦×‘×ª','pizza-cookie':'×¤×™×¦×ª ×©×•×§×•×œ×“ ×’×“×•×œ×”','pizza cookie':'×¤×™×¦×ª ×©×•×§×•×œ×“ ×’×“×•×œ×”'},
      en:{'chocolate-cake':'Chocolate Design Cake','8-cookies-box':'8 Cookies Box','cupcakes':'Cupcakes','minnie-mous-cake':'Minnie Mouse Cake','nutella-box':'Nutella Box','chocolate-pizza-xl':'Chocolate Pizza XL','bento-design-cake':'Bento Design Cake','chocolate-design-cake':'Chocolate Design Cake','orange-cake':'Orange Cake','bagle-cookie':'Bagel Cookie','caramel-cookie':'Caramel Cookie','kinder-cookie':'Kinder Cookie','lotus-cookie':'Lotus Cookie','nutella-cookie':'Nutella Cookie','white-chocolate-cookie':'White Chocolate Cookie','white-design-cake':'Bento Design Cake','pizza-cookie':'Chocolate Pizza XL','pizza cookie':'Chocolate Pizza XL'}
    };

    const nameOf = (p,lang) => {
      const id = String(p.id??''); const title = String(p.title??'');
      const dict = NAMES[lang]||{}; const k = [id,slug(id),title,slug(title)].find(x=>dict[x]);
      return k ? dict[k] : (title||id);
    };

    // ××¦×‘ ×”×ª×—×‘×¨×•×ª
    (async () => {
      try {
        const r=await fetch('/api/session');
        if(r.ok){
          const data = await r.json();
          document.getElementById('header-login').style.display='none';
          document.getElementById('logout').style.display='';
          if (data.username === 'admin') document.getElementById('nav-admin').style.display = '';
        }
      } catch{}
    })();
    document.getElementById('logout').onclick = async () => { try{await fetch('/api/logout',{method:'POST'})} finally{location.href='login.html'} };

    let PRODUCTS=[];
    async function loadProducts(){ try{ const r=await fetch('/api/products'); PRODUCTS=r.ok?await r.json():[]; }catch{} }

    function getColorName(color) {
      const currentLang = localStorage.getItem('language') || 'he';
      if (window.Translations && window.Translations.get) {
        const colorKey = `cakeDesigner.colors.${color.replace('-', '')}`;
        const translated = window.Translations.get(colorKey);
        if (translated && translated !== colorKey) return translated;
      }
      const colorNames = { he:{'pink':'×•×¨×•×“','white':'×œ×‘×Ÿ','green':'×™×¨×•×§','red':'××“×•×','purple':'×¡×’×•×œ','light-blue':'×›×—×•×œ ×‘×”×™×¨','orange':'×›×ª×•×'}, en:{'pink':'Pink','white':'White','green':'Green','red':'Red','purple':'Purple','light-blue':'Light Blue','orange':'Orange'} };
      return colorNames[currentLang]?.[color] || color;
    }
    function getCustomCakeKey(design){ return `${design.size}-${design.color}-${design.text || ''}-${design.textColor}`; }

    function renderCustomCakeForCheckout(customCake, quantity = 1) {
      const design = customCake.design;
      const currentLang = localStorage.getItem('language') || 'he';
      const sizeText = currentLang==='en' ? (design.size==='bento'?'Bento (10cm)':'Large (22cm)') : (design.size==='bento'?'×‘× ×˜×• (10 ×¡"×)':'×’×“×•×œ×” (22 ×¡"×)');
      const colorName = getColorName(design.color);
      const total = design.price * quantity;
      const customBadge = currentLang==='en' ? 'ğŸ¨ Custom' : 'ğŸ¨ ××•×ª×××ª';
      const cakeText = currentLang==='en' ? 'Cake' : '×¢×•×’×”';
      const colorText = currentLang==='en' ? 'Color:' : '×¦×‘×¢:'; const textText = currentLang==='en' ? 'Text:' : '×›×™×ª×•×‘:'; const noTextText = currentLang==='en' ? 'No text' : '×œ×œ× ×›×™×ª×•×‘';
      const row = document.createElement('label');
      row.className = 'ck-row';
      row.innerHTML = `
        <input type="checkbox" data-custom-ids="${customCake.ids ? customCake.ids.join(',') : customCake.id}" checked>
        <img src="/images/cakes/${design.imageFile || `cake-${design.color}.png`}" alt="×¢×•×’×” ××•×ª×××ª">
        <div>
          <div style="font-weight:700"><span class="custom-cake-badge">${customBadge}</span>${cakeText} ${sizeText}</div>
          <div class="design-details-mini">
            <span class="design-detail-mini"><strong>${colorText}</strong> ${colorName}</span>
            ${design.text ? `<span class="design-detail-mini"><strong>${textText}</strong> <span class="custom-text-preview-mini" style="color: ${design.textColor}">"${design.text}"</span></span>` : `<span class="design-detail-mini">${noTextText}</span>`}
          </div>
          <div class="price-line">${nis(design.price)} Ã— ${quantity} = <strong>${nis(total)}</strong></div>
        </div>`;
      return row;
    }

    function toQtyMap(payload){
      if (payload && typeof payload==='object' && Array.isArray(payload.items)) payload = payload.items;
      const q={}; if (Array.isArray(payload)){ for (const it of payload){ if (typeof it==='string'){ q[it]=(q[it]||0)+1; continue; }
        if (it && typeof it==='object'){ const id = it.id || it.productId; const qty = Number(it.qty ?? it.quantity ?? 1); if (id) q[id]=(q[id]||0)+qty; } } }
      else if (payload && typeof payload==='object'){ for (const [id,val] of Object.entries(payload)){ q[id] = typeof val==='number' ? val : Number(val?.qty ?? val?.quantity ?? 1); } }
      return q;
    }

    async function getCartMap(){
      try{ const res = await fetch('/api/cart-with-custom'); if (res.status===401){ location.href='login.html'; return {}; } if (res.ok){ return await res.json(); } }catch{}
      try{ const r = await fetch('/api/cart'); if (!r.ok) return {}; const quantities = toQtyMap(await r.json()); return { regularItems: quantities, customCakes: [] }; }catch{ return { regularItems: {}, customCakes: [] }; }
    }

    let cartData = {}; let customCakes = []; let groupedCustomCakes = {};

    function computeTotalFromChecked(){
      let total = 0;
      document.querySelectorAll('.ck-row input[type="checkbox"]:not([data-custom-ids])').forEach(cb => {
        if (!cb.checked) return;
        const id = cb.value;
        const qty = Number(cartData.regularItems?.[id] || 0);
        const p = PRODUCTS.find(x => String(x.id) === String(id)) || {id, title:id};
        const unit = priceOf(p);
        total += (unit || 0) * qty;
      });
      document.querySelectorAll('.ck-row input[type="checkbox"][data-custom-ids]').forEach(cb => {
        if (!cb.checked) return;
        const customIds = cb.getAttribute('data-custom-ids').split(',');
        customIds.forEach(customId => {
          const cake = customCakes.find(c => c.id === customId);
          if (cake) total += cake.design.price;
        });
      });
      const currentLang = localStorage.getItem('language') || 'he';
      const totalText = currentLang === 'en' ? 'Total: ' : '×¡×”"×› ××—×™×¨: ';
      document.getElementById('total').textContent = totalText + nis(total);
    }

    async function render(){
      const list = document.getElementById('list');
      list.innerHTML = '';

      cartData = await getCartMap();
      customCakes = cartData.customCakes || [];

      const regularEntries = Object.entries(cartData.regularItems || {});
      const hasRegularItems = regularEntries.length > 0;
      const hasCustomCakes = customCakes.length > 0;

      if (!hasRegularItems && !hasCustomCakes) {
        const currentLang = localStorage.getItem('language') || 'he';
        const emptyText = currentLang === 'en' ? 'Cart is empty' : '×”×¢×’×œ×” ×¨×™×§×”';
        document.getElementById('total').textContent = currentLang === 'en' ? 'Total: â‚ª0' : '×¡×”"×› ××—×™×¨: â‚ª0';
        list.innerHTML = `<p class="empty">${emptyText}</p>`;
        return;
      }

      if (hasRegularItems) {
        for (const [id, qty] of regularEntries) {
          const p = PRODUCTS.find(x => String(x.id) === String(id)) || {id, title:id, image:''};
          const lang = localStorage.getItem('language') || 'he';
          const productName = nameOf(p, lang);
          const unit = priceOf(p);
          const total = unit * Number(qty);

          const row = document.createElement('label');
          row.className = 'ck-row';
          row.innerHTML = `
            <input type="checkbox" value="${id}" checked />
            <img src="/images/${p.image || 'placeholder.png'}" alt="${productName}">
            <div>
              <div style="font-weight:700">${productName}</div>
              <div class="price-line">${nis(unit)} Ã— ${qty} = <strong>${nis(total)}</strong></div>
            </div>`;
          list.appendChild(row);
        }
      }

      if (hasCustomCakes) {
        groupedCustomCakes = {};
        customCakes.forEach(cake => {
          const key = getCustomCakeKey(cake.design);
          if (!groupedCustomCakes[key]) groupedCustomCakes[key] = { cake, quantity: 0, ids: [] };
          groupedCustomCakes[key].quantity++; groupedCustomCakes[key].ids.push(cake.id);
        });
        Object.values(groupedCustomCakes).forEach(group => {
          const cakeElement = renderCustomCakeForCheckout({ ...group.cake, ids: group.ids }, group.quantity);
          list.appendChild(cakeElement);
        });
      }

      computeTotalFromChecked();
      list.addEventListener('change', (e) => { if (e.target.matches('input[type="checkbox"]')) computeTotalFromChecked(); });
    }

    document.getElementById('go-pay').onclick = () => {
      const selectedRegularItems = [];
      const selectedCustomItems = [];
      document.querySelectorAll('.ck-row input[type="checkbox"]:not([data-custom-ids]):checked').forEach(cb => {
        const id = cb.value;
        const qty = Number(cartData.regularItems?.[id] || 0);
        for (let i = 0; i < qty; i++) selectedRegularItems.push(id);
      });
      document.querySelectorAll('.ck-row input[type="checkbox"][data-custom-ids]:checked').forEach(cb => {
        const customIds = cb.getAttribute('data-custom-ids').split(',');
        selectedCustomItems.push(...customIds);
      });

      if (selectedRegularItems.length === 0 && selectedCustomItems.length === 0) {
        const currentLang = localStorage.getItem('language') || 'he';
        alert(currentLang === 'en' ? 'Please select items for payment' : '× × ×œ×‘×—×•×¨ ×¤×¨×™×˜×™× ×œ×ª×©×œ×•×');
        return;
      }

      const selectedData = { regularItems: selectedRegularItems, customItems: selectedCustomItems, timestamp: Date.now() };
      localStorage.setItem('selectedForPayment', JSON.stringify(selectedData));
      location.href = 'pay.html';
    };

    (async() => {
      await loadProducts();
      setTimeout(() => { loadUICustomization(); }, 100);
      await render();
    })();
  </script>
</body>
</html>