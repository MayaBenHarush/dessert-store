<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title data-page="admin">מסך ניהול</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/styles.css">
  <script src="/assets/translations"></script>
  <style>
    .admin-grid{ display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    @media (max-width:900px){ .admin-grid{ grid-template-columns:1fr; } }
    .panel{ border:1px solid #eee; border-radius:10px; padding:14px; background:#fff; }
    .panel h2{ margin-top:0; }
    .admin-list{ display:flex; flex-direction:column; gap:10px; }
    .admin-row{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px; border:1px solid #eee; border-radius:8px; padding:8px; background:#fafafa; }
    .admin-row img{ width:64px; height:64px; object-fit:cover; border-radius:6px; }
    .admin-row button{ border:1px solid #ccc; background:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; }
    .admin-row button:hover{ background:#f2f2f2; }
    .admin-form label{ display:block; margin-bottom:10px; }
    .admin-form input, .admin-form textarea{ width:100%; box-sizing:border-box; padding:8px; border:1px solid #ccc; border-radius:8px; }
    .muted{ color:#666; font-size:12px; }
  </style>
</head>
<body>
  <nav>
    <a href="/screens/cart.html" data-key="cart">סל הקניות</a>
    <a href="/screens/checkout.html" data-key="checkout">תשלום</a>
    <a href="/screens/myitems.html" data-key="myPurchases">הרכישות שלי</a>
    <a id="login-link" href="/screens/login.html" data-key="login">התחברות</a>
    <button id="logout" style="display:none" data-key="logout">התנתקות</button>
    <a href="/screens/admin.html" data-key="admin">ניהול</a>
    <a href="/screens/cake-designer.html">🎨 עיצוב עוגה</a>
    <a href="/screens/dessert-finder.html">🔍 מציאת קינוח מושלם</a>
    <a href="/screens/wheel.html">🎡 גלגל מזל</a>
    <a href="/screens/diy.html">🍪 <span data-key="nav.diy">עשה זאת בעצמך</span></a>
  </nav>

  <h1 data-key="pageTitle.admin">מסך ניהול</h1>

  <div class="admin-grid">
    <section class="panel">
      <h2 data-key="addProduct">הוספת מוצר חדש</h2>
      <form id="add-form" class="admin-form">
        <label><span data-key="productTitle">כותרת המוצר</span> <input type="text" name="title" required></label>
        <label><span data-key="description">תיאור (אופציונלי)</span> <textarea name="description" rows="3"></textarea></label>
        <label><span data-key="image">תמונה</span> (שם קובץ מתוך /public/images או URL מלא)
          <input type="text" name="image" placeholder="cookie.jpg או https://…" required>
        </label>
        <button type="submit" data-key="addProduct">הוסף מוצר</button>
        <div class="muted">טיפ: אם מעלים קובץ ל־<code>public/images</code>, מספיק לכתוב את שמו (למשל <code>cookie.jpg</code>).</div>
      </form>
    </section>

    <section class="panel">
      <h2>מוצרים קיימים</h2>
      <div id="products" class="admin-list"></div>
    </section>

    <section class="panel">
      <h2>פעילות אחרונה</h2>
      <div class="muted">מוצג חדש→ישן.</div>
      <div id="activity" class="admin-list"></div>
    </section>
  </div>

  <script>
    // טעינת התאמות אישיות מ-localStorage
    function loadUICustomization() {
      const theme = localStorage.getItem('theme') || 'light';
      const themeToggle = document.getElementById('theme-toggle');
      const languageToggle = document.getElementById('language-toggle');
      
      // עדכון נושא
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
        themeToggle.textContent = '☀️ מצב בהיר';
      } else {
        document.body.classList.remove('dark-theme');
        themeToggle.textContent = '🌙 מצב כהה';
      }
      
      // עדכון כפתור שפה
      const currentLanguage = localStorage.getItem('language') || 'he';
      if (currentLanguage === 'en') {
        languageToggle.textContent = '🌐 עברית';
      } else {
        languageToggle.textContent = '🌐 English';
      }
      
      // עדכון תרגומים אם הפונקציה קיימת
      if (typeof window.updateLanguage === 'function') {
        window.updateLanguage();
      }
    }

    // החלפת נושא
    document.getElementById('theme-toggle').addEventListener('click', () => {
      const isDark = document.body.classList.contains('dark-theme');
      const newTheme = isDark ? 'light' : 'dark';
      localStorage.setItem('theme', newTheme);
      loadUICustomization();
    });

    // החלפת שפה
    document.getElementById('language-toggle').addEventListener('click', () => {
      if (typeof window.toggleLanguage === 'function') {
        window.toggleLanguage();
        loadProducts(); // טעינה מחדש עם השפה החדשה
        loadActivity(); // טעינה מחדש של הפעילות
      }
    });

    async function setupAuthButtons() {
      const loginLink = document.getElementById('login-link');
      const logoutBtn = document.getElementById('logout');
      let loggedIn = false;
      try { const r = await fetch('/api/session'); loggedIn = r.ok; } catch {}
      loginLink.style.display = loggedIn ? 'none' : '';
      logoutBtn.style.display = loggedIn ? '' : 'none';
    }
    setupAuthButtons();
    document.getElementById('logout').onclick = async () => {
      try { await fetch('/api/logout', { method: 'POST' }); }
      finally { location.href = '/screens/login.html'; }
    };

    const productsBox = document.getElementById('products');
    async function loadProducts(){
      productsBox.innerHTML = 'טוען...';
      const res = await fetch('/api/admin/products');
      if (res.status === 401) return location.href = '/screens/login.html';
      if (res.status === 403) { productsBox.textContent = 'Admin only'; return; }
      const items = await res.json();
      const currentLanguage = localStorage.getItem('language') || 'he';
      
      productsBox.innerHTML = '';
      for (const p of items){
        const row = document.createElement('div');
        row.className = 'admin-row';
        
        // תרגום שם המוצר אם קיים
        const productName = (window.Translations && window.Translations.getProduct) 
          ? window.Translations.getProduct(p.id, currentLanguage) || p.title 
          : p.title;
        
        row.innerHTML = `
          <img src="${p.image.startsWith('http') ? p.image : '/images/' + p.image}" alt="${productName}">
          <div>
            <div><strong>${productName}</strong></div>
            <div class="muted">${p.id}</div>
          </div>
          <button data-id="${p.id}" data-key="removeProduct">מחק</button>
        `;
        row.querySelector('button').onclick = async () => {
          if (!confirm('למחוק את "'+productName+'"?')) return;
          const del = await fetch('/api/admin/products/' + encodeURIComponent(p.id), { method:'DELETE' });
          if (!del.ok){
            const j = await del.json().catch(() => ({}));
            alert(j.error || 'מחיקה נכשלה');
          }
          await loadProducts(); await loadActivity();
        };
        productsBox.appendChild(row);
      }
      
      // עדכון תרגומים לכפתורים
      if (typeof window.updateLanguage === 'function') {
        window.updateLanguage();
      }
    }

    const addForm = document.getElementById('add-form');
    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(addForm);
      const payload = {
        title: (fd.get('title') || '').trim(),
        description: (fd.get('description') || '').trim(),
        image: (fd.get('image') || '').trim()
      };
      if (!payload.title || !payload.image) return alert('יש למלא כותרת ותמונה');
      const res = await fetch('/api/admin/products', {
        method:'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload)
      });
      if (res.status === 401) return location.href = '/screens/login.html';
      if (res.status === 403) return alert('Admin only');
      const j = await res.json().catch(() => ({}));
      if (!res.ok || !j.ok) return alert(j.error || 'הוספה נכשלה');
      addForm.reset(); await loadProducts(); await loadActivity(); alert('המוצר נוסף בהצלחה!');
    });

    const actBox = document.getElementById('activity');
    async function loadActivity(){
      actBox.innerHTML = 'טוען...';
      const res = await fetch('/api/admin/activity');
      if (res.status === 403) { actBox.textContent = 'אין הרשאת מנהל'; return; }
      if (!res.ok) { actBox.textContent = 'שגיאה'; return; }
      const rows = await res.json();
      const currentLanguage = localStorage.getItem('language') || 'he';
      
      actBox.innerHTML = '';
      for (const r of rows){
        const div = document.createElement('div'); div.className = 'admin-row';
        const when = r.datetime ? new Date(r.datetime).toLocaleString(currentLanguage === 'he' ? 'he-IL' : 'en-US') : '';
        div.innerHTML = `<div style="grid-column:1 / span 3;"><strong>${r.type}</strong> <span class="muted">— ${when} — ${r.username || ''}</span></div>`;
        actBox.appendChild(div);
      }
    }

    setupAuthButtons();
    // טעינה ראשונית - עם השהיה קטנה כדי לוודא שtranslations.js נטען
    setTimeout(() => {
      loadUICustomization();
      loadProducts(); 
      loadActivity();
    }, 100);
  </script>
</body>
</html>
