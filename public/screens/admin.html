<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title data-page="admin">××¡×š × ×™×”×•×œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/styles.css">
  <script src="/assets/translations"></script>
  <style>
    .admin-grid{ display:grid; grid-template-columns:1fr 1fr; gap:20px; }
    @media (max-width:900px){ .admin-grid{ grid-template-columns:1fr; } }
    .panel{ border:1px solid #eee; border-radius:10px; padding:14px; background:#fff; }
    .panel h2{ margin-top:0; }
    .admin-list{ display:flex; flex-direction:column; gap:10px; }
    .admin-row{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px; border:1px solid #eee; border-radius:8px; padding:8px; background:#fafafa; }
    .admin-row img{ width:64px; height:64px; object-fit:cover; border-radius:6px; }
    .admin-row button{ border:1px solid #ccc; background:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; }
    .admin-row button:hover{ background:#f2f2f2; }
    .admin-form label{ display:block; margin-bottom:10px; }
    .admin-form input, .admin-form textarea{ width:100%; box-sizing:border-box; padding:8px; border:1px solid #ccc; border-radius:8px; }
    .muted{ color:#666; font-size:12px; }
  </style>
</head>
<body>
  <nav>
    <a href="store.html" data-key="store">×—× ×•×ª</a>
    <a href="cart.html" data-key="cart">×¡×œ ×”×§× ×™×•×ª</a>
    <a href="checkout.html" data-key="checkout">×ª×©×œ×•×</a>
    <a href="myitems.html" data-key="myPurchases">×”×¨×›×™×©×•×ª ×©×œ×™</a>
    <a id="login-link" href="login.html" data-key="login">×”×ª×—×‘×¨×•×ª</a>
    <button id="logout" style="display:none" data-key="logout">×”×ª× ×ª×§×•×ª</button>
    <a href="admin.html" data-key="admin">× ×™×”×•×œ</a>
    <a href="cake-designer.html">ğŸ¨ ×¢×™×¦×•×‘ ×¢×•×’×”</a>
    <a href="dessert-finder.html">ğŸ” ××¦×™××ª ×§×™× ×•×— ××•×©×œ×</a>
    <a href="wheel.html">ğŸ¡ ×’×œ×’×œ ××–×œ</a>
    <button id="theme-toggle">ğŸŒ™ ××¦×‘ ×›×”×”</button>
    <button id="language-toggle">ğŸŒ English</button>
  </nav>

  <h1 data-key="pageTitle.admin">××¡×š × ×™×”×•×œ</h1>

  <div class="admin-grid">
    <section class="panel">
      <h2 data-key="addProduct">×”×•×¡×¤×ª ××•×¦×¨ ×—×“×©</h2>
      <form id="add-form" class="admin-form">
        <label><span data-key="productTitle">×›×•×ª×¨×ª ×”××•×¦×¨</span> <input type="text" name="title" required></label>
        <label><span data-key="description">×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)</span> <textarea name="description" rows="3"></textarea></label>
        <label><span data-key="image">×ª××•× ×”</span> (×©× ×§×•×‘×¥ ××ª×•×š /public/images ××• URL ××œ×)
          <input type="text" name="image" placeholder="cookie.jpg ××• https://â€¦" required>
        </label>
        <button type="submit" data-key="addProduct">×”×•×¡×£ ××•×¦×¨</button>
        <div class="muted">×˜×™×¤: ×× ××¢×œ×™× ×§×•×‘×¥ ×œÖ¾<code>public/images</code>, ××¡×¤×™×§ ×œ×›×ª×•×‘ ××ª ×©××• (×œ××©×œ <code>cookie.jpg</code>).</div>
      </form>
    </section>

    <section class="panel">
      <h2>××•×¦×¨×™× ×§×™×™××™×</h2>
      <div id="products" class="admin-list"></div>
    </section>

    <section class="panel">
      <h2>×¤×¢×™×œ×•×ª ××—×¨×•× ×”</h2>
      <div class="muted">××•×¦×’ ×—×“×©â†’×™×©×Ÿ.</div>
      <div id="activity" class="admin-list"></div>
    </section>
  </div>

  <script>
    // ×˜×¢×™× ×ª ×”×ª×××•×ª ××™×©×™×•×ª ×-localStorage
    function loadUICustomization() {
      const theme = localStorage.getItem('theme') || 'light';
      const themeToggle = document.getElementById('theme-toggle');
      const languageToggle = document.getElementById('language-toggle');
      
      // ×¢×“×›×•×Ÿ × ×•×©×
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
        themeToggle.textContent = 'â˜€ï¸ ××¦×‘ ×‘×”×™×¨';
      } else {
        document.body.classList.remove('dark-theme');
        themeToggle.textContent = 'ğŸŒ™ ××¦×‘ ×›×”×”';
      }
      
      // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨ ×©×¤×”
      const currentLanguage = localStorage.getItem('language') || 'he';
      if (currentLanguage === 'en') {
        languageToggle.textContent = 'ğŸŒ ×¢×‘×¨×™×ª';
      } else {
        languageToggle.textContent = 'ğŸŒ English';
      }
      
      // ×¢×“×›×•×Ÿ ×ª×¨×’×•××™× ×× ×”×¤×•× ×§×¦×™×” ×§×™×™××ª
      if (typeof window.updateLanguage === 'function') {
        window.updateLanguage();
      }
    }

    // ×”×—×œ×¤×ª × ×•×©×
    document.getElementById('theme-toggle').addEventListener('click', () => {
      const isDark = document.body.classList.contains('dark-theme');
      const newTheme = isDark ? 'light' : 'dark';
      localStorage.setItem('theme', newTheme);
      loadUICustomization();
    });

    // ×”×—×œ×¤×ª ×©×¤×”
    document.getElementById('language-toggle').addEventListener('click', () => {
      if (typeof window.toggleLanguage === 'function') {
        window.toggleLanguage();
        loadProducts(); // ×˜×¢×™× ×” ××—×“×© ×¢× ×”×©×¤×” ×”×—×“×©×”
        loadActivity(); // ×˜×¢×™× ×” ××—×“×© ×©×œ ×”×¤×¢×™×œ×•×ª
      }
    });

    async function setupAuthButtons() {
      const loginLink = document.getElementById('login-link');
      const logoutBtn = document.getElementById('logout');
      let loggedIn = false;
      try { const r = await fetch('/api/session'); loggedIn = r.ok; } catch {}
      loginLink.style.display = loggedIn ? 'none' : '';
      logoutBtn.style.display = loggedIn ? '' : 'none';
    }
    setupAuthButtons();
    document.getElementById('logout').onclick = async () => {
      try { await fetch('/api/logout', { method: 'POST' }); }
      finally { location.href = 'login.html'; }
    };

    const productsBox = document.getElementById('products');
    async function loadProducts(){
      productsBox.innerHTML = '×˜×•×¢×Ÿ...';
      const res = await fetch('/api/admin/products');
      if (res.status === 401) return location.href = 'login.html';
      if (res.status === 403) { productsBox.textContent = 'Admin only'; return; }
      const items = await res.json();
      const currentLanguage = localStorage.getItem('language') || 'he';
      
      productsBox.innerHTML = '';
      for (const p of items){
        const row = document.createElement('div');
        row.className = 'admin-row';
        
        // ×ª×¨×’×•× ×©× ×”××•×¦×¨ ×× ×§×™×™×
        const productName = (window.Translations && window.Translations.getProduct) 
          ? window.Translations.getProduct(p.id, currentLanguage) || p.title 
          : p.title;
        
        row.innerHTML = `
          <img src="${p.image.startsWith('http') ? p.image : '/images/' + p.image}" alt="${productName}">
          <div>
            <div><strong>${productName}</strong></div>
            <div class="muted">${p.id}</div>
          </div>
          <button data-id="${p.id}" data-key="removeProduct">××—×§</button>
        `;
        row.querySelector('button').onclick = async () => {
          if (!confirm('×œ××—×•×§ ××ª "'+productName+'"?')) return;
          const del = await fetch('/api/admin/products/' + encodeURIComponent(p.id), { method:'DELETE' });
          if (!del.ok){
            const j = await del.json().catch(() => ({}));
            alert(j.error || '××—×™×§×” × ×›×©×œ×”');
          }
          await loadProducts(); await loadActivity();
        };
        productsBox.appendChild(row);
      }
      
      // ×¢×“×›×•×Ÿ ×ª×¨×’×•××™× ×œ×›×¤×ª×•×¨×™×
      if (typeof window.updateLanguage === 'function') {
        window.updateLanguage();
      }
    }

    const addForm = document.getElementById('add-form');
    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(addForm);
      const payload = {
        title: (fd.get('title') || '').trim(),
        description: (fd.get('description') || '').trim(),
        image: (fd.get('image') || '').trim()
      };
      if (!payload.title || !payload.image) return alert('×™×© ×œ××œ× ×›×•×ª×¨×ª ×•×ª××•× ×”');
      const res = await fetch('/api/admin/products', {
        method:'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify(payload)
      });
      if (res.status === 401) return location.href = 'login.html';
      if (res.status === 403) return alert('Admin only');
      const j = await res.json().catch(() => ({}));
      if (!res.ok || !j.ok) return alert(j.error || '×”×•×¡×¤×” × ×›×©×œ×”');
      addForm.reset(); await loadProducts(); await loadActivity(); alert('×”××•×¦×¨ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
    });

    const actBox = document.getElementById('activity');
    async function loadActivity(){
      actBox.innerHTML = '×˜×•×¢×Ÿ...';
      const res = await fetch('/api/admin/activity');
      if (res.status === 403) { actBox.textContent = '××™×Ÿ ×”×¨×©××ª ×× ×”×œ'; return; }
      if (!res.ok) { actBox.textContent = '×©×’×™××”'; return; }
      const rows = await res.json();
      const currentLanguage = localStorage.getItem('language') || 'he';
      
      actBox.innerHTML = '';
      for (const r of rows){
        const div = document.createElement('div'); div.className = 'admin-row';
        const when = r.datetime ? new Date(r.datetime).toLocaleString(currentLanguage === 'he' ? 'he-IL' : 'en-US') : '';
        div.innerHTML = `<div style="grid-column:1 / span 3;"><strong>${r.type}</strong> <span class="muted">â€” ${when} â€” ${r.username || ''}</span></div>`;
        actBox.appendChild(div);
      }
    }

    setupAuthButtons();
    // ×˜×¢×™× ×” ×¨××©×•× ×™×ª - ×¢× ×”×©×”×™×” ×§×˜× ×” ×›×“×™ ×œ×•×•×“× ×©translations.js × ×˜×¢×Ÿ
    setTimeout(() => {
      loadUICustomization();
      loadProducts(); 
      loadActivity();
    }, 100);
  </script>
</body>
</html>