<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×’×œ×’×œ ××–×œ ××ª×•×§</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/styles.css">
  <style>
    .wheel-wrap{display:flex;flex-direction:column;align-items:center;gap:16px}
    .wheel-card{background:var(--bg-card);border-radius:20px;box-shadow:var(--shadow-lg);padding:24px;max-width:560px;width:100%;text-align:center}
    .wheel{width:320px;height:320px;border-radius:50%;border:10px solid #fff;box-shadow:var(--shadow-md);position:relative;transition:transform 5s cubic-bezier(.2,.7,.1,1)}
    /* ×—×¥ ×›×œ×¤×™ ××˜×” */
    .needle{width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-top:18px solid var(--primary-dark);margin-bottom:4px}
    .segments{position:absolute;inset:0;border-radius:50%;
      /* 9 ×¤×œ×—×™× â€“ ××¤×•×¨×™× ××¤×•×–×¨×™× ×œ×¡×™×¨×•×’×™×Ÿ (NONE ×‘×›×œ ××™× ×“×§×¡ ×–×•×’×™) */
      background:conic-gradient(
        #bdbdbd 0deg 40deg,      /* NONE idx0 */
        #ff6b9d 40deg 80deg,     /* 10% */
        #bdbdbd 80deg 120deg,    /* NONE idx2 */
        #ffd93d 120deg 160deg,   /* ×§×™× ×•×— */
        #bdbdbd 160deg 200deg,   /* NONE idx4 */
        #4ecdc4 200deg 240deg,   /* ××©×œ×•×— */
        #bdbdbd 240deg 280deg,   /* NONE idx6 */
        #ff9a9e 280deg 320deg,   /* 50 â‚ª */
        #bdbdbd 320deg 360deg    /* NONE idx8 */
      );
    }
    .labels{position:absolute;inset:0;border-radius:50%}
    .labels span{position:absolute;left:50%;top:50%;transform-origin:0 0;font-weight:800;color:#333}
    .labels span small{display:block;font-weight:600;font-size:12px;color:#444;opacity:.8}
    .spin-btn{margin-top:8px}
    .note{color:var(--text-muted);font-size:12px}
    .prize{font-size:20px;font-weight:800;margin-top:10px}
    .coupon{font-family:ui-monospace, Menlo, Consolas, monospace;background:#111;color:#fff;display:inline-block;padding:6px 10px;border-radius:8px;margin-top:8px;letter-spacing:1px}
    .disabled{opacity:.6;pointer-events:none}
  </style>
</head>
<body>
  <nav>
    <a href="store.html" id="nav-store" data-key="nav.store">×—× ×•×ª</a>
    <a href="cart.html" id="nav-cart" data-key="nav.cart">×¡×œ ×”×§× ×™×•×ª</a>
    <a href="checkout.html" id="nav-checkout" data-key="nav.checkout">×ª×©×œ×•×</a>
    <a href="myitems.html" id="nav-myitems" data-key="nav.myPurchases">×”×¨×›×™×©×•×ª ×©×œ×™</a>
    <a id="login-link" href="login.html" data-key="nav.login">×”×ª×—×‘×¨×•×ª</a>
    <button id="logout" style="display:none" data-key="nav.logout">×”×ª× ×ª×§×•×ª</button>
    <a href="admin.html" id="nav-admin" data-key="nav.admin" style="display:none">× ×™×”×•×œ</a>

    <!-- ×”×›×¤×ª×•×¨×™× ×¢× ×”××™×™×§×•× ×™× ×•×”Ö¾id ×©×”×§×•×“ ×›×‘×¨ ××©×ª××© ×‘×”× -->
    <a href="cake-designer.html">ğŸ¨ <span id="nav-cake-designer">×¢×™×¦×•×‘ ×¢×•×’×”</span></a>
    <a href="dessert-finder.html" id="nav-dessert-finder">ğŸ” ××¦×™××ª ×§×™× ×•×— ××•×©×œ×</a>
    <a href="wheel.html">ğŸ¡ <span id="nav-wheel-text">×’×œ×’×œ ××–×œ</span></a>

    <!-- ×§×™×©×•×¨ ××ª×›×•× ×™× ×›×¤×™ ×©×”×•×¡×¤×ª -->
    <a href="recipes.html" id="nav-recipes" data-key="nav.recipes">ğŸª ××ª×›×•× ×™×</a>

    <button id="theme-toggle">ğŸŒ™ ××¦×‘ ×›×”×”</button>
    <button id="language-toggle">ğŸŒ English</button>
  </nav>

  <h1 id="main-title">×’×œ×’×œ ××–×œ ××ª×•×§ ğŸ­</h1>

  <div class="wheel-wrap">
    <div class="needle"></div>
    <div class="wheel-card">
      <div style="display:flex;justify-content:center">
        <div id="wheel" class="wheel">
          <div class="segments"></div>
          <div class="labels" id="wheel-labels">
            <!-- ×”×ª×•×•×™×•×ª ×™×•×•×¦×¨×• ×“×™× ××™×ª ×‘-JavaScript -->
          </div>
        </div>
      </div>

      <button id="spin" class="btn spin-btn">×¡×•×‘×‘ ××ª ×”×’×œ×’×œ</button>
      <div class="note" id="note-text">××¤×©×¨×•×ª ××—×ª ×œ×™×•× ×œ×›×œ ××©×ª××©.</div>

      <div id="result" class="prize" aria-live="polite"></div>
      <div id="coupon" class="coupon" style="display:none"></div>
    </div>
  </div>

  <script>
    // ××¢×¨×›×ª ×ª×¨×’×•× ×¢×¦×××™×ª
    const TRANSLATIONS = {
      he: {
        // ×›×•×ª×¨×•×ª ×•×˜×§×¡×˜×™× ×¢×™×§×¨×™×™×
        title: '×’×œ×’×œ ××–×œ ××ª×•×§ ğŸ­',
        spinButton: '×¡×•×‘×‘ ××ª ×”×’×œ×’×œ',
        oncePerDay: '××¤×©×¨×•×ª ××—×ª ×œ×™×•× ×œ×›×œ ××©×ª××©.',
        limitOncePerDay: '××¤×©×¨ ×œ×”×’×¨×™×œ ×¨×§ ×¤×¢× ×‘×™×•×. × ×¡×• ×©×•×‘ ××—×¨',

        // ×ª×¤×¨×™×˜ × ×™×•×•×˜
        navStore: '×—× ×•×ª',
        navCart: '×¡×œ ×”×§× ×™×•×ª',
        navCheckout: '×ª×©×œ×•×',
        navMyitems: '×”×¨×›×™×©×•×ª ×©×œ×™',
        navLogin: '×”×ª×—×‘×¨×•×ª',
        navLogout: '×”×ª× ×ª×§×•×ª',
        navAdmin: '× ×™×”×•×œ',
        navCakeDesigner: '×¢×™×¦×•×‘ ×¢×•×’×”',
        navDessertFinder: 'ğŸ” ××¦×™××ª ×§×™× ×•×— ××•×©×œ×',
        navWheel: '×’×œ×’×œ ××–×œ',

        // ×ª×•×•×™×•×ª ×”×’×œ×’×œ
        noWin: '×œ× ×–×›×™×ª×™',
        discount: '×”× ×—×”',
        dessert: '×§×™× ×•×—',
        delivery: '××©×œ×•×—',
        voucher: '×©×•×‘×¨',

        // ×”×•×“×¢×•×ª ××©×—×§
        spinning: '××’×¨×™×œ...',
        cannotSpin: '×œ× × ×™×ª×Ÿ ×œ×”×’×¨×™×œ ×›×¨×’×¢',
        networkError: '×‘×¢×™×” ×‘×¨×©×ª. × ×¡×”/×™ ×©×•×‘.',
        until: '×¢×“',

        // ×›×¤×ª×•×¨×™ ×××©×§
        themeToggleDark: '××¦×‘ ×›×”×”',
        themeToggleLight: '××¦×‘ ×‘×”×™×¨'
      },
      en: {
        // Titles
        title: 'Sweet Lucky Wheel ğŸ­',
        spinButton: 'Spin the Wheel',
        oncePerDay: 'One chance per day for each user.',
        limitOncePerDay: 'You can spin only once per day. Try again tomorrow.',

        // Nav
        navStore: 'Store',
        navCart: 'Shopping Cart',
        navCheckout: 'Checkout',
        navMyitems: 'My Purchases',
        navLogin: 'Login',
        navLogout: 'Logout',
        navAdmin: 'Admin',
        navCakeDesigner: 'Cake Designer',
        navDessertFinder: 'ğŸ” Find Perfect Dessert',
        navWheel: 'Lucky Wheel',

        // Wheel labels
        noWin: "Didn't Win",
        discount: 'Discount',
        dessert: 'Dessert',
        delivery: 'Delivery',
        voucher: 'Voucher',

        // Game messages
        spinning: 'Spinning...',
        cannotSpin: 'Cannot spin right now',
        networkError: 'Network error. Please try again.',
        until: 'until',

        // UI
        themeToggleDark: 'Dark Mode',
        themeToggleLight: 'Light Mode'
      }
    };

    // ×¤×•× ×§×¦×™×” ×œ×§×‘×œ×ª ×˜×§×¡×˜ ×‘×©×¤×” ×”× ×•×›×—×™×ª
    function getText(key) {
      const currentLang = localStorage.getItem('language') || 'he';
      return TRANSLATIONS[currentLang][key] || TRANSLATIONS.he[key] || key;
    }

    // âœ… × ×¨××•×œ ×”×•×“×¢×•×ª ×©××’×™×¢×•×ª ××”×©×¨×ª (×œ××©×œ ×‘×¢×‘×¨×™×ª ×›×©×©×¤×ª ×”×××©×§ EN)
    function normalizeServerMessage(msg){
      const lang = localStorage.getItem('language') || 'he';
      if (!msg) return '';
      const hasHebrew = /[\u0590-\u05FF]/.test(msg);
      if (lang === 'en' && hasHebrew) {
        // ×ª×¨×’×•× ×›×œ×œ×™ ×œ××’×‘×œ×ª ×¤×¢× ×‘×™×•×
        return getText('limitOncePerDay');
      }
      return msg;
    }

    // ×¢×“×›×•×Ÿ ×ª×•×•×™×•×ª ×”×’×œ×’×œ
    function updateWheelLabels() {
      const wheelLabels = [
        { rotation: -90, distance: 90, symbol: 'â€”',   text: getText('noWin')     },
        { rotation: -50, distance: 95, symbol: '10%', text: getText('discount')  },
        { rotation: -10, distance: 90, symbol: 'â€”',   text: getText('noWin')     },
        { rotation:  30, distance: 85, symbol: 'ğŸ',  text: getText('dessert')   },
        { rotation:  70, distance: 85, symbol: 'â€”',   text: getText('noWin')     },
        { rotation: 110, distance: 85, symbol: 'ğŸšš',  text: getText('delivery')  },
        { rotation: 150, distance: 85, symbol: 'â€”',   text: getText('noWin')     },
        { rotation: 190, distance: 85, symbol: 'â‚ª50', text: getText('voucher')   },
        { rotation: 230, distance: 85, symbol: 'â€”',   text: getText('noWin')     }
      ];

      const labelsContainer = document.getElementById('wheel-labels');
      labelsContainer.innerHTML = '';

      wheelLabels.forEach((label, index) => {
        const span = document.createElement('span');
        span.id = `label-${index + 1}`;
        span.style.position = 'absolute';
        span.style.left = '50%';
        span.style.top = '50%';
        span.style.transformOrigin = '0 0';
        span.style.transform = `rotate(${label.rotation}deg) translate(${label.distance}px,-6px)`;
        span.style.fontWeight = '800';
        span.style.color = '#333';

        const small = document.createElement('small');
        small.style.display = 'block';
        small.style.fontWeight = '600';
        small.style.fontSize = '12px';
        small.style.color = '#444';
        small.style.opacity = '0.8';
        small.textContent = label.text;

        span.textContent = label.symbol;
        span.appendChild(small);
        labelsContainer.appendChild(span);
      });
    }

    // ×¢×“×›×•×Ÿ ×›×œ ×”×˜×§×¡×˜×™× ×‘×“×£
    function updateAllTexts() {
      document.getElementById('main-title').textContent = getText('title');
      document.getElementById('spin').textContent = getText('spinButton');
      document.getElementById('note-text').textContent = getText('oncePerDay');

      // ×ª×¤×¨×™×˜
      document.getElementById('nav-store').textContent = getText('navStore');
      document.getElementById('nav-cart').textContent = getText('navCart');
      document.getElementById('nav-checkout').textContent = getText('navCheckout');
      document.getElementById('nav-myitems').textContent = getText('navMyitems');
      document.getElementById('login-link').textContent = getText('navLogin');
      document.getElementById('logout').textContent = getText('navLogout');
      document.getElementById('nav-admin').textContent = getText('navAdmin');

      const ncd = document.getElementById('nav-cake-designer');
      if (ncd) ncd.textContent = getText('navCakeDesigner');
      const ndf = document.getElementById('nav-dessert-finder');
      if (ndf) ndf.textContent = getText('navDessertFinder');
      const nwt = document.getElementById('nav-wheel-text');
      if (nwt) nwt.textContent = getText('navWheel');

      updateWheelLabels();
    }

    // ×˜×¢×™× ×ª ×”×ª×××•×ª ××™×©×™×•×ª
    function loadUICustomization() {
      const currentLang = localStorage.getItem('language') || 'he';
      const theme = localStorage.getItem('theme') || 'light';

      if (currentLang === 'en') {
        document.documentElement.dir = 'ltr';
        document.documentElement.lang = 'en';
        document.getElementById('language-toggle').textContent = 'ğŸŒ ×¢×‘×¨×™×ª';
      } else {
        document.documentElement.dir = 'rtl';
        document.documentElement.lang = 'he';
        document.getElementById('language-toggle').textContent = 'ğŸŒ English';
      }

      const themeToggle = document.getElementById('theme-toggle');
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
        themeToggle.textContent = 'â˜€ï¸ ' + getText('themeToggleLight');
      } else {
        document.body.classList.remove('dark-theme');
        themeToggle.textContent = 'ğŸŒ™ ' + getText('themeToggleDark');
      }

      updateAllTexts();
    }

    // ×”×—×œ×¤×ª × ×•×©×
    document.getElementById('theme-toggle').addEventListener('click', () => {
      const isDark = document.body.classList.contains('dark-theme');
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
      loadUICustomization();
    });

    // ×”×—×œ×¤×ª ×©×¤×”
    document.getElementById('language-toggle').addEventListener('click', () => {
      const currentLang = localStorage.getItem('language') || 'he';
      const nextLang = currentLang === 'he' ? 'en' : 'he';
      localStorage.setItem('language', nextLang);

      loadUICustomization();

      // × ×§×” ×ª×•×¦××•×ª ×§×•×“××•×ª
      const resultBox = document.getElementById('result');
      const couponBox = document.getElementById('coupon');
      resultBox.textContent = '';
      couponBox.style.display = 'none';
    });

    // ×”×’×“×¨×ª ××™××•×ª
    (async function(){
      try{
        const r = await fetch('/api/session');
        if(r.ok){
          document.getElementById('login-link').style.display = 'none';
          document.getElementById('logout').style.display = '';

          const data = await r.json();
          if (data.username === 'admin') {
            document.getElementById('nav-admin').style.display = '';
          }
        }
      }catch{}
    })();

    document.getElementById('logout').onclick = async () => {
      try { await fetch('/api/logout', {method:'POST'}); }
      finally { location.href = 'login.html'; }
    };

    // ××œ×× ×˜×™× ×©×œ ×”××©×—×§
    const wheel  = document.getElementById('wheel');
    const spinBtn = document.getElementById('spin');
    const resultBox = document.getElementById('result');
    const couponBox = document.getElementById('coupon');

    // ×× ×™××¦×™×™×ª ×¡×™×‘×•×‘ ×”×’×œ×’×œ
    function spinVisual(targetAngle){
      wheel.style.transition = 'none';
      const current = wheel._angle || 0;
      wheel.style.transform = `rotate(${current}deg)`;
      requestAnimationFrame(() => {
        const spins = 360*5 + targetAngle;
        wheel.style.transition = 'transform 5s cubic-bezier(.2,.7,.1,1)';
        wheel._angle = current + spins;
        wheel.style.transform = `rotate(${wheel._angle}deg)`;
      });
    }

    // ×¤×•× ×§×¦×™×™×ª ×”×¡×™×‘×•×‘
    async function spin(){
      spinBtn.classList.add('disabled');
      resultBox.textContent = getText('spinning');
      couponBox.style.display = 'none';

      try{
        const r = await fetch('/api/wheel/spin', { method:'POST' });
        const body = await r.json();

        if(!r.ok){
          const safeMsg = normalizeServerMessage(body?.message) || getText('cannotSpin');
          resultBox.textContent = safeMsg;
          spinBtn.classList.remove('disabled');
          return;
        }

        const { angle, message, coupon } = body;
        spinVisual(angle);

        setTimeout(() => {
          const safeMsg = normalizeServerMessage(message);
          resultBox.textContent = safeMsg || '';
          if (coupon?.code){
            const currentLang = localStorage.getItem('language') || 'he';
            const expiryText = coupon.expiresAt
              ? ` â€¢ ${getText('until')} ${new Date(coupon.expiresAt).toLocaleDateString(currentLang === 'he' ? 'he-IL' : 'en-US')}`
              : '';
            couponBox.textContent = coupon.code + expiryText;
            couponBox.style.display = 'inline-block';
          }
        }, 5200);

      }catch(e){
        resultBox.textContent = getText('networkError');
        spinBtn.classList.remove('disabled');
      }
    }

    // ×”×•×¡×¤×ª event listener ×œ×›×¤×ª×•×¨ ×”×¡×™×‘×•×‘
    spinBtn.addEventListener('click', spin);

    // ×˜×¢×™× ×” ×¨××©×•× ×™×ª
    document.addEventListener('DOMContentLoaded', () => {
      if (!localStorage.getItem('language')) {
        localStorage.setItem('language', 'he');
      }
      loadUICustomization();
    });
  </script>
</body>
</html>
