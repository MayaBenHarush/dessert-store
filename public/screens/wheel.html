<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title data-page="wheel">◊í◊ú◊í◊ú ◊û◊ñ◊ú ◊û◊™◊ï◊ß</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #ffffff;
      color: #1a1a1a;
      line-height: 1.6;
    }

    /* Header */
    .header {
      background: #ffffcc;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .menu-btn {
      background: none;
      border: none;
      font-size: 1.1rem;
      font-weight: 600;
      color: #1a1a1a;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .menu-btn::before {
      content: "‚ò∞";
      font-size: 1.2rem;
    }

    .logo {
      font-size: 2.2rem;
      font-weight: 900;
      color: #1a1a1a;
      text-decoration: none;
      letter-spacing: -0.02em;
    }

    .header-nav {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .header-btn {
      background: none;
      border: 2px solid #1a1a1a;
      color: #1a1a1a;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .header-btn:hover {
      background: #1a1a1a;
      color: white;
    }

    .header-btn.primary {
      background: #1a1a1a;
      color: white;
    }

    .header-btn.primary:hover {
      background: #333;
    }

    .cart-btn::before {
      content: "üõí";
    }

    .home-btn::before {
      content: "üè†";
    }

    .login-btn::before {
      content: "üë§";
    }

    .store-btn::before {
      content: "üç∞";
    }

    /* Navigation Menu */
    .nav-menu {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100vh;
      background: white;
      box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
      transition: right 0.3s ease;
      padding: 2rem;
      z-index: 2000;
    }

    .nav-menu.active {
      right: 0;
    }

    .nav-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      float: left;
      margin-bottom: 2rem;
    }

    .nav-item,
    .nav-menu a,
    .nav-menu button {
      display: block;
      padding: 0.75rem 0;
      color: #1a1a1a;
      text-decoration: none;
      font-weight: 500;
      border-bottom: 1px solid #f0f0f0;
      transition: color 0.2s ease;
      background: none;
      border: none;
      text-align: right;
      width: 100%;
      cursor: pointer;
    }

    .nav-item:hover,
    .nav-menu a:hover,
    .nav-menu button:hover {
      color: #ffffcc;
    }

    /* Overlay */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1500;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* Main Content */
    .main-content {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
    }

    .page-header {
      text-align: center;
      margin-bottom: 3rem;
    }

    #main-title {
      font-size: 3rem;
      font-weight: 900;
      color: #1a1a1a;
      margin-bottom: 1rem;
      letter-spacing: -0.02em;
      text-transform: uppercase;
    }

    /* Wheel Container */
    .wheel-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .wheel-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
      padding: 2rem;
      max-width: 560px;
      width: 100%;
      text-align: center;
      transition: all 0.3s ease;
    }

    .wheel-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
    }

    .wheel {
      width: 320px;
      height: 320px;
      border-radius: 50%;
      border: 10px solid #fff;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      position: relative;
      transition: transform 5s cubic-bezier(.2,.7,.1,1);
      margin: 0 auto;
    }

    /* Arrow pointing down */
    .needle {
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-top: 18px solid #1a1a1a;
      margin-bottom: 4px;
      margin-left: auto;
      margin-right: auto;
    }

    .segments {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      background: conic-gradient(
        #bdbdbd 0deg 40deg,      /* NONE */
        #ff6b9d 40deg 80deg,     /* 10% */
        #bdbdbd 80deg 120deg,    /* NONE */
        #ffd93d 120deg 160deg,   /* ◊ß◊ô◊†◊ï◊ó */
        #bdbdbd 160deg 200deg,   /* NONE */
        #4ecdc4 200deg 240deg,   /* ◊û◊©◊ú◊ï◊ó */
        #bdbdbd 240deg 280deg,   /* NONE */
        #ff9a9e 280deg 320deg,   /* 50 ‚Ç™ */
        #bdbdbd 320deg 360deg    /* NONE */
      );
    }

    .labels {
      position: absolute;
      inset: 0;
      border-radius: 50%;
    }

    .labels span {
      position: absolute;
      left: 50%;
      top: 50%;
      transform-origin: 0 0;
      font-weight: 800;
      color: #333;
    }

    .labels span small {
      display: block;
      font-weight: 600;
      font-size: 12px;
      color: #444;
      opacity: .8;
    }

    .spin-btn {
      background: #1a1a1a;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 25px;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 1.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .spin-btn:hover {
      background: #333;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .spin-btn:active {
      transform: translateY(0);
    }

    .note {
      color: #666;
      font-size: 14px;
      margin-top: 1rem;
      font-style: italic;
    }

    .prize {
      font-size: 1.3rem;
      font-weight: 700;
      margin-top: 1.5rem;
      color: #1a1a1a;
      min-height: 1.5rem;
    }

    /* Coupon Display - Enhanced */
    .coupon-container {
      margin-top: 1.5rem;
      display: none;
    }

    .coupon {
      background: linear-gradient(135deg, #1a1a1a 0%, #333 100%);
      color: white;
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      text-align: center;
      position: relative;
      overflow: hidden;
      animation: couponAppear 0.6s ease-out;
    }

    .coupon::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ff6b9d, #4ecdc4, #ffd93d, #ff9a9e);
      border-radius: 15px;
      z-index: -1;
      animation: borderGlow 3s ease-in-out infinite;
    }

    @keyframes couponAppear {
      0% {
        opacity: 0;
        transform: scale(0.8) translateY(20px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    @keyframes borderGlow {
      0%, 100% {
        opacity: 0.7;
      }
      50% {
        opacity: 1;
      }
    }

    .coupon-header {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.8rem;
      color: #ffffcc;
    }

    .coupon-code {
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size: 1.8rem;
      font-weight: 900;
      letter-spacing: 2px;
      margin: 1rem 0;
      padding: 0.8rem 1.2rem;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      border: 2px dashed rgba(255, 255, 255, 0.3);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .coupon-description {
      font-size: 0.95rem;
      margin-bottom: 1rem;
      opacity: 0.9;
    }

    .coupon-expiry {
      font-size: 0.8rem;
      opacity: 0.7;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      padding-top: 0.8rem;
      margin-top: 1rem;
    }

    .coupon-action {
      margin-top: 1rem;
    }

    .copy-code-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin: 0 0.5rem;
    }

    .copy-code-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-1px);
    }

    .use-now-btn {
      background: #ffffcc;
      color: #1a1a1a;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
      margin: 0 0.5rem;
    }

    .use-now-btn:hover {
      background: #ffff99;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 255, 204, 0.4);
    }

    .disabled {
      opacity: 0.6;
      pointer-events: none;
      cursor: not-allowed;
    }

    /* Toast */
    #toast {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 9999;
      display: none;
      padding: 10px 14px;
      background: #333;
      color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .2);
      font-size: 14px;
      opacity: 0;
      transform: translateY(-6px);
      transition: opacity .2s, transform .2s;
    }

    #toast.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    /* Dark Theme */
    .dark-theme {
      background: #1a1a1a;
      color: white;
    }

    .dark-theme .header {
      background: #2d2d2d;
    }

    .dark-theme .nav-menu {
      background: #2d2d2d;
    }

    .dark-theme .nav-menu a,
    .dark-theme .nav-menu button {
      color: white;
      border-bottom-color: #444;
    }

    .dark-theme .wheel-card {
      background: #2d2d2d;
    }

    .dark-theme #main-title {
      color: white;
    }

    .dark-theme .prize {
      color: white;
    }

    .dark-theme .coupon {
      background: linear-gradient(135deg, #2d2d2d 0%, #4d4d4d 100%);
    }

    /* Responsive Design */
    @media (max-width: 968px) {
      .header-nav {
        gap: 0.5rem;
      }

      .header-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }

      #main-title {
        font-size: 2.5rem;
      }

      .wheel {
        width: 280px;
        height: 280px;
      }

      .coupon-code {
        font-size: 1.5rem;
        letter-spacing: 1px;
      }
    }

    @media (max-width: 768px) {
      .header {
        padding: 1rem;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .header-left {
        order: 1;
      }

      .logo {
        font-size: 1.8rem;
        order: 2;
      }

      .header-nav {
        order: 3;
        width: 100%;
        justify-content: center;
        gap: 0.5rem;
      }

      .header-btn {
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
      }

      .main-content {
        padding: 1rem;
      }

      #main-title {
        font-size: 2rem;
      }

      .wheel {
        width: 250px;
        height: 250px;
      }

      .wheel-card {
        padding: 1.5rem;
      }

      .coupon {
        padding: 1.2rem;
      }

      .coupon-code {
        font-size: 1.3rem;
      }

      .coupon-action {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .copy-code-btn,
      .use-now-btn {
        margin: 0;
      }
    }

    @media (max-width: 480px) {
      .header-btn {
        padding: 0.3rem 0.5rem;
        font-size: 0.7rem;
      }

      .header-btn::before {
        display: none;
      }

      .wheel {
        width: 220px;
        height: 220px;
      }

      .coupon-code {
        font-size: 1.1rem;
        letter-spacing: 1px;
      }
    }
  </style>
</head>
<body>
  <div class="overlay" id="overlay"></div>
  
  <header class="header">
    <div class="header-left">
      <button class="menu-btn" id="menuBtn">◊™◊§◊®◊ô◊ò</button>
      <a href="/" class="logo">dessert</a>
    </div>
    
    <nav class="header-nav">
      <a href="index.html" class="header-btn home-btn">◊ë◊ô◊™</a>
      <a href="store.html" class="header-btn store-btn">◊ó◊†◊ï◊™</a>
      <a href="cart.html" class="header-btn cart-btn">◊°◊ú ◊ß◊†◊ô◊ï◊™</a>
      <a href="login.html" class="header-btn login-btn" id="header-login">◊î◊™◊ó◊ë◊®◊ï◊™</a>
    </nav>
  </header>

  <nav class="nav-menu" id="navMenu">
    <button class="nav-close" id="navClose">√ó</button>

    <a href="checkout.html" id="nav-checkout" data-key="nav.checkout">◊™◊©◊ú◊ï◊ù</a>
    <a href="myitems.html" id="nav-myitems" data-key="nav.myPurchases">◊î◊®◊õ◊ô◊©◊ï◊™ ◊©◊ú◊ô</a>
    <a href="admin.html" id="nav-admin" data-key="nav.admin" style="display:none">◊†◊ô◊î◊ï◊ú</a>
    <a href="dessert-finder.html" data-key="nav.dessertFinder">◊û◊¶◊ô◊ê◊™ ◊î◊ß◊ô◊†◊ï◊ó ◊î◊û◊ï◊©◊ú◊ù</a>
    <a href="wheel.html" data-key="nav.wheel">◊í◊ú◊í◊ú ◊û◊ñ◊ú</a>
    <a href="cake-designer.html" data-key="nav.cakeDesigner">◊¢◊ô◊¶◊ï◊ë ◊¢◊ï◊í◊î</a>
    <a href="recipes.html" id="nav-recipes" data-key="nav.recipes">◊û◊™◊õ◊ï◊†◊ô◊ù</a>
    <button id="logout" style="display:none" data-key="nav.logout">◊î◊™◊†◊™◊ß◊ï◊™</button>
    <button id="theme-toggle">üåô ◊û◊¶◊ë ◊õ◊î◊î</button>
    <button id="language-toggle">üåê English</button>
  </nav>

  <div id="toast"></div>

  <main class="main-content">
    <div class="page-header">
      <h1 id="main-title">◊í◊ú◊í◊ú ◊û◊ñ◊ú ◊û◊™◊ï◊ß üé≠</h1>
    </div>

    <div class="wheel-wrap">
      <div class="needle"></div>
      <div class="wheel-card">
        <div style="display:flex;justify-content:center">
          <div id="wheel" class="wheel">
            <div class="segments"></div>
            <div class="labels" id="wheel-labels">
              <!-- ◊î◊™◊ï◊ï◊ô◊ï◊™ ◊ô◊ï◊ï◊¶◊®◊ï ◊ì◊ô◊†◊û◊ô◊™ ◊ë-JavaScript -->
            </div>
          </div>
        </div>

        <button id="spin" class="spin-btn">◊°◊ï◊ë◊ë ◊ê◊™ ◊î◊í◊ú◊í◊ú</button>
        <div class="note" id="note-text">◊ê◊§◊©◊®◊ï◊™ ◊ê◊ó◊™ ◊ú◊ô◊ï◊ù ◊ú◊õ◊ú ◊û◊©◊™◊û◊©.</div>

        <div id="result" class="prize" aria-live="polite"></div>
        
        <!-- Coupon Container - Enhanced -->
        <div id="coupon-container" class="coupon-container">
          <div class="coupon">
            <div class="coupon-header" id="coupon-header">üéâ ◊ß◊ï◊ì ◊î◊ß◊ï◊§◊ï◊ü ◊©◊ú◊ö:</div>
            <div class="coupon-code" id="coupon-code">COUPON123</div>
            <div class="coupon-description" id="coupon-description">◊™◊ô◊ê◊ï◊® ◊î◊ß◊ï◊§◊ï◊ü</div>
            <div class="coupon-action">
              <button class="copy-code-btn" id="copy-code-btn">◊î◊¢◊™◊ß ◊ß◊ï◊ì</button>
              <a href="store.html" class="use-now-btn" id="use-now-btn">◊î◊©◊™◊û◊© ◊¢◊õ◊©◊ô◊ï</a>
            </div>
            <div class="coupon-expiry" id="coupon-expiry">◊™◊ï◊ß◊£ ◊¢◊ì: DD/MM/YYYY</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ◊û◊¢◊®◊õ◊™ ◊™◊®◊í◊ï◊ù ◊¢◊¶◊û◊ê◊ô◊™
    const TRANSLATIONS = {
      he: {
        title: '◊í◊ú◊í◊ú ◊û◊ñ◊ú ◊û◊™◊ï◊ß üé≠',
        spinButton: '◊°◊ï◊ë◊ë ◊ê◊™ ◊î◊í◊ú◊í◊ú',
        oncePerDay: '◊ê◊§◊©◊®◊ï◊™ ◊ê◊ó◊™ ◊ú◊ô◊ï◊ù ◊ú◊õ◊ú ◊û◊©◊™◊û◊©.',
        limitOncePerDay: '◊ê◊§◊©◊® ◊ú◊î◊í◊®◊ô◊ú ◊®◊ß ◊§◊¢◊ù ◊ë◊ô◊ï◊ù. ◊†◊°◊ï ◊©◊ï◊ë ◊û◊ó◊®',
        navStore: '◊ó◊†◊ï◊™',
        navCart: '◊°◊ú ◊ß◊†◊ô◊ï◊™',
        navCheckout: '◊™◊©◊ú◊ï◊ù',
        navMyitems: '◊î◊®◊õ◊ô◊©◊ï◊™ ◊©◊ú◊ô',
        navLogin: '◊î◊™◊ó◊ë◊®◊ï◊™',
        navLogout: '◊î◊™◊†◊™◊ß◊ï◊™',
        navAdmin: '◊†◊ô◊î◊ï◊ú',
        navCakeDesigner: '◊¢◊ô◊¶◊ï◊ë ◊¢◊ï◊í◊î',
        navDessertFinder: '◊û◊¶◊ô◊ê◊™ ◊î◊ß◊ô◊†◊ï◊ó ◊î◊û◊ï◊©◊ú◊ù',
        navWheel: '◊í◊ú◊í◊ú ◊û◊ñ◊ú',
        navRecipes: '◊û◊™◊õ◊ï◊†◊ô◊ù',
        noWin: '◊ú◊ê ◊ñ◊õ◊ô◊™',
        discount: '◊î◊†◊ó◊î',
        dessert: '◊ß◊ô◊†◊ï◊ó',
        delivery: '◊û◊©◊ú◊ï◊ó',
        voucher: '◊©◊ï◊ë◊®',
        spinning: '◊û◊í◊®◊ô◊ú...',
        cannotSpin: '◊ú◊ê ◊†◊ô◊™◊ü ◊ú◊î◊í◊®◊ô◊ú ◊õ◊®◊í◊¢',
        networkError: '◊ë◊¢◊ô◊î ◊ë◊®◊©◊™. ◊†◊°◊î/◊ô ◊©◊ï◊ë.',
        until: '◊¢◊ì',
        themeToggleDark: '◊û◊¶◊ë ◊õ◊î◊î',
        themeToggleLight: '◊û◊¶◊ë ◊ë◊î◊ô◊®',
        couponHeader: 'üéâ ◊ß◊ï◊ì ◊î◊ß◊ï◊§◊ï◊ü ◊©◊ú◊ö:',
        copyCode: '◊î◊¢◊™◊ß ◊ß◊ï◊ì',
        useNow: '◊î◊©◊™◊û◊© ◊¢◊õ◊©◊ô◊ï',
        validUntil: '◊™◊ï◊ß◊£ ◊¢◊ì:',
        codeCopied: '◊î◊ß◊ï◊ì ◊î◊ï◊¢◊™◊ß!'
      },
      en: {
        title: 'Sweet Lucky Wheel üé≠',
        spinButton: 'Spin the Wheel',
        oncePerDay: 'One chance per day for each user.',
        limitOncePerDay: 'You can spin only once per day. Try again tomorrow.',
        navStore: 'Store',
        navCart: 'Shopping Cart',
        navCheckout: 'Checkout',
        navMyitems: 'My Purchases',
        navLogin: 'Login',
        navLogout: 'Logout',
        navAdmin: 'Admin',
        navCakeDesigner: 'Cake Designer',
        navDessertFinder: 'Find Perfect Dessert',
        navWheel: 'Lucky Wheel',
        navRecipes: 'Recipes',
        noWin: "Didn't Win",
        discount: 'Discount',
        dessert: 'Dessert',
        delivery: 'Delivery',
        voucher: 'Voucher',
        spinning: 'Spinning...',
        cannotSpin: 'Cannot spin right now',
        networkError: 'Network error. Please try again.',
        until: 'until',
        themeToggleDark: 'Dark Mode',
        themeToggleLight: 'Light Mode',
        couponHeader: 'üéâ Your Coupon Code:',
        copyCode: 'Copy Code',
        useNow: 'Use Now',
        validUntil: 'Valid until:',
        codeCopied: 'Code copied!'
      }
    };

    function getText(key) {
      const currentLang = localStorage.getItem('language') || 'he';
      return TRANSLATIONS[currentLang][key] || TRANSLATIONS.he[key] || key;
    }

    function normalizeServerMessage(msg){
      const lang = localStorage.getItem('language') || 'he';
      if (!msg) return '';
      const hasHebrew = /[\u0590-\u05FF]/.test(msg);
      if (lang === 'en' && hasHebrew) {
        return getText('limitOncePerDay');
      }
      return msg;
    }

    function updateWheelLabels() {
      const wheelLabels = [
        { rotation: -90, distance: 90, symbol: '‚Äî',   text: getText('noWin')     },
        { rotation: -50, distance: 95, symbol: '10%', text: getText('discount')  },
        { rotation: -10, distance: 90, symbol: '‚Äî',   text: getText('noWin')     },
        { rotation:  30, distance: 85, symbol: 'üéÅ',  text: getText('dessert')   },
        { rotation:  70, distance: 85, symbol: '‚Äî',   text: getText('noWin')     },
        { rotation: 110, distance: 85, symbol: 'üöö',  text: getText('delivery')  },
        { rotation: 150, distance: 85, symbol: '‚Äî',   text: getText('noWin')     },
        { rotation: 190, distance: 85, symbol: '‚Ç™50', text: getText('voucher')   },
        { rotation: 230, distance: 85, symbol: '‚Äî',   text: getText('noWin')     }
      ];

      const labelsContainer = document.getElementById('wheel-labels');
      labelsContainer.innerHTML = '';

      wheelLabels.forEach((label, index) => {
        const span = document.createElement('span');
        span.id = `label-${index + 1}`;
        span.style.position = 'absolute';
        span.style.left = '50%';
        span.style.top = '50%';
        span.style.transformOrigin = '0 0';
        span.style.transform = `rotate(${label.rotation}deg) translate(${label.distance}px,-6px)`;
        span.style.fontWeight = '800';
        span.style.color = '#333';

        const small = document.createElement('small');
        small.style.display = 'block';
        small.style.fontWeight = '600';
        small.style.fontSize = '12px';
        small.style.color = '#444';
        small.style.opacity = '0.8';
        small.textContent = label.text;

        span.textContent = label.symbol;
        span.appendChild(small);
        labelsContainer.appendChild(span);
      });
    }

    function updateAllTexts() {
      document.getElementById('main-title').textContent = getText('title');
      document.getElementById('spin').textContent = getText('spinButton');
      document.getElementById('note-text').textContent = getText('oncePerDay');

      // Navigation texts
      const checkoutBtn = document.getElementById('nav-checkout');
      const myitemsBtn = document.getElementById('nav-myitems');
      const loginLink = document.getElementById('header-login');
      const logoutBtn = document.getElementById('logout');
      const adminBtn = document.getElementById('nav-admin');
      const recipesBtn = document.getElementById('nav-recipes');

      if (checkoutBtn) checkoutBtn.textContent = getText('navCheckout');
      if (myitemsBtn) myitemsBtn.textContent = getText('navMyitems');
      if (loginLink) loginLink.textContent = getText('navLogin');
      if (logoutBtn) logoutBtn.textContent = getText('navLogout');
      if (adminBtn) adminBtn.textContent = getText('navAdmin');
      if (recipesBtn) recipesBtn.textContent = getText('navRecipes');

      // Update coupon texts
      document.getElementById('coupon-header').textContent = getText('couponHeader');
      document.getElementById('copy-code-btn').textContent = getText('copyCode');
      document.getElementById('use-now-btn').textContent = getText('useNow');

      updateWheelLabels();
    }

    // Display coupon with enhanced visual
    function displayCoupon(coupon) {
      if (!coupon) return;

      const container = document.getElementById('coupon-container');
      const codeElement = document.getElementById('coupon-code');
      const descElement = document.getElementById('coupon-description');
      const expiryElement = document.getElementById('coupon-expiry');

      // Set coupon code
      codeElement.textContent = coupon.code;
      
      // Set description
      descElement.textContent = coupon.description || '';
      
      // Set expiry date
      if (coupon.expiresAt) {
        const currentLang = localStorage.getItem('language') || 'he';
        const expiryDate = new Date(coupon.expiresAt);
        const formattedDate = expiryDate.toLocaleDateString(currentLang === 'he' ? 'he-IL' : 'en-US');
        expiryElement.textContent = `${getText('validUntil')} ${formattedDate}`;
      }

      // Show the coupon
      container.style.display = 'block';
    }

    // Copy coupon code to clipboard
    function copyCouponCode() {
      const codeElement = document.getElementById('coupon-code');
      const code = codeElement.textContent;
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(code).then(() => {
          showToast(getText('codeCopied'));
        }).catch(() => {
          // Fallback for older browsers
          fallbackCopyText(code);
        });
      } else {
        fallbackCopyText(code);
      }
    }

    function fallbackCopyText(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        document.execCommand('copy');
        showToast(getText('codeCopied'));
      } catch (err) {
        console.error('Failed to copy text: ', err);
      }
      
      document.body.removeChild(textArea);
    }

    // Menu functionality
    const menuBtn = document.getElementById('menuBtn');
    const navMenu = document.getElementById('navMenu');
    const navClose = document.getElementById('navClose');
    const overlay = document.getElementById('overlay');

    function openMenu() {
      navMenu.classList.add('active');
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      navMenu.classList.remove('active');
      overlay.classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    menuBtn.addEventListener('click', openMenu);
    navClose.addEventListener('click', closeMenu);
    overlay.addEventListener('click', closeMenu);

    function loadUICustomization() {
      const currentLang = localStorage.getItem('language') || 'he';
      const theme = localStorage.getItem('theme') || 'light';

      if (currentLang === 'en') {
        document.documentElement.dir = 'ltr';
        document.documentElement.lang = 'en';
        document.getElementById('language-toggle').textContent = 'üåê ◊¢◊ë◊®◊ô◊™';
      } else {
        document.documentElement.dir = 'rtl';
        document.documentElement.lang = 'he';
        document.getElementById('language-toggle').textContent = 'üåê English';
      }

      const themeToggle = document.getElementById('theme-toggle');
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
        themeToggle.textContent = '‚òÄÔ∏è ' + getText('themeToggleLight');
      } else {
        document.body.classList.remove('dark-theme');
        themeToggle.textContent = 'üåô ' + getText('themeToggleDark');
      }

      updateAllTexts();
    }

    document.getElementById('theme-toggle').addEventListener('click', () => {
      const isDark = document.body.classList.contains('dark-theme');
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
      loadUICustomization();
    });

    document.getElementById('language-toggle').addEventListener('click', () => {
      const currentLang = localStorage.getItem('language') || 'he';
      const nextLang = currentLang === 'he' ? 'en' : 'he';
      localStorage.setItem('language', nextLang);

      loadUICustomization();

      const resultBox = document.getElementById('result');
      const couponContainer = document.getElementById('coupon-container');
      resultBox.textContent = '';
      couponContainer.style.display = 'none';
    });

    // Toast
    const toastEl = document.getElementById('toast');
    let toastTimer;
    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => toastEl.classList.remove('show'), 1500);
    }

    // Authentication setup
    (async function(){
      try{
        const r = await fetch('/api/session');
        if(r.ok){
          document.getElementById('header-login').style.display = 'none';
          document.getElementById('logout').style.display = '';

          const data = await r.json();
          if (data.username === 'admin') {
            document.getElementById('nav-admin').style.display = '';
          }
        }
      }catch{}
    })();

    document.getElementById('logout').onclick = async () => {
      try { await fetch('/api/logout', {method:'POST'}); }
      finally { location.href = 'login.html'; }
    };

    // Wheel functionality
    const wheel  = document.getElementById('wheel');
    const spinBtn = document.getElementById('spin');
    const resultBox = document.getElementById('result');
    const couponContainer = document.getElementById('coupon-container');

    function spinVisual(targetAngle){
      wheel.style.transition = 'none';
      const current = wheel._angle || 0;
      wheel.style.transform = `rotate(${current}deg)`;
      requestAnimationFrame(() => {
        const spins = 360*5 + targetAngle;
        wheel.style.transition = 'transform 5s cubic-bezier(.2,.7,.1,1)';
        wheel._angle = current + spins;
        wheel.style.transform = `rotate(${wheel._angle}deg)`;
      });
    }

    async function spin(){
      spinBtn.classList.add('disabled');
      resultBox.textContent = getText('spinning');
      couponContainer.style.display = 'none';

      try{
        const r = await fetch('/api/wheel/spin', { method:'POST' });
        const body = await r.json();

        if(!r.ok){
          const safeMsg = normalizeServerMessage(body?.message) || getText('cannotSpin');
          resultBox.textContent = safeMsg;
          spinBtn.classList.remove('disabled');
          return;
        }

        const { angle, message, coupon } = body;
        spinVisual(angle);

        setTimeout(() => {
          const safeMsg = normalizeServerMessage(message);
          resultBox.textContent = safeMsg || '';
          
          // Display coupon if won
          if (coupon && coupon.code) {
            displayCoupon(coupon);
          }
        }, 5200);

      }catch(e){
        resultBox.textContent = getText('networkError');
        spinBtn.classList.remove('disabled');
      }
    }

    spinBtn.addEventListener('click', spin);

    // Copy coupon code event listener
    document.getElementById('copy-code-btn').addEventListener('click', copyCouponCode);

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      if (!localStorage.getItem('language')) {
        localStorage.setItem('language', 'he');
      }
      loadUICustomization();
    });
  </script>
</body>
</html>