<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title data-page="store">×—× ×•×ª ×§×™× ×•×—×™× ğŸ°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/styles.css" />
  <script src="/assets/translations"></script>
  <style>
    /* ×˜×•×¡×˜ ×§×˜×Ÿ ×‘×¤×™× ×” ×”×™×× ×™×ª-×¢×œ×™×•× ×” */
    #toast {
      position: fixed; top: 12px; right: 12px; z-index: 9999;
      display: none; padding: 10px 14px; background: #333; color: #fff;
      border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,.2);
      font-size: 14px; opacity: 0; transform: translateY(-6px);
      transition: opacity .2s ease, transform .2s ease;
    }
    #toast.show { display:block; opacity:1; transform: translateY(0); }
    .price { font-weight: 800; }
  </style>
</head>
<body>
  <nav>
    <a href="store.html" id="nav-store">×—× ×•×ª</a>
    <a href="cart.html" id="nav-cart">×¡×œ ×”×§× ×™×•×ª</a>
    <a href="checkout.html" id="nav-checkout">×ª×©×œ×•×</a>
    <a href="myitems.html" id="nav-myitems">×”×¨×›×™×©×•×ª ×©×œ×™</a>
    <a id="login-link" href="login.html" id="nav-login">×”×ª×—×‘×¨×•×ª</a>
    <button id="logout" style="display:none" id="nav-logout">×”×ª× ×ª×§×•×ª</button>
    <a href="admin.html" id="nav-admin">× ×™×”×•×œ</a>
    <button id="theme-toggle">ğŸŒ™ ××¦×‘ ×›×”×”</button>
    <button id="language-toggle">ğŸŒ English</button>
  </nav>

  <div id="toast"></div>

  <h1 id="page-title">×—× ×•×ª ×§×™× ×•×—×™× ğŸ°</h1>
  <input type="text" id="search" placeholder="×—×¤×© ×§×™× ×•×—..." />
  <div id="products" class="grid"></div>

  <script>
    // === ×”×•×¡×¤×ª ××—×™×¨×•×Ÿ (×©×™× ×•×™ ××™× ×™××œ×™) ===
    const PRICE_MAP = {
      'chocolate-cake': 150,
      'cookies-box': 125,
      'cupcakes': 160,
      'minnie-mous-cake': 300,
      'nutella-box': 70,
      'pizza-cookie': 120,
      'white-design-cake': 140
    };
    function priceOf(id) {
      if (id in PRICE_MAP) return PRICE_MAP[id];
      if (String(id).includes('cookie')) return 17; // ×›×œ ×”×¢×•×’×™×•×ª ×”××—×¨×•×ª
      return 0;
    }
    const nis = n => `â‚ª${n}`;

    // ×˜×¢×™× ×ª ×”×ª×××•×ª ××™×©×™×•×ª ×-localStorage (×œ×¤×™ ×”×•×¨××•×ª ×”××˜×œ×”)
    function loadUICustomization() {
      const theme = localStorage.getItem('theme') || 'light';
      const themeToggle = document.getElementById('theme-toggle');
      const languageToggle = document.getElementById('language-toggle');
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
        themeToggle.textContent = 'â˜€ï¸ ××¦×‘ ×‘×”×™×¨';
      } else {
        document.body.classList.remove('dark-theme');
        themeToggle.textContent = 'ğŸŒ™ ××¦×‘ ×›×”×”';
      }
      const currentLanguage = localStorage.getItem('language') || 'he';
      languageToggle.textContent = currentLanguage === 'en' ? 'ğŸŒ ×¢×‘×¨×™×ª' : 'ğŸŒ English';
      updateInterfaceLanguage(currentLanguage);
    }

    function updateInterfaceLanguage(lang) {
      const translations = {
        he: {
          'nav-store': '×—× ×•×ª','nav-cart': '×¡×œ ×”×§× ×™×•×ª','nav-checkout': '×ª×©×œ×•×','nav-myitems': '×”×¨×›×™×©×•×ª ×©×œ×™',
          'nav-login': '×”×ª×—×‘×¨×•×ª','nav-logout': '×”×ª× ×ª×§×•×ª','nav-admin': '× ×™×”×•×œ',
          'page-title': '×—× ×•×ª ×§×™× ×•×—×™× ğŸ°','search-placeholder': '×—×¤×© ×§×™× ×•×—...',
          'theme-dark': 'ğŸŒ™ ××¦×‘ ×›×”×”','theme-light': 'â˜€ï¸ ××¦×‘ ×‘×”×™×¨'
        },
        en: {
          'nav-store': 'Store','nav-cart': 'Shopping Cart','nav-checkout': 'Checkout','nav-myitems': 'My Purchases',
          'nav-login': 'Login','nav-logout': 'Logout','nav-admin': 'Admin',
          'page-title': 'Desserts Store ğŸ°','search-placeholder': 'Search dessert...',
          'theme-dark': 'ğŸŒ™ Dark Mode','theme-light': 'â˜€ï¸ Light Mode'
        }
      };
      const texts = translations[lang]; if (!texts) return;
      document.getElementById('nav-store').textContent = texts['nav-store'];
      document.getElementById('nav-cart').textContent = texts['nav-cart'];
      document.getElementById('nav-checkout').textContent = texts['nav-checkout'];
      document.getElementById('nav-myitems').textContent = texts['nav-myitems'];
      document.getElementById('login-link').textContent = texts['nav-login'];
      document.getElementById('logout').textContent = texts['nav-logout'];
      document.getElementById('nav-admin').textContent = texts['nav-admin'];
      document.getElementById('page-title').textContent = texts['page-title'];
      document.getElementById('search').placeholder = texts['search-placeholder'];
      const theme = localStorage.getItem('theme') || 'light';
      document.getElementById('theme-toggle').textContent =
        theme === 'dark' ? texts['theme-light'] : texts['theme-dark'];
      if (lang === 'en') { document.documentElement.dir = 'ltr'; document.documentElement.lang = 'en'; }
      else { document.documentElement.dir = 'rtl'; document.documentElement.lang = 'he'; }
    }

    document.getElementById('theme-toggle').addEventListener('click', () => {
      const isDark = document.body.classList.contains('dark-theme');
      const newTheme = isDark ? 'light' : 'dark';
      localStorage.setItem('theme', newTheme); loadUICustomization();
    });
    document.getElementById('language-toggle').addEventListener('click', () => {
      const current = localStorage.getItem('language') || 'he';
      const next = current === 'he' ? 'en' : 'he';
      localStorage.setItem('language', next);
      document.getElementById('language-toggle').textContent = next === 'en' ? 'ğŸŒ ×¢×‘×¨×™×ª' : 'ğŸŒ English';
      updateInterfaceLanguage(next); fetchAndRender();
    });

    // × ×™×•×•×˜ ×“×™× ××™ (×©×•××¨ ×¢×œ ×”×•×¤×¢×ª admin ×¨×§ ×œ-admin)
    async function setupAuthButtons() {
      const loginLink = document.getElementById('login-link');
      const logoutBtn = document.getElementById('logout');
      let loggedIn = false, username = '';
      try {
        const r = await fetch('/api/session'); 
        if (r.ok) { loggedIn = true; const data = await r.json(); username = data.username; }
      } catch {}
      loginLink.style.display = loggedIn ? 'none' : '';
      logoutBtn.style.display = loggedIn ? '' : 'none';
      const adminLinkElement = document.querySelector('a[href="admin.html"]');
      if (adminLinkElement) adminLinkElement.style.display = (loggedIn && username === 'admin') ? '' : 'none';
    }
    setupAuthButtons();
    document.getElementById('logout').onclick = async () => {
      try { await fetch('/api/logout', { method: 'POST' }); } finally { location.href = 'login.html'; }
    };

    // ×˜×•×¡×˜
    const toastEl = document.getElementById('toast'); let toastTimer;
    function showToast(msg) {
      toastEl.textContent = msg; toastEl.classList.add('show');
      clearTimeout(toastTimer); toastTimer = setTimeout(() => toastEl.classList.remove('show'), 1500);
    }

    // ×—× ×•×ª
    document.getElementById('search').addEventListener('input', fetchAndRender);
    async function fetchAndRender() {
      const prefix = document.getElementById('search').value || '';
      const res = await fetch(`/api/products?search=${encodeURIComponent(prefix)}`);
      const products = await res.json();
      const container = document.getElementById('products');
      const currentLanguage = localStorage.getItem('language') || 'he';
      container.innerHTML = '';

      for (const p of products) {
        const card = document.createElement('div'); card.className = 'product';

        // ×ª×¨×’×•× ×©× ××•×¦×¨ (×›××• ×‘×§×•×“ ×”××§×•×¨×™)
        const productTranslations = {
          'bagle-cookie': { he: '×¢×•×’×™×™×ª ×‘×™×™×’×œ', en: 'Bagel Cookie' },
          'caramel-cookie': { he: '×¢×•×’×™×™×ª ×§×¨××œ', en: 'Caramel Cookie' },
          'chocolate-cake': { he: '×¢×•×’×ª ×©×•×§×•×œ×“', en: 'Chocolate Cake' },
          'cookies-box': { he: '×§×•×¤×¡×ª ×¢×•×’×™×•×ª', en: 'Cookies Box' },
          'cupcakes': { he: '×§××¤×§×™×™×§×¡', en: 'Cupcakes' },
          'kinder-cookie': { he: '×¢×•×’×™×™×ª ×§×™× ×“×¨', en: 'Kinder Cookie' },
          'lotus-cookie': { he: '×¢×•×’×™×™×ª ×œ×•×˜×•×¡', en: 'Lotus Cookie' },
          'minnie-mous-cake': { he: '×¢×•×’×ª ××™× ×™ ×××•×¡', en: 'Minnie Mouse Cake' },
          'nutella-box': { he: '×§×•×¤×¡×ª × ×•×˜×œ×”', en: 'Nutella Box' },
          'nutella-cookie': { he: '×¢×•×’×™×™×ª × ×•×˜×œ×”', en: 'Nutella Cookie' },
          'orange-cake': { he: '×¢×•×’×ª ×ª×¤×•×–', en: 'Orange Cake' },
          'pizza-cookie': { he: '×¢×•×’×™×™×ª ×¤×™×¦×”', en: 'Pizza Cookie' },
          'white-chocolate-cookie': { he: '×¢×•×’×™×™×ª ×©×•×§×•×œ×“ ×œ×‘×Ÿ', en: 'White Chocolate Cookie' },
          'white-design-cake': { he: '×¢×•×’×” ×œ×‘× ×” ××¢×•×¦×‘×ª', en: 'White Design Cake' }
        };
        const productName =
          (productTranslations[p.id] && productTranslations[p.id][currentLanguage]) ? productTranslations[p.id][currentLanguage] : p.title;

        // === ×›××Ÿ ×”×ª×•×¡×¤×ª ×”×™×—×™×“×”: ××—×™×¨ ×œ×™×“ ×©× ×”××•×¦×¨ ===
        const unit = priceOf(p.id);

        const addToCartText = currentLanguage === 'en' ? 'Add to Cart' : '×”×•×¡×£ ×œ×¡×œ';
        card.innerHTML = `
          <img src="/images/${p.image}" alt="${productName}">
          <h3>${productName} Â· <span class="price">${nis(unit)}</span></h3>
          <p class="meta">${p.description || ''}</p>
          <button data-id="${p.id}" data-title="${productName}">${addToCartText}</button>
        `;
        container.appendChild(card);
      }

      container.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-id]'); if (!btn) return;
        const id = btn.getAttribute('data-id'); const title = btn.getAttribute('data-title');
        const r = await fetch('/api/cart', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ productId: id }) });
        if (r.status === 401) { location.href='login.html'; return; }
        if (r.ok) { const lang = localStorage.getItem('language') || 'he';
          showToast(lang === 'en' ? `${title} added to cart` : `${title} × ×•×¡×£ ×œ×¡×œ`);
        }
      });
    }

    loadUICustomization(); fetchAndRender();
  </script>
</body>
</html>
