<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>×—× ×•×ª ×”×§×™× ×•×—×™× ×©×œ× ×•</title>
  <link rel="stylesheet" href="/assets/styles.css">
</head>
<body>
  <nav>
    <a href="/screens/store.html">×—× ×•×ª</a>
    <a href="/screens/cart.html">×¡×œ ×”×§× ×™×•×ª</a>
    <a href="/screens/checkout.html">×ª×©×œ×•×</a>
    <a href="/screens/myitems.html">×”×¨×›×™×©×•×ª ×©×œ×™</a>
    <button id="logout" type="button">×”×ª× ×ª×§×•×ª</button>
  </nav>

  <h1>×—× ×•×ª ×§×™× ×•×—×™× ğŸ°</h1>

  <input type="text" id="search" placeholder="×—×¤×© ×§×™× ×•×—..." />
  <div id="products"></div>

  <script>
    // Logout
    document.getElementById('logout').onclick = async () => {
      try { await fetch('/api/logout', { method: 'POST' }); }
      finally { location.href = '/screens/login.html'; }
    };

    // ×—×™×¤×•×© â€” × ×˜×¢×Ÿ ××ª ×›×œ ×”××•×¦×¨×™× ×›×©××™×Ÿ ×—×™×¤×•×©
    document.getElementById('search').addEventListener('input', fetchAndRender);

    async function fetchAndRender() {
      const prefix = document.getElementById('search').value.trim();
      const url = prefix ? `/api/products?search=${encodeURIComponent(prefix)}` : `/api/products`;

      const res = await fetch(url);
      if (!res.ok) return console.error('products status', res.status);
      const products = await res.json();

      const container = document.getElementById('products');
      container.innerHTML = '';

      for (const p of products) {
        const card = document.createElement('div');
        card.className = 'product';
        card.innerHTML = `
          <img src="/images/${p.image}" alt="${p.title}">
          <h3>${p.title}</h3>
          <p>${p.description}</p>
          <button class="add-to-cart" data-id="${p.id}">Add to cart</button>
        `;
        container.appendChild(card);
      }
    }

    // ×××–×™×Ÿ ×œÖ¾Add to cart
    document.getElementById('products').addEventListener('click', async e => {
      if (!e.target.matches('.add-to-cart')) return;
      const id = e.target.dataset.id;
      const res = await fetch('/api/cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      });
      if (res.status === 401) return location.href = '/screens/login.html';
      const json = await res.json();
      if (!res.ok) return alert(json.error);
      alert('âœ… ×”××•×¦×¨ ×”×ª×•×•×¡×£ ×œ×¡×œ!');
    });

    // ×˜×¢×™× ×” ×¨××©×•× ×™×ª â€“ ×‘×œ×™ ×¤×¨××˜×¨ search ×›×“×™ ×œ×”×‘×™× ×”×›×œ
    fetchAndRender();
  </script>
</body>
</html>
