<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×—× ×•×ª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/styles.css" />
  <style>
    /* ×˜×•×¡×˜ ×§×˜×Ÿ ×‘×¤×™× ×” ×”×™×× ×™×ª-×¢×œ×™×•× ×” */
    #toast {
      position: fixed; top: 20px; right: 20px; z-index: 9999;
      display: none; padding: 12px 16px; 
      background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
      color: #fff; border-radius: 12px; 
      box-shadow: 0 4px 12px rgba(0,0,0,.3);
      font-size: 14px; font-weight: 600;
      opacity: 0; transform: translateY(-10px) scale(0.9);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 300px;
      text-align: center;
    }
    #toast.show { 
      display: block; opacity: 1; 
      transform: translateY(0) scale(1); 
    }
    #toast::before {
      content: 'âœ“';
      display: inline-block;
      margin-left: 8px;
      font-size: 16px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <nav>
    <a href="store.html">×—× ×•×ª</a>
    <a href="cart.html">×¡×œ ×”×§× ×™×•×ª</a>
    <a href="checkout.html">×ª×©×œ×•×</a>
    <a href="myitems.html">×”×¨×›×™×©×•×ª ×©×œ×™</a>
    <a id="login-link" href="login.html">×”×ª×—×‘×¨×•×ª</a>
    <button id="logout" style="display:none">×”×ª× ×ª×§×•×ª</button>
    <a id="admin-link" href="admin.html" style="display:none">× ×™×”×•×œ</a>
    <button id="theme-toggle">ğŸŒ™ ××¦×‘ ×›×”×”</button>
  </nav>

  <div id="toast"></div>

  <h1>×—× ×•×ª ×§×™× ×•×—×™× ğŸ°</h1>
  <input type="text" id="search" placeholder="×—×¤×© ×§×™× ×•×—..." />
  <div id="products" class="grid"></div>

  <script>
    // ×˜×¢×™× ×ª ×”×ª×××” ××™×©×™×ª ×-localStorage (×œ×¤×™ ×”×•×¨××•×ª ×”××˜×œ×”)
    function loadUICustomization() {
      const theme = localStorage.getItem('theme') || 'light';
      const themeToggle = document.getElementById('theme-toggle');
      
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
        themeToggle.textContent = 'â˜€ï¸ ××¦×‘ ×‘×”×™×¨';
      } else {
        document.body.classList.remove('dark-theme');
        themeToggle.textContent = 'ğŸŒ™ ××¦×‘ ×›×”×”';
      }
    }

    // ×”×—×œ×¤×ª ××¦×‘ ×›×”×”/×‘×”×™×¨
    document.getElementById('theme-toggle').addEventListener('click', () => {
      const isDark = document.body.classList.contains('dark-theme');
      const newTheme = isDark ? 'light' : 'dark';
      
      localStorage.setItem('theme', newTheme);
      loadUICustomization();
    });

    // ×˜×¢×™× ×” ×¨××©×•× ×™×ª
    loadUICustomization();

    // × ×™×•×•×˜ ×“×™× ××™
    async function setupAuthButtons() {
      const loginLink = document.getElementById('login-link');
      const logoutBtn = document.getElementById('logout');
      const adminLink = document.getElementById('admin-link');
      let loggedIn = false;
      let username = '';
      
      try { 
        const r = await fetch('/api/session'); 
        if (r.ok) {
          loggedIn = true;
          const data = await r.json();
          username = data.username;
        }
      } catch {}
      
      loginLink.style.display = loggedIn ? 'none' : '';
      logoutBtn.style.display = loggedIn ? '' : 'none';
      
      // ×”×¦×’×ª ×§×™×©×•×¨ × ×™×”×•×œ ×¨×§ ×œ××©×ª××© admin
      adminLink.style.display = (loggedIn && username === 'admin') ? '' : 'none';
    }
    setupAuthButtons();
    document.getElementById('logout').onclick = async () => {
      try { await fetch('/api/logout', { method: 'POST' }); }
      finally { location.href = 'login.html'; }
    };

    // ×˜×•×¡×˜ ××©×•×¤×¨
    const toastEl = document.getElementById('toast');
    let toastTimer;
    function showToast(msg) {
      clearTimeout(toastTimer);
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      toastTimer = setTimeout(() => {
        toastEl.classList.remove('show');
      }, 2500);
    }

    // ×—× ×•×ª
    document.getElementById('search').addEventListener('input', fetchAndRender);
    async function fetchAndRender() {
      const prefix = document.getElementById('search').value || '';
      const res = await fetch(`/api/products?search=${encodeURIComponent(prefix)}`);
      const products = await res.json();
      const container = document.getElementById('products');
      container.innerHTML = '';
      for (const p of products) {
        const card = document.createElement('div');
        card.className = 'product';
        card.innerHTML = `
          <img src="/images/${p.image}" alt="${p.title}">
          <h3>${p.title}</h3>
          <p class="meta">${p.description || ''}</p>
          <button data-id="${p.id}" data-title="${p.title}">×”×•×¡×£ ×œ×¡×œ</button>
        `;
        container.appendChild(card);
      }

      container.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-id]');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const title = btn.getAttribute('data-title');
        const r = await fetch('/api/cart', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId: id })
        });
        if (r.ok) {
          showToast(`${title} ×”×ª×•×•×¡×£ ×œ×¡×œ ×”×§× ×™×•×ª`);
        } else {
          let j = {}; try { j = await r.json(); } catch {}
          if (r.status === 401) location.href = 'login.html';
          else alert(j.error || '×©×’×™××” ×‘×”×•×¡×¤×” ×œ×¡×œ');
        }
      }, { once: false });
    }
    fetchAndRender();
  </script>
</body>
</html>