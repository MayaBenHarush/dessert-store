<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>××¦×™××ª ×”×§×™× ×•×— ×”××•×©×œ×</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #ffffff;
      color: #1a1a1a;
      line-height: 1.6;
    }

    /* Header */
    .header {
      background: #ffffcc;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .header-left { display: flex; align-items: center; gap: 1rem; }
    .menu-btn { background: none; border: none; font-size: 1.1rem; font-weight: 600; color: #1a1a1a; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
    .menu-btn::before { content: "â˜°"; font-size: 1.2rem; }
    .logo { font-size: 2.2rem; font-weight: 900; color: #1a1a1a; text-decoration: none; letter-spacing: -0.02em; }
    .header-nav { display: flex; align-items: center; gap: 1rem; }
    .header-btn {
      background: none; border: 2px solid #1a1a1a; color: #1a1a1a; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; text-decoration: none; display: flex; align-items: center; gap: 0.3rem;
    }
    .header-btn:hover { background: #1a1a1a; color: white; }
    .header-btn.primary:hover { background: #333; }
    .login-btn::before { content: "ğŸ‘¤"; }

    /* Navigation Menu */
    .nav-menu { position: fixed; top: 0; right: -350px; width: 300px; height: 100vh; background: white; box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1); transition: right 0.3s ease; padding: 2rem; z-index: 2000; }
    .nav-menu.active { right: 0; }
    .nav-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; float: left; margin-bottom: 2rem; }
    .nav-item, .nav-menu a, .nav-menu button {
      display: block; padding: 0.75rem 0; color: #1a1a1a; text-decoration: none; font-weight: 500; border-bottom: 1px solid #f0f0f0; transition: color 0.2s ease; background: none; border: none; text-align: right; width: 100%; cursor: pointer;
    }
    .nav-item:hover, .nav-menu a:hover, .nav-menu button:hover { color: #ffffcc; }

    /* Overlay */
    .overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); z-index: 1500; opacity: 0; visibility: hidden; transition: all 0.3s ease;
    }
    .overlay.active { opacity: 1; visibility: visible; }

    /* Main Content */
    .main-content { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    .page-header { text-align: center; margin-bottom: 2rem; }
    .page-title {
      font-size: 3rem; font-weight: 900; color: #1a1a1a; margin-bottom: 1rem; letter-spacing: -0.02em; text-transform: uppercase;
    }

    /* Finder Container */
    .finder-container {
      background: white; border-radius: 20px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08); padding: 2rem; transition: all 0.3s ease; position: relative; overflow: hidden;
    }
    .finder-container::before { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 4px; background: #ffffcc; }

    /* Quiz Section */
    .quiz-section { margin-bottom: 2rem; }
    .progress-bar { background: #f0f0f0; height: 8px; border-radius: 20px; overflow: hidden; margin-bottom: 2rem; }
    .progress-fill { background: linear-gradient(90deg, #ff6b9d 0%, #ffffcc 100%); height: 100%; transition: width 0.5s ease; border-radius: 20px; }
    .question-header { background: linear-gradient(135deg, #1a1a1a 0%, #333 100%); color: white; padding: 2rem; border-radius: 16px; margin-bottom: 2rem; text-align: center; }
    .question-title { font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0; }
    .question-subtitle { font-size: 1rem; opacity: 0.9; margin: 0; }
    .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0; }
    .option-card {
      background: #f8f8f8; border: 2px solid transparent; border-radius: 16px; padding: 1.5rem; cursor: pointer; transition: all 0.2s ease; text-align: center; position: relative; overflow: hidden;
    }
    .option-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: #ffffcc; transform: scaleX(0); transition: transform 0.2s ease; transform-origin: right; }
    .option-card:hover { border-color: #1a1a1a; transform: translateY(-4px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); background: #ffffcc; }
    .option-card:hover::before { transform: scaleX(1); }
    .option-card.selected { border-color: #1a1a1a; background: #1a1a1a; color: white; transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }
    .option-card.selected::before { transform: scaleX(1); background: white; }
    .option-emoji { font-size: 2.5rem; margin-bottom: 1rem; display: block; }
    .option-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem; }
    .option-description { font-size: 0.9rem; opacity: 0.8; line-height: 1.4; }
    .quiz-navigation { display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; }
    .quiz-btn { background: #1a1a1a; color: white; border: none; padding: 1rem 2rem; border-radius: 20px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s ease; }
    .quiz-btn:hover:not(:disabled) { background: #333; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .quiz-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .quiz-btn.primary { background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); }
    .quiz-btn.primary:hover:not(:disabled) { background: linear-gradient(135deg, #ff5a8a 0%, #b23a56 100%); }
    #question-counter { font-weight: 600; color: #666; }

    /* Results Section */
    .results-section { display: none; }
    .results-header { background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); color: white; padding: 2rem; border-radius: 20px; margin-bottom: 2rem; text-align: center; }
    .results-title { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
    .results-subtitle { font-size: 1.2rem; opacity: 0.9; }
    .recommendation-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; margin: 2rem 0; }
    .recommendation-card { background: white; border-radius: 20px; padding: 1.5rem; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08); transition: all 0.3s ease; position: relative; overflow: hidden; border: 2px solid transparent; }
    .recommendation-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 6px; background: #ffffcc; }
    .recommendation-card:hover { transform: translateY(-8px); box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12); }
    .recommendation-card.perfect-match { border-color: #ff6b9d; }
    .recommendation-card.perfect-match::before { background: linear-gradient(90deg, #ff6b9d 0%, #c44569 100%); height: 8px; }
    .match-badge { background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 700; margin-bottom: 1rem; display: inline-block; }
    .recommendation-image { width: 100%; height: 200px; object-fit: cover; border-radius: 12px; margin-bottom: 1rem; }
    .recommendation-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 0.5rem; color: #1a1a1a; }
    .recommendation-price { font-size: 1.1rem; font-weight: 700; color: #1a1a1a; margin-bottom: 1rem; }
    .recommendation-description { font-size: 0.9rem; color: #666; line-height: 1.5; margin-bottom: 1rem; }
    .recommendation-reasons { background: rgba(255, 255, 204, 0.3); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border-right: 3px solid #1a1a1a; }
    .recommendation-reasons h4 { font-size: 0.9rem; font-weight: 700; color: #1a1a1a; margin: 0 0 0.5rem 0; }
    .recommendation-reasons ul { list-style: none; padding: 0; margin: 0; }
    .recommendation-reasons li { font-size: 0.8rem; color: #666; margin-bottom: 0.25rem; position: relative; padding-right: 16px; }
    .recommendation-reasons li::before { content: "âœ“"; position: absolute; right: 0; color: #1a1a1a; font-weight: bold; }
    .add-to-cart-btn { background: #1a1a1a; color: white; border: none; padding: 1rem; border-radius: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; width: 100%; }
    .add-to-cart-btn:hover { background: #333; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .restart-quiz { background: none; border: 2px solid #1a1a1a; color: #1a1a1a; padding: 1rem 2rem; border-radius: 20px; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s ease; margin: 2rem auto; display: block; }
    .restart-quiz:hover { background: #1a1a1a; color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .loading-box { text-align: center; padding: 3rem; font-size: 1.1rem; color: #666; }

    /* Animations */
    @keyframes slideInRight { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
    .question-slide-in { animation: slideInRight 0.5s ease; }

    /* Dark Theme */
    .dark-theme { background: #1a1a1a; color: white; }
    .dark-theme .header { background: #2d2d2d; }
    .dark-theme .nav-menu { background: #2d2d2d; }
    .dark-theme .nav-menu a, .dark-theme .nav-menu button { color: white; border-bottom-color: #444; }
    .dark-theme .finder-container, .dark-theme .recommendation-card { background: #2d2d2d; }
    .dark-theme .question-title, .dark-theme .recommendation-title { color: white; }
    .dark-theme .option-card { background: #444; color: white; }
    .dark-theme .option-card:hover { background: #555; }
    .dark-theme .option-card.selected { background: #ffffcc; color: #1a1a1a; }
    .dark-theme .quiz-btn { background: #ffffcc; color: #1a1a1a; }
    .dark-theme .quiz-btn:hover:not(:disabled) { background: #fff; }
    .dark-theme .recommendation-reasons { background: rgba(45, 45, 45, 0.5); border-color: #ffffcc; }
    .dark-theme .add-to-cart-btn { background: #ffffcc; color: #1a1a1a; }
    .dark-theme .add-to-cart-btn:hover { background: #fff; }

    /* Hide old nav but NOT the slide-out menu */
    body > nav:not(.nav-menu) { display: none; }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header { padding: 1rem; flex-wrap: wrap; gap: 1rem; }
      .header-left { order: 1; }
      .logo { font-size: 1.8rem; order: 2; }
      .header-nav { order: 3; width: 100%; justify-content: center; gap: 0.5rem; }
      .header-btn { padding: 0.4rem 0.6rem; font-size: 0.75rem; }
      .main-content { padding: 1rem; }
      .page-title { font-size: 2rem; }
      .finder-container { padding: 1.5rem; border-radius: 16px; }
      .options-grid { grid-template-columns: 1fr; }
      .quiz-navigation { flex-direction: column; gap: 1rem; }
      .recommendation-cards { grid-template-columns: 1fr; }
    }

    @media (max-width: 480px) {
      .header-btn { padding: 0.3rem 0.5rem; font-size: 0.7rem; }
      .header-btn::before { display: none; }
    }
  </style>
</head>
<body>
  <div class="overlay" id="overlay"></div>
  
  <header class="header">
    <div class="header-left">
      <button class="menu-btn" id="menuBtn">Menu</button>
      <a href="/" class="logo">dessert</a>
    </div>
    
    <nav class="header-nav">
      <a href="/screens/index.html" class="header-btn home-btn">×‘×™×ª</a>
      <a href="/screens/cart.html" class="header-btn cart-btn">×¡×œ ×§× ×™×•×ª</a>
      <a href="/screens/dessert-finder.html" class="header-btn finder-btn primary">××¦×™××ª ×§×™× ×•×—</a>
      <a href="/screens/login.html" class="header-btn login-btn" id="header-login">×”×ª×—×‘×¨×•×ª</a>
    </nav>
  </header>

  <nav class="nav-menu" id="navMenu">
    <button class="nav-close" id="navClose">Ã—</button>

    <a href="store.html" id="nav-store">×—× ×•×ª</a>
    <a href="cart.html" id="nav-cart">×¡×œ ×”×§× ×™×•×ª</a>
    <a href="checkout.html" id="nav-checkout">×ª×©×œ×•×</a>
    <a href="myitems.html" id="nav-myitems">×”×¨×›×™×©×•×ª ×©×œ×™</a>
    <a href="admin.html" id="nav-admin" style="display:none">× ×™×”×•×œ</a>
    <a href="dessert-finder.html">××¦×™××ª ×”×§×™× ×•×— ×”××•×©×œ×</a>
    <a href="wheel.html">×’×œ×’×œ ××–×œ</a>
    <a href="cake-designer.html">×¢×™×¦×•×‘ ×¢×•×’×”</a>
    <a href="recipes.html" id="nav-recipes">××ª×›×•× ×™×</a>
    <button id="logout" style="display:none">×”×ª× ×ª×§×•×ª</button>
    <button id="theme-toggle">ğŸŒ™ ××¦×‘ ×›×”×”</button>
    <button id="language-toggle">ğŸŒ English</button>
  </nav>

  <main class="main-content">
    <div class="page-header">
      <h1 class="page-title">ğŸ” ××¦×™××ª ×”×§×™× ×•×— ×”××•×©×œ×</h1>
    </div>

    <div class="finder-container">
      <!-- ×—×™×“×•×Ÿ -->
      <div id="quiz-section" class="quiz-section">
        <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
        <div id="question-container"></div>
        <div class="quiz-navigation">
          <button id="prev-btn" class="quiz-btn" disabled>×©××œ×” ×§×•×“××ª</button>
          <span id="question-counter">×©××œ×” 1 ××ª×•×š 6</span>
          <button id="next-btn" class="quiz-btn primary" disabled>×©××œ×” ×”×‘××”</button>
        </div>
      </div>

      <!-- ×ª×•×¦××•×ª -->
      <div id="results-section" class="results-section" tabindex="-1">
        <div class="results-header">
          <h2 class="results-title">××¦×× ×• ×‘×©×‘×™×œ×š!</h2>
          <p class="results-subtitle">×”×§×™× ×•×—×™× ×”××•×©×œ××™× ×‘×”×ª×× ×œ×”×¢×“×¤×•×ª ×©×œ×š</p>
        </div>
        <div id="recommendations-container" class="recommendation-cards"></div>
        <button id="restart-quiz" class="restart-quiz">×”×ª×—×œ ×©×•×‘</button>
      </div>
    </div>
  </main>

  <!-- ×˜×•×¢×Ÿ ××ª ××¢×¨×›×ª ×”×ª×¨×’×•××™× (××™×Ÿ ×©×™× ×•×™ ×¢×™×¦×•×‘/×¤×•× ×§×¦×™×•× ×œ×™×•×ª) -->
  <script src="/translations.js"></script>

  <script>
    // Menu functionality
    document.addEventListener('DOMContentLoaded', function() {
      const menuBtn = document.getElementById('menuBtn');
      const navMenu = document.getElementById('navMenu');
      const navClose = document.getElementById('navClose');
      const overlay = document.getElementById('overlay');

      function openMenu() {
        navMenu.classList.add('active');
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeMenu() {
        navMenu.classList.remove('active');
        overlay.classList.remove('active');
        document.body.style.overflow = 'auto';
      }

      menuBtn.addEventListener('click', openMenu);
      navClose.addEventListener('click', closeMenu);
      overlay.addEventListener('click', closeMenu);

      // Continue with the original functionality...
      initApp();
    });

    // ----- × ×ª×•× ×™ ×”×©××œ×•×ª -----
    const QUESTIONS = [
      { id:'occasion', title:'××™×–×” ××™×¨×•×¢ ××ª ××ª×›× × ×ª?', subtitle:'×–×” ×™×¢×–×•×¨ ×œ× ×• ×œ×”××œ×™×¥ ×¢×œ ×”×’×•×“×œ ×•×”×¡×’× ×•×Ÿ ×”××ª××™×',
        options:[
          { id:'personal', emoji:'ğŸ˜‹', title:'×¤×™× ×•×§ ××™×©×™', description:'×¨×§ ×‘×©×‘×™×œ×™ ××• ×œ×©× ×™×™×' },
          { id:'family', emoji:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', title:'×¢×¨×‘ ××©×¤×—×ª×™', description:'3-6 ×× ×©×™×' },
          { id:'party', emoji:'ğŸ‰', title:'××¡×™×‘×”/××™×¨×•×¢', description:'7+ ×× ×©×™×' },
          { id:'gift', emoji:'ğŸ', title:'××ª× ×” ××™×•×—×“×ª', description:'×œ×ª×ª ×œ××™×©×”×• ××”×•×‘' }
        ]},
      { id:'taste_preference', title:'××™×–×” ×˜×¢× ×”×›×™ ××¢× ×™×™×Ÿ ××•×ª×š?', subtitle:'×‘×•××™ × ××¦× ××ª ×”×˜×¢× ×©×™×’×¨×•× ×œ×š ×œ×”×ª××•×’×’',
        options:[
          { id:'chocolate', emoji:'ğŸ«', title:'×©×•×§×•×œ×“ ×¢×©×™×¨', description:'××”×‘×ª ×©×•×§×•×œ×“ ×××™×ª×™×ª' },
          { id:'fruity', emoji:'ğŸŠ', title:'×¤×™×¨×•×ª×™ ×•×¨×¢× ×Ÿ', description:'×ª×¤×•×–×™× ×•×˜×¢××™× ×¨×¢× × ×™×' },
          { id:'sweet_treats', emoji:'ğŸ¯', title:'××ª×•×§ ×•×—××”', description:'×œ×•×˜×•×¡, × ×•×˜×œ×”, ×§×¨××œ' },
          { id:'mixed', emoji:'ğŸŒˆ', title:'××•×”×‘×ª ×”×›×œ', description:'×¤×ª×•×—×” ×œ×”×¤×ª×¢×•×ª' }
        ]},
      { id:'texture', title:'××™×–×” ××¨×§× ×”×›×™ ××•×©×œ× ×‘×©×‘×™×œ×š?', subtitle:'×”×˜×§×¡×˜×•×¨×” ××©×¤×™×¢×” ×¢×œ ×›×œ ×”×—×•×•×™×”',
        options:[
          { id:'soft_cake', emoji:'ğŸ§½', title:'×¢×•×’×” ×¨×›×” ×•×¡×¤×•×’×™×ª', description:'× ××¡×ª ×‘×¤×”' },
          { id:'crunchy', emoji:'ğŸ¥¨', title:'×¤×¨×™×š ×•×¤×¨×™×š', description:'×¢×•×’×™×•×ª ×¢× × ×©×™×›×”' },
          { id:'creamy', emoji:'ğŸ°', title:'×§×¨××™ ×•×—×œ×§', description:'×§××¤×§×™×™×§×¡ ×¢× ×§×¨×' },
          { id:'mixed_texture', emoji:'ğŸ¯', title:'×©×™×œ×•×‘ ××¨×§××™×', description:'×¨×š ×•×§×¨×™×¡×¤×™ ×‘×™×—×“' }
        ]},
      { id:'dietary', title:'×™×© ×”×’×‘×œ×•×ª ×ª×–×•× ×ª×™×•×ª ×©×›×“××™ ×œ×“×¢×ª?', subtitle:'× ×•×•×“× ×©×”××•×¦×¨ ××ª××™× ×œ×š',
        options:[
          { id:'none', emoji:'âœ¨', title:'×œ×œ× ×”×’×‘×œ×•×ª', description:'××•×›×œ×ª ×”×›×œ ×‘×ª×™××‘×•×Ÿ' },
          { id:'nuts_aware', emoji:'ğŸ¥œ', title:'× ×–×”×¨×ª ×××’×•×–×™×', description:'××œ×¨×’×™×” ××• ×”×¢×“×¤×”' },
          { id:'light', emoji:'ğŸª¶', title:'××©×”×• ×§×œ ×™×•×ª×¨', description:'×œ× ×›×‘×“ ××“×™' },
          { id:'portions', emoji:'ğŸ“', title:'×× ×•×ª ××™×©×™×•×ª', description:'××¢×“×™×¤×” ×× ×•×ª ×§×˜× ×•×ª' }
        ]},
      { id:'budget', title:'××™×–×” ×ª×§×¦×™×‘ × ×•×— ×œ×š?', subtitle:'× ××¦× ××©×”×• ××•×©×œ× ×‘×˜×•×•×— ×”××—×™×¨×™× ×©×œ×š',
        options:[
          { id:'budget', emoji:'ğŸ’°', title:'×¢×“ 100 â‚ª', description:'××©×”×• × ×—××“ ×•×‘××—×™×¨ × ×•×—' },
          { id:'medium', emoji:'ğŸ’³', title:'100-200 â‚ª', description:'××•×›× ×” ×œ×”×©×§×™×¢ ×‘××™×›×•×ª' },
          { id:'premium', emoji:'ğŸ’', title:'200+ â‚ª', description:'××—×¤×©×ª ××©×”×• ××™×•×—×“' },
          { id:'flexible', emoji:'ğŸ¯', title:'×’××™×©×”', description:'×ª×œ×•×™ ×‘××” ×©××ª××™×' }
        ]},
      { id:'presentation', title:'×›××” ×—×©×•×‘ ×œ×š ×”××¨××” ×•×”×¢×™×¦×•×‘?', subtitle:'×–×” ××©×¤×™×¢ ×¢×œ ×”×‘×—×™×¨×” ×‘×™×Ÿ ××•×¦×¨×™× ×¤×©×•×˜×™× ×œ××¢×•×¦×‘×™×',
        options:[
          { id:'simple', emoji:'ğŸ¤', title:'×¤×©×•×˜ ×•×˜×¢×™×', description:'×”×˜×¢× ××¢×œ ×”×›×œ' },
          { id:'nice', emoji:'ğŸ“¸', title:'×™×¤×” ×œ×ª××•× ×•×ª', description:'× ×—××“ ×œ×”×¦×™×’' },
          { id:'wow', emoji:'ğŸŒŸ', title:'××©×”×• ×©××¨×©×™×', description:'×œ×”×¤×ª×™×¢ ×•×œ×‘×œ×•×˜' },
          { id:'custom', emoji:'ğŸ¨', title:'××•×ª×× ××™×©×™×ª', description:'×¢×™×¦×•×‘ ×‘×”×ª×××” ××™×©×™×ª' }
        ]}
    ];

    // ===== ×©×›×‘×ª ×ª×¨×’×•× ×‘×–××Ÿ ×¨×™× ×“×•×¨ (×œ×œ× ×©×™× ×•×™ ×¢×™×¦×•×‘/×¤×•× ×§×¦×™×•×ª ××—×¨×•×ª) =====
    const QUESTIONS_EN_MAP = {
      occasion:{ title:'What occasion are you planning?', subtitle:'Helps us suggest the right size & style',
        options:{ personal:{title:'Personal treat',description:'Just for me or two'},
                  family:{title:'Family evening',description:'3â€“6 people'},
                  party:{title:'Party / Event',description:'7+ people'},
                  gift:{title:'A special gift',description:'For someone you love'} } },
      taste_preference:{ title:'Which taste tempts you most?', subtitle:'Letâ€™s find the flavor youâ€™ll love',
        options:{ chocolate:{title:'Rich chocolate',description:'For true chocoholics'},
                  fruity:{title:'Fruity & fresh',description:'Oranges and fresh flavors'},
                  sweet_treats:{title:'Sweet & cozy',description:'Lotus, Nutella, caramel'},
                  mixed:{title:'Love it all',description:'Open to surprises'} } },
      texture:{ title:'What texture is perfect for you?', subtitle:'Texture shapes the experience',
        options:{ soft_cake:{title:'Soft & spongy cake',description:'Melts in your mouth'},
                  crunchy:{title:'Crunchy & crisp',description:'Cookies with a bite'},
                  creamy:{title:'Creamy & smooth',description:'Cupcakes with frosting'},
                  mixed_texture:{title:'Mixed textures',description:'Soft and crispy together'} } },
      dietary:{ title:'Any dietary preferences?', subtitle:'Weâ€™ll make sure it fits you',
        options:{ none:{title:'No restrictions',description:'Eat everything happily'},
                  nuts_aware:{title:'Careful with nuts',description:'Allergy or preference'},
                  light:{title:'On the lighter side',description:'Not too heavy'},
                  portions:{title:'Individual portions',description:'Prefer small servings'} } },
      budget:{ title:'Whatâ€™s your budget?', subtitle:'Weâ€™ll find the perfect match for your price range',
        options:{ budget:{title:'Up to â‚ª100',description:'Nice and affordable'},
                  medium:{title:'â‚ª100â€“â‚ª200',description:'Willing to invest in quality'},
                  premium:{title:'â‚ª200+',description:'Looking for something special'},
                  flexible:{title:'Flexible',description:'Depends on what fits'} } },
      presentation:{ title:'How important is the look & design?', subtitle:'Affects the choice between simple and designed items',
        options:{ simple:{title:'Simple & tasty',description:'Taste above all'},
                  nice:{title:'Nice for photos',description:'Good to showcase'},
                  wow:{title:'Something impressive',description:'To surprise and stand out'},
                  custom:{title:'Custom made',description:'Personalized design'} } }
    };

    function currentLang(){ return (window.Translations?.currentLanguage?.() || localStorage.getItem('language') || 'he'); }

    function localizeQuestion(baseQ){
      if (currentLang() !== 'en') return baseQ;
      const map = QUESTIONS_EN_MAP[baseQ.id];
      if (!map) return baseQ;
      return {
        id: baseQ.id,
        title: map.title || baseQ.title,
        subtitle: map.subtitle || baseQ.subtitle,
        options: baseQ.options.map(opt=>{
          const m = map.options?.[opt.id] || {};
          return { ...opt, title:(m.title||opt.title), description:(m.description||opt.description) };
        })
      };
    }

    function applyFinderStaticTexts(){
      const idx = currentQuestion + 1;
      const total = QUESTIONS.length;
      const t = window.Translations?.get?.bind(window.Translations);
      const prev = t ? t('finder.prevQuestion','×©××œ×” ×§×•×“××ª') : '×©××œ×” ×§×•×“××ª';
      const next = t ? (currentQuestion===total-1 ? t('finder.lastQuestion','×¦×¤×” ×‘×ª×•×¦××•×ª') : t('finder.nextQuestion','×©××œ×” ×”×‘××”'))
                     : (currentQuestion===total-1 ? '×¦×¤×” ×‘×ª×•×¦××•×ª' : '×©××œ×” ×”×‘××”');
      const counter = t ? t('finder.questionCounter','×©××œ×” {current} ××ª×•×š {total}').replace('{current}', idx).replace('{total}', total)
                        : `×©××œ×” ${idx} ××ª×•×š ${total}`;
      document.getElementById('prev-btn').textContent = prev;
      document.getElementById('next-btn').textContent = next;
      document.getElementById('question-counter').textContent = counter;
    }

    // ×××–×™×Ÿ ×œ×©×™× ×•×™ ×©×¤×”
    document.addEventListener('DOMContentLoaded', () => {
      const languageToggle = document.getElementById('language-toggle');
      if (languageToggle) {
        languageToggle.addEventListener('click', () => {
          // âœ… ×× ×§×™×™××ª ××¢×¨×›×ª ×”×ª×¨×’×•××™× â€“ ×”×©×ª××© ×‘×”; ××—×¨×ª Fallback ×©××—×œ×™×£ localStorage ×‘×œ×‘×“
          if (window.toggleLanguage) {
            window.toggleLanguage(); // ××¤×¢×™×œ translations.js (× ×©××¨ RTL)
          } else {
            const cur = localStorage.getItem('language') || 'he';
            const next = (cur === 'he') ? 'en' : 'he';
            localStorage.setItem('language', next);
            document.documentElement.lang = next;
            document.documentElement.dir = 'rtl';
          }
          // ×¨×¢× ×•×Ÿ ×˜×§×¡×˜×™×
          applyFinderStaticTexts();
          showQuestion(currentQuestion);
          // ×¢×“×›×•×Ÿ ×ª×•×•×™×ª ×”×›×¤×ª×•×¨ ×¢×¦××•
          const btn = document.getElementById('language-toggle');
          if (btn) btn.textContent = ((localStorage.getItem('language')||'he')==='en') ? 'ğŸŒ ×¢×‘×¨×™×ª' : 'ğŸŒ English';
        });
      }
    });

    window.addEventListener('language-changed', () => {
      applyFinderStaticTexts();
      showQuestion(currentQuestion);
    });
    // ===== ×¡×•×£ ×©×›×‘×ª ×”×ª×¨×’×•× =====

    // ----- ××¦×‘ ××¤×œ×™×§×¦×™×” -----
    let currentQuestion = 0;
    let answers = {};
    let isAuthenticated = false;

    // ----- DOM -----
    const questionContainer = document.getElementById('question-container');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const questionCounter = document.getElementById('question-counter');
    const progressFill = document.getElementById('progress-fill');
    const quizSection = document.getElementById('quiz-section');
    const resultsSection = document.getElementById('results-section');
    const recommendationsContainer = document.getElementById('recommendations-container');
    const restartBtn = document.getElementById('restart-quiz');

    // ----- ××ª×—×•×œ -----
    async function initApp() {
      loadUICustomization();
      await checkAuth();
      await setupAuth();
      showQuestion(0);
    }

    // ----- ××™××•×ª -----
    async function checkAuth() {
      try {
        const response = await fetch('/api/session');
        isAuthenticated = response.ok;
      } catch { 
        isAuthenticated = false; 
      }
    }

    async function setupAuth() {
      try {
        const r = await fetch('/api/session');
        if (r.ok) {
          const data = await r.json();
          const headerLogin = document.getElementById('header-login');
          const loginLink = document.getElementById('login-link');
          const logoutBtn = document.getElementById('logout');
          const adminLink = document.getElementById('admin-link');
          
          if (headerLogin) headerLogin.style.display = 'none';
          if (loginLink) loginLink.style.display = 'none';
          if (logoutBtn) logoutBtn.style.display = '';
          if (adminLink && data.username === 'admin') {
            adminLink.style.display = '';
          }
          isAuthenticated = true;
        }
      } catch {}
    }

    const logoutBtn = document.getElementById('logout');
    if (logoutBtn) {
      logoutBtn.onclick = async () => {
        try { 
          await fetch('/api/logout', { method: 'POST' }); 
        } finally { 
          location.href = '/screens/login.html'; 
        }
      };
    }

    // ----- UI -----
    function loadUICustomization() {
      const theme = localStorage.getItem('theme') || 'light';
      const themeToggle = document.getElementById('theme-toggle');
      
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
        if (themeToggle) themeToggle.textContent = 'â˜€ï¸ ××¦×‘ ×‘×”×™×¨';
      } else {
        if (themeToggle) themeToggle.textContent = 'ğŸŒ™ ××¦×‘ ×›×”×”';
      }
      
      const lang = localStorage.getItem('language') || 'he';
      const languageToggle = document.getElementById('language-toggle');
      if (languageToggle) {
        languageToggle.textContent = lang === 'en' ? 'ğŸŒ ×¢×‘×¨×™×ª' : 'ğŸŒ English';
      }
    }

    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        const isDark = document.body.classList.contains('dark-theme');
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
        loadUICustomization();
      });
    }

    // ----- ×”×¦×’×ª ×©××œ×” -----
    function showQuestion(index) {
      if (index < 0 || index >= QUESTIONS.length) return;

      currentQuestion = index;
      const q = localizeQuestion(QUESTIONS[index]); // â† ××©×ª××© ×‘×©×›×‘×ª ×ª×¨×’×•×

      // Progress
      const progress = ((index + 1) / QUESTIONS.length) * 100;
      progressFill.style.width = `${progress}%`;

      // Counter/×›×¤×ª×•×¨×™×
      applyFinderStaticTexts();

      // Render
      questionContainer.innerHTML = `
        <div class="question-slide-in">
          <div class="question-header">
            <h2 class="question-title">${q.title}</h2>
            <p class="question-subtitle">${q.subtitle}</p>
          </div>
          <div class="options-grid">
            ${q.options.map(opt => `
              <div class="option-card" data-value="${opt.id}" onclick="selectOption('${q.id}', '${opt.id}')">
                <span class="option-emoji">${opt.emoji}</span>
                <div class="option-title">${opt.title}</div>
                <div class="option-description">${opt.description}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      // Restore selection
      if (answers[q.id]) {
        const selectedCard = questionContainer.querySelector(`[data-value="${answers[q.id]}"]`);
        if (selectedCard) selectedCard.classList.add('selected');
      }

      prevBtn.disabled = index === 0;
      nextBtn.disabled = !answers[q.id];
      nextBtn.textContent = (window.Translations?.get && (index===QUESTIONS.length-1
        ? Translations.get('finder.lastQuestion','×¦×¤×” ×‘×ª×•×¦××•×ª')
        : Translations.get('finder.nextQuestion','×©××œ×” ×”×‘××”'))) || (index===QUESTIONS.length-1 ? '×¦×¤×” ×‘×ª×•×¦××•×ª' : '×©××œ×” ×”×‘××”');
    }

    // ----- ×‘×—×™×¨×” -----
    function selectOption(questionId, optionId) {
      answers[questionId] = optionId;

      const cards = questionContainer.querySelectorAll('.option-card');
      cards.forEach(card => card.classList.remove('selected'));

      const selectedCard = questionContainer.querySelector(`[data-value="${optionId}"]`);
      if (selectedCard) {
        selectedCard.classList.add('selected');
        selectedCard.style.transform = 'scale(0.97)';
        setTimeout(() => { selectedCard.style.transform = ''; }, 150);
      }

      nextBtn.disabled = false;
    }

    // ----- API: ×”××œ×¦×•×ª -----
    async function calculateRecommendations() {
      try {
        const response = await fetch('/api/dessert-finder/recommendations', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ answers })
        });
        if (!response.ok) throw new Error('Failed to get recommendations');
        const data = await response.json();
        return Array.isArray(data.recommendations) ? data.recommendations : [];
      } catch (error) {
        console.error('Error getting recommendations:', error);
        return [];
      }
    }

    // ----- ×ª×•×¦××•×ª -----
    async function showResults() {
      // ××¦×‘ ×˜×¢×™× ×”
      const loadingText = (window.Translations?.get && Translations.get('finder.loading','×˜×•×¢×Ÿ ×”×ª×××•×ª ×œ×§×™× ×•×—×™×â€¦')) || '×˜×•×¢×Ÿ ×”×ª×××•×ª ×œ×§×™× ×•×—×™×â€¦';
      recommendationsContainer.innerHTML = `<div class="loading-box">${loadingText}</div>`;
      quizSection.style.display = 'none';
      resultsSection.style.display = 'block';

      const recommendations = await calculateRecommendations();

      if (!recommendations.length) {
        const noTitle = (window.Translations?.get && Translations.get('finder.noResultsTitle','××•×¤×¡! ×œ× ××¦×× ×• ×”×ª×××” ××•×©×œ××ª')) || '××•×¤×¡! ×œ× ××¦×× ×• ×”×ª×××” ××•×©×œ××ª';
        const noDesc  = (window.Translations?.get && Translations.get('finder.noResultsDesc','× ×¡×™ ×œ×©× ×•×ª ×—×œ×§ ××”×ª×©×•×‘×•×ª ××• ×¤× ×™ ××œ×™× ×• ×œ×™×™×¢×•×¥ ××™×©×™')) || '× ×¡×™ ×œ×©× ×•×ª ×—×œ×§ ××”×ª×©×•×‘×•×ª ××• ×¤× ×™ ××œ×™× ×• ×œ×™×™×¢×•×¥ ××™×©×™';
        recommendationsContainer.innerHTML = `
          <div style="text-align:center; padding:40px;">
            <h3>${noTitle}</h3>
            <p>${noDesc}</p>
          </div>
        `;
      } else {
        const reasonsTitle = (window.Translations?.get && Translations.get('finder.reasonsTitle','×œ××” ×–×” ××ª××™× ×œ×š:')) || '×œ××” ×–×” ××ª××™× ×œ×š:';
        const addToCartLbl = (window.Translations?.get && Translations.get('finder.addToCart','×”×•×¡×£ ×œ×¡×œ ×”×§× ×™×•×ª')) || '×”×•×¡×£ ×œ×¡×œ ×”×§× ×™×•×ª';
        recommendationsContainer.innerHTML = recommendations.map((product) => `
          <div class="recommendation-card ${product.matchLevel === 'perfect' ? 'perfect-match' : ''}">
            ${product.matchLevel === 'perfect' ? '<div class="match-badge">â­</div>' : ''}
            <img src="/images/${product.image}" alt="${product.title}" class="recommendation-image" onerror="this.src='/images/placeholder.png'">
            <h3 class="recommendation-title">${product.title}</h3>
            <div class="recommendation-price">â‚ª${product.price}</div>
            <p class="recommendation-description">${product.description || ''}</p>
            <div class="recommendation-reasons">
              <h4>${reasonsTitle}</h4>
              <ul>${(product.reasons || []).map(r => `<li>${r}</li>`).join('')}</ul>
            </div>
            <button class="add-to-cart-btn" onclick="addToCart('${product.id}', '${product.title}', this)">${addToCartLbl}</button>
          </div>
        `).join('');
      }

      // ×¢×“×›×•×Ÿ ×›×•×ª×¨×•×ª ×”×ª×•×¦××•×ª ×œ×¤×™ ×©×¤×”
      if (window.Translations?.get) {
        document.querySelector('.results-title').textContent    = Translations.get('finder.resultsTitle','××¦×× ×• ×‘×©×‘×™×œ×š!');
        document.querySelector('.results-subtitle').textContent = Translations.get('finder.resultsSubtitle','×”×§×™× ×•×—×™× ×”××•×©×œ××™× ×‘×”×ª×× ×œ×”×¢×“×¤×•×ª ×©×œ×š');
        document.getElementById('restart-quiz').textContent     = Translations.get('finder.restart','×”×ª×—×œ ×©×•×‘');
      }

      resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      resultsSection.focus();
    }

    // ----- ×”×•×¡×¤×” ×œ×¡×œ -----
    async function addToCart(productId, productTitle, buttonEl) {
      if (!isAuthenticated) {
        alert((window.Translations?.get && Translations.get('finder.mustLogin','×™×© ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×”×•×¡×™×£ ××•×¦×¨×™× ×œ×¡×œ')) || '×™×© ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×”×•×¡×™×£ ××•×¦×¨×™× ×œ×¡×œ');
        window.location.href = '/screens/login.html';
        return;
      }

      try {
        const response = await fetch('/api/cart', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ productId })
        });

        if (!response.ok) throw new Error('Failed to add to cart');

        const originalText = buttonEl.textContent;
        buttonEl.textContent = (window.Translations?.get && Translations.get('finder.added','âœ“ × ×•×¡×£ ×œ×¡×œ!')) || 'âœ“ × ×•×¡×£ ×œ×¡×œ!';
        buttonEl.style.background = '#28a745';
        buttonEl.style.transform = 'scale(0.98)';
        setTimeout(() => {
          buttonEl.textContent = originalText;
          buttonEl.style.background = '';
          buttonEl.style.transform = '';
        }, 1800);
      } catch (error) {
        console.error('Error adding to cart:', error);
        alert((window.Translations?.get && Translations.get('finder.addError','×©×’×™××” ×‘×”×•×¡×¤×” ×œ×¡×œ. × ×¡×™ ×©×•×‘.')) || '×©×’×™××” ×‘×”×•×¡×¤×” ×œ×¡×œ. × ×¡×™ ×©×•×‘.');
      }
    }

    // ----- ×”×ª×—×œ×” ××—×“×© -----
    function restartQuiz() {
      currentQuestion = 0;
      answers = {};
      quizSection.style.display = 'block';
      resultsSection.style.display = 'none';
      showQuestion(0);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ----- ×××–×™× ×™× -----
    prevBtn.addEventListener('click', () => { 
      if (currentQuestion > 0) showQuestion(currentQuestion - 1); 
    });
    
    nextBtn.addEventListener('click', () => { 
      if (currentQuestion < QUESTIONS.length - 1) {
        showQuestion(currentQuestion + 1); 
      } else {
        showResults(); 
      }
    });
    
    restartBtn.addEventListener('click', restartQuiz);

    // ×—×©×™×¤×” ×œ×’×œ×•×‘×œ×™
    window.selectOption = selectOption;
    window.addToCart = addToCart;
  </script>
</body>
</html>
