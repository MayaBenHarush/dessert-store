<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title data-page="myitems">הרכישות שלי</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===== Base / Header ===== */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;background:#fff;color:#1a1a1a;line-height:1.6}
    .header{background:#ffffcc;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .header-left{display:flex;align-items:center;gap:1rem}
    .menu-btn{background:none;border:0;font-size:1.1rem;font-weight:600;color:#1a1a1a;cursor:pointer;display:flex;align-items:center;gap:.5rem}
    .menu-btn::before{content:"☰"}
    .logo{font-size:2.2rem;font-weight:900;color:#1a1a1a;text-decoration:none;letter-spacing:-.02em}
    .header-nav{display:flex;align-items:center;gap:1rem}
    .header-btn{background:none;border:2px solid #1a1a1a;color:#1a1a1a;padding:.5rem 1rem;border-radius:20px;font-weight:600;font-size:.9rem;cursor:pointer;transition:.2s;text-decoration:none;display:flex;align-items:center;gap:.3rem}
    .header-btn:hover{background:#1a1a1a;color:#fff}
    .home-btn::before{content:"🏠"} .store-btn::before{content:"🍰"} .cart-btn::before{content:"🛒"} .login-btn::before{content:"👤"}

    /* ===== Side Nav (styled like store) ===== */
    .nav-menu{
      position:fixed;top:0;right:-320px;width:280px;height:100vh;
      background:#fffef5;box-shadow:-4px 0 20px rgba(0,0,0,.1);
      transition:right .3s ease;padding:1.5rem;z-index:2000;
      display:flex;flex-direction:column;justify-content:space-between;
      border-radius:15px 0 0 15px
    }
    .nav-menu.active{right:0}
    .nav-close{background:none;border:0;font-size:1.8rem;cursor:pointer;margin-bottom:.75rem;color:#333}
    .nav-links{flex:1;display:flex;flex-direction:column;gap:.75rem;margin-top:.25rem}
    .nav-menu a,.nav-menu button{
      padding:.8rem 1rem;border-radius:10px;text-align:right;font-weight:600;
      background:transparent;border:none;cursor:pointer;text-decoration:none;color:#333;transition:.2s
    }
    .nav-menu a:hover,.nav-menu button:hover{background:#ffffcc;color:#000}
    .nav-footer{border-top:1px solid #eee;padding-top:1rem;display:flex;flex-direction:column;gap:.6rem}

    /* Overlay */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1500;opacity:0;visibility:hidden;transition:.3s}
    .overlay.active{opacity:1;visibility:visible}

    /* ===== Main ===== */
    .main-content{max-width:1200px;margin:0 auto;padding:2rem}
    .page-header{text-align:center;margin-bottom:2rem}
    #page-title{font-size:3rem;font-weight:900;color:#1a1a1a;margin-bottom:1rem;letter-spacing:-.02em;text-transform:uppercase}

    /* Orders grouping */
    .orders-wrap{display:grid;gap:2rem;margin-top:1rem}
    .order-card{background:#fff;border-radius:16px;box-shadow:0 5px 20px rgba(0,0,0,.08);padding:1rem 1.25rem}
    .order-header{display:flex;align-items:center;justify-content:space-between;gap:.75rem;border-bottom:1px dashed #eaeaea;padding-bottom:.6rem;margin-bottom:1rem;color:#555;font-weight:700}
    .order-id{font-weight:800;color:#111}
    .order-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem}

    .purchase-card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 3px 14px rgba(0,0,0,.06);transition:transform .2s ease}
    .purchase-card:hover{transform:translateY(-3px)}
    .purchase-card .thumb{width:100%;height:180px;object-fit:cover;background:#f3f3f3;display:block}
    .purchase-card .body{padding:.9rem 1rem}
    .purchase-card h3{font-size:1.05rem;margin:0 0 .25rem 0;color:#111}
    .purchase-card .meta{font-size:.9rem;color:#666}

    /* States */
    .empty-state,.error-state,.loading-state{text-align:center;padding:4rem 2rem;border-radius:15px;margin-top:2rem}
    .empty-state{color:#666;background:#f8f8f8}
    .error-state{color:#c62828;background:#ffffcc}
    .loading-state{color:#666;background:#f8f8f8}

    /* Dark theme */
    .dark-theme{background:#1a1a1a;color:#fff}
    .dark-theme .header{background:#2d2d2d}
    .dark-theme .nav-menu{background:#2d2d2d}
    .dark-theme .nav-menu a,.dark-theme .nav-menu button{color:#fff;border-bottom-color:#444}
    .dark-theme #page-title{color:#fff}
    .dark-theme .order-card{background:#2d2d2d}
    .dark-theme .order-header{border-bottom-color:#444;color:#ddd}
    .dark-theme .order-id{color:#fff}
    .dark-theme .purchase-card{background:#2f2f2f}
    .dark-theme .purchase-card h3{color:#fff}
    .dark-theme .purchase-card .meta{color:#bbb}

    @media (max-width:768px){
      #page-title{font-size:2.2rem}
      .order-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="overlay" id="overlay"></div>

  <header class="header">
    <div class="header-left">
      <button class="menu-btn" id="menuBtn">Menu</button>
      <a href="/" class="logo">dessert</a>
    </div>
    <nav class="header-nav">
      <a href="index.html" class="header-btn home-btn">בית</a>
      <a href="store.html" class="header-btn store-btn">חנות</a>
      <a href="cart.html" class="header-btn cart-btn">סל קניות</a>
      <a href="login.html" class="header-btn login-btn" id="header-login">התחברות</a>
    </nav>
  </header>

  <!-- prettier side menu -->
  <nav class="nav-menu" id="navMenu">
    <button class="nav-close" id="navClose">×</button>

    <div class="nav-links">
      <a href="checkout.html" id="nav-checkout">תשלום</a>
      <a href="myitems.html" id="nav-myitems">הרכישות שלי</a>
      <a href="admin.html" id="nav-admin" style="display:none">ניהול</a>
      <a href="dessert-finder.html">מציאת הקינוח המושלם</a>
      <a href="wheel.html">גלגל מזל</a>
      <a href="cake-designer.html">עיצוב עוגה</a>
      <a href="recipes.html" id="nav-recipes">מתכונים</a>
    </div>

    <div class="nav-footer">
      <button id="logout" style="display:none">התנתקות</button>
      <button id="theme-toggle">🌙 מצב כהה</button>
      <button id="language-toggle">🌐 English</button>
    </div>
  </nav>

  <main class="main-content">
    <div class="page-header">
      <h1 id="page-title">הרכישות שלי</h1>
    </div>
    <section id="orders" class="orders-wrap"></section>
  </main>

  <script>
    /* ===== Menu ===== */
    const menuBtn=document.getElementById('menuBtn'),navMenu=document.getElementById('navMenu'),navClose=document.getElementById('navClose'),overlay=document.getElementById('overlay');
    const openMenu=()=>{navMenu.classList.add('active');overlay.classList.add('active');document.body.style.overflow='hidden'};
    const closeMenu=()=>{navMenu.classList.remove('active');overlay.classList.remove('active');document.body.style.overflow='auto'};
    menuBtn.addEventListener('click',openMenu);navClose.addEventListener('click',closeMenu);overlay.addEventListener('click',closeMenu);

    /* ===== Theme & Lang ===== */
    function loadUICustomization(){
      const theme=localStorage.getItem('theme')||'light';
      document.body.classList.toggle('dark-theme',theme==='dark');
      document.getElementById('language-toggle').textContent=(localStorage.getItem('language')||'he')==='en'?'🌐 עברית':'🌐 English';
    }
    document.getElementById('theme-toggle').addEventListener('click',()=>{
      const isDark=document.body.classList.contains('dark-theme');
      localStorage.setItem('theme',isDark?'light':'dark');loadUICustomization();
    });
    document.getElementById('language-toggle').addEventListener('click',()=>{
      const cur=localStorage.getItem('language')||'he';
      localStorage.setItem('language',cur==='he'?'en':'he');
      loadPurchases();loadUICustomization();
    });

    async function setupAuthButtons(){
      let logged=false, username='';
      try{const r=await fetch('/api/session');if(r.ok){logged=true;username=(await r.json()).username}}catch{}
      document.getElementById('header-login').style.display=logged?'none':'';
      document.getElementById('logout').style.display=logged?'':'none';
      document.getElementById('nav-admin').style.display=(logged&&username==='admin')?'':'none';
    }
    document.getElementById('logout').onclick=async()=>{try{await fetch('/api/logout',{method:'POST'})}finally{location.href='login.html'}};

    /* ===== Helpers ===== */
    const slugify=s=>String(s||'').trim().toLowerCase().replace(/[^\p{L}\p{N} ]/gu,'').replace(/\s+/g,'-');

    const ID_TO_IMAGE={
      'bagle-cookie':'bagle-cookie.jpg',
      'caramel-cookie':'caramel-cookie.jpg',
      'kinder-cookie':'kinder-cookie.jpg',
      'lotus-cookie':'lotus-cookie.jpg',
      'nutella-cookie':'nutella-cookie.jpg',
      'white-chocolate-cookie':'white-chocolate-cookie.jpg',
      'orange-cake':'orange-cake.jpg',
      'chocolate-cake':'chocolate-cake.jpg',
      'white-design-cake':'white-design-cake.jpg',
      'minnie-mous-cake':'minnie-mous-cake.jpg',
      'cupcakes':'cupcakes.jpg',
      'cookies-box':'cookies-box.jpg',
      '8-cookies-box':'cookies-box.jpg',
      'nutella-box':'nutella-box.jpg',
      'chocolate-pizza-xl':'pizza-cookie.jpg',
      'pizza-cookie':'pizza-cookie.jpg',
      'pizza cookie':'pizza-cookie.jpg'
    };

    function resolveImage(it){
      if (it.image) return it.image;
      const key = ID_TO_IMAGE[slugify(it.id)] || ID_TO_IMAGE[slugify(it.title)];
      if (key) return key;
      if (it.customDesign?.color){
        const file = `cake-${it.customDesign.color}.jpg`;
        return `cakes/${file}`;
      }
      return 'placeholder.png';
    }

    function buildSafeImage(src, alt){
      const img=document.createElement('img');
      img.className='thumb';
      img.alt=alt||'';
      const candidates=[];
      const file=(src||'').split('/').pop()||src;
      if(src){candidates.push(`/images/${src}`);}
      if(file){candidates.push(`/images/cakes/${file}`);}
      candidates.push('/images/placeholder.png');
      let i=0; const tryNext=()=>{ if(i<candidates.length){ img.src=candidates[i++]; } };
      img.onerror=tryNext; tryNext(); return img;
    }

    function getOrderKey(it, idx){
      return it.orderId || it.order_id || it.order ||
             (it.purchaseId ? `PID-${String(it.purchaseId).slice(0,8)}` : null) ||
             (it.date && !isNaN(new Date(it.date)) ? `TS-${new Date(it.date).toISOString().slice(0,16)}` : `GEN-${idx}`);
    }
    function titleForOrder(key, lang){
      const nice=String(key).replace(/^TS-/,'').replace('T',' ');
      return lang==='en'?`Order #${nice}`:`הזמנה מספר ${nice}`;
    }
    function groupByOrder(items){
      const map=new Map();
      items.forEach((it,idx)=>{const k=getOrderKey(it,idx); if(!map.has(k)) map.set(k,[]); map.get(k).push(it);});
      return map;
    }

    /* ===== Render ===== */
    const ordersRoot=document.getElementById('orders');

    async function loadPurchases(){
      const lang=localStorage.getItem('language')||'he';
      ordersRoot.innerHTML=`<div class="loading-state"><h2>${lang==='en'?'Loading purchases...':'טוען רכישות...'}</h2></div>`;
      try{
        const res=await fetch('/api/my-items');
        if(res.status===401){location.href='login.html';return;}
        const items=await res.json();
        if(!Array.isArray(items)||items.length===0){
          ordersRoot.innerHTML=`
            <div class="empty-state">
              <h2>${lang==='en'?'No purchases yet':'אין רכישות עדיין'}</h2>
              <p>${lang==='en'?'Visit our store for delicious products!':'בקרי בחנות שלנו למגוון מוצרים טעימים!'}</p>
              <a href="store.html">${lang==='en'?'Go to Store':'לחנות'}</a>
            </div>`;
          return;
        }

        const grouped=groupByOrder(items);
        ordersRoot.innerHTML='';
        const sorted=[...grouped.entries()].sort((a,b)=>{
          const ad=Math.max(...a[1].map(x=>+new Date(x.date)));
          const bd=Math.max(...b[1].map(x=>+new Date(x.date)));
          return bd-ad;
        });

        for(const [orderKey, arr] of sorted){
          const sec=document.createElement('section');
          sec.className='order-card';

          const header=document.createElement('div');
          header.className='order-header';
          header.innerHTML=`<div>${lang==='en'?'Grouped by order':'רכישות מקובצות לפי הזמנה'}</div>
                            <div class="order-id">${titleForOrder(orderKey,lang)}</div>`;
          sec.appendChild(header);

          const grid=document.createElement('div'); grid.className='order-grid';

          for(const it of arr){
            const card=document.createElement('article'); card.className='purchase-card';
            const img=buildSafeImage(resolveImage(it), it.title||it.id); card.appendChild(img);
            const body=document.createElement('div'); body.className='body';
            const dateStr=(it.date && !isNaN(new Date(it.date)))
              ? new Date(it.date).toLocaleDateString(lang==='he'?'he-IL':'en-US')
              : (lang==='en'?'Unknown date':'תאריך לא ידוע');
            body.innerHTML=`<h3>${it.title || it.id || ''}</h3><div class="meta">${dateStr}</div>`;
            card.appendChild(body);
            grid.appendChild(card);
          }

          sec.appendChild(grid);
          ordersRoot.appendChild(sec);
        }
      }catch(e){
        ordersRoot.innerHTML=`<div class="error-state"><h2>${lang==='en'?'Error loading purchases':'שגיאה בטעינת הרכישות'}</h2></div>`;
      }
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      await setupAuthButtons();
      loadUICustomization();
      loadPurchases();
    });
  </script>
</body>
</html>
