<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×”×¨×›×™×©×•×ª ×©×œ×™</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/styles.css">
</head>
<body class="myitems-page">
  <nav>
    <a href="store.html" id="nav-store">×—× ×•×ª</a>
    <a href="cart.html" id="nav-cart">×¡×œ ×”×§× ×™×•×ª</a>
    <a href="checkout.html" id="nav-checkout">×ª×©×œ×•×</a>
    <a href="myitems.html" id="nav-myitems">×”×¨×›×™×©×•×ª ×©×œ×™</a>
    <a id="login-link" href="login.html">×”×ª×—×‘×¨×•×ª</a>
    <button id="logout" style="display:none">×”×ª× ×ª×§×•×ª</button>
    <a id="admin-link" href="admin.html" style="display:none">× ×™×”×•×œ</a>
    <button id="theme-toggle">ğŸŒ™ ××¦×‘ ×›×”×”</button>
    <button id="language-toggle">ğŸŒ English</button>
  </nav>

  <h1 id="page-title">×”×¨×›×™×©×•×ª ×©×œ×™</h1>
  <div id="list"></div>

  <script>
    // ×˜×¢×™× ×ª ×”×ª×××•×ª ××™×©×™×•×ª ×-localStorage
    function loadUICustomization() {
      const theme = localStorage.getItem('theme') || 'light';
      const themeToggle = document.getElementById('theme-toggle');
      const languageToggle = document.getElementById('language-toggle');
      
      // ×¢×“×›×•×Ÿ × ×•×©×
      if (theme === 'dark') {
        document.body.classList.add('dark-theme');
        themeToggle.textContent = 'â˜€ï¸ ××¦×‘ ×‘×”×™×¨';
      } else {
        document.body.classList.remove('dark-theme');
        themeToggle.textContent = 'ğŸŒ™ ××¦×‘ ×›×”×”';
      }
      
      // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨ ×©×¤×”
      const currentLanguage = localStorage.getItem('language') || 'he';
      if (currentLanguage === 'en') {
        languageToggle.textContent = 'ğŸŒ ×¢×‘×¨×™×ª';
      } else {
        languageToggle.textContent = 'ğŸŒ English';
      }
      
      // ×¢×“×›×•×Ÿ ×ª×¨×’×•××™ ×”×××©×§
      updateInterfaceLanguage(currentLanguage);
    }

    function updateInterfaceLanguage(lang) {
      const translations = {
        he: {
          'nav-store': '×—× ×•×ª',
          'nav-cart': '×¡×œ ×”×§× ×™×•×ª', 
          'nav-checkout': '×ª×©×œ×•×',
          'nav-myitems': '×”×¨×›×™×©×•×ª ×©×œ×™',
          'nav-login': '×”×ª×—×‘×¨×•×ª',
          'nav-logout': '×”×ª× ×ª×§×•×ª',
          'nav-admin': '× ×™×”×•×œ',
          'page-title': '×”×¨×›×™×©×•×ª ×©×œ×™',
          'theme-dark': 'ğŸŒ™ ××¦×‘ ×›×”×”',
          'theme-light': 'â˜€ï¸ ××¦×‘ ×‘×”×™×¨'
        },
        en: {
          'nav-store': 'Store',
          'nav-cart': 'Shopping Cart',
          'nav-checkout': 'Checkout', 
          'nav-myitems': 'My Purchases',
          'nav-login': 'Login',
          'nav-logout': 'Logout',
          'nav-admin': 'Admin',
          'page-title': 'My Purchases',
          'theme-dark': 'ğŸŒ™ Dark Mode',
          'theme-light': 'â˜€ï¸ Light Mode'
        }
      };

      const texts = translations[lang];
      if (!texts) return;

      // ×¢×“×›×•×Ÿ × ×™×•×•×˜
      document.getElementById('nav-store').textContent = texts['nav-store'];
      document.getElementById('nav-cart').textContent = texts['nav-cart'];
      document.getElementById('nav-checkout').textContent = texts['nav-checkout'];
      document.getElementById('nav-myitems').textContent = texts['nav-myitems'];
      document.getElementById('login-link').textContent = texts['nav-login'];
      document.getElementById('logout').textContent = texts['nav-logout'];
      const adminLink = document.getElementById('admin-link');
      if (adminLink) adminLink.textContent = texts['nav-admin'];

      // ×¢×“×›×•×Ÿ ×›×•×ª×¨×ª ×”×¢××•×“
      document.getElementById('page-title').textContent = texts['page-title'];
      
      // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨ × ×•×©×
      const theme = localStorage.getItem('theme') || 'light';
      const themeToggle = document.getElementById('theme-toggle');
      themeToggle.textContent = theme === 'dark' ? texts['theme-light'] : texts['theme-dark'];

      // ×¢×“×›×•×Ÿ ×›×™×•×•×Ÿ ×”×“×£
      if (lang === 'en') {
        document.documentElement.setAttribute('dir', 'ltr');
        document.documentElement.setAttribute('lang', 'en');
      } else {
        document.documentElement.setAttribute('dir', 'rtl');
        document.documentElement.setAttribute('lang', 'he');
      }
    }

    // ×”×—×œ×¤×ª × ×•×©×
    document.getElementById('theme-toggle').addEventListener('click', () => {
      const isDark = document.body.classList.contains('dark-theme');
      const newTheme = isDark ? 'light' : 'dark';
      localStorage.setItem('theme', newTheme);
      loadUICustomization();
    });

    // ×”×—×œ×¤×ª ×©×¤×”
    document.getElementById('language-toggle').addEventListener('click', () => {
      const currentLanguage = localStorage.getItem('language') || 'he';
      const newLanguage = currentLanguage === 'he' ? 'en' : 'he';
      localStorage.setItem('language', newLanguage);
      
      // ×¢×“×›×•×Ÿ ××™×™×“×™ ×©×œ ×›×¤×ª×•×¨ ×”×©×¤×”
      const languageToggle = document.getElementById('language-toggle');
      if (newLanguage === 'en') {
        languageToggle.textContent = 'ğŸŒ ×¢×‘×¨×™×ª';
      } else {
        languageToggle.textContent = 'ğŸŒ English';
      }
      
      // ×¢×“×›×•×Ÿ ×›×œ ×”×××©×§
      updateInterfaceLanguage(newLanguage);
      
      // ×˜×¢×™× ×” ××—×“×© ×¢× ×”×©×¤×” ×”×—×“×©×”
      loadMyItems();
    });

    async function setupAuthButtons() {
      const loginLink = document.getElementById('login-link');
      const logoutBtn = document.getElementById('logout');
      const adminLink = document.getElementById('admin-link');
      let loggedIn = false;
      let username = '';
      
      try { 
        const r = await fetch('/api/session'); 
        if (r.ok) {
          loggedIn = true;
          const data = await r.json();
          username = data.username;
        }
      } catch {}
      
      loginLink.style.display = loggedIn ? 'none' : '';
      logoutBtn.style.display = loggedIn ? '' : 'none';
      
      // ×”×¦×’×ª ×§×™×©×•×¨ × ×™×”×•×œ ×¨×§ ×œ××©×ª××© admin
      if (adminLink) {
        adminLink.style.display = (loggedIn && username === 'admin') ? '' : 'none';
      }
    }
    
    setupAuthButtons();
    document.getElementById('logout').onclick = async () => {
      try { await fetch('/api/logout', { method: 'POST' }); }
      finally { location.href = 'login.html'; }
    };

    const list = document.getElementById('list');
    async function loadMyItems() {
      try {
        const res = await fetch('/api/my-items');
        if (res.status === 401) { location.href = 'login.html'; return; }
        const items = await res.json();
        const currentLanguage = localStorage.getItem('language') || 'he';
        
        if (!Array.isArray(items) || !items.length) {
          const noPurchasesText = currentLanguage === 'en' ? 'No purchases yet.' : '××™×Ÿ ×¨×›×™×©×•×ª ×¢×“×™×™×Ÿ.';
          list.innerHTML = `<p class="empty">${noPurchasesText}</p>`; 
          return;
        }

        // ××™×œ×•×Ÿ ×ª×¨×’×•××™× ×™×©×™×¨
        const productTranslations = {
          'bagle-cookie': { he: '×¢×•×’×™×™×ª ×‘×™×™×’×œ', en: 'Bagel Cookie' },
          'caramel-cookie': { he: '×¢×•×’×™×™×ª ×§×¨××œ', en: 'Caramel Cookie' },
          'chocolate-cake': { he: '×¢×•×’×ª ×©×•×§×•×œ×“', en: 'Chocolate Cake' },
          'cookies-box': { he: '×§×•×¤×¡×ª ×¢×•×’×™×•×ª', en: 'Cookies Box' },
          'cupcakes': { he: '×§××¤×§×™×™×§×¡', en: 'Cupcakes' },
          'kinder-cookie': { he: '×¢×•×’×™×™×ª ×§×™× ×“×¨', en: 'Kinder Cookie' },
          'lotus-cookie': { he: '×¢×•×’×™×™×ª ×œ×•×˜×•×¡', en: 'Lotus Cookie' },
          'minnie-mous-cake': { he: '×¢×•×’×ª ××™× ×™ ×××•×¡', en: 'Minnie Mouse Cake' },
          'nutella-box': { he: '×§×•×¤×¡×ª × ×•×˜×œ×”', en: 'Nutella Box' },
          'nutella-cookie': { he: '×¢×•×’×™×™×ª × ×•×˜×œ×”', en: 'Nutella Cookie' },
          'orange-cake': { he: '×¢×•×’×ª ×ª×¤×•×–', en: 'Orange Cake' },
          'pizza-cookie': { he: '×¢×•×’×™×™×ª ×¤×™×¦×”', en: 'Pizza Cookie' },
          'white-chocolate-cookie': { he: '×¢×•×’×™×™×ª ×©×•×§×•×œ×“ ×œ×‘×Ÿ', en: 'White Chocolate Cookie' },
          'white-design-cake': { he: '×¢×•×’×” ×œ×‘× ×” ××¢×•×¦×‘×ª', en: 'White Design Cake' }
        };
        
        list.innerHTML = '';
        for (const it of items) {
          const card = document.createElement('div');
          card.className = 'item';
          const dt = it.date ? new Date(it.date) : null;
          const dateStr = dt ? dt.toLocaleString(currentLanguage === 'he' ? 'he-IL' : 'en-US') : '';
          
          // ×ª×¨×’×•× ×©× ×”××•×¦×¨
          let productName;
          if (productTranslations[it.id] && productTranslations[it.id][currentLanguage]) {
            productName = productTranslations[it.id][currentLanguage];
          } else {
            productName = it.title;
          }
          
          card.innerHTML = `
            <img loading="lazy" src="/images/${it.image}" alt="${productName}">
            <div>
              <h3>${productName}</h3>
              <div class="meta">${dateStr}</div>
              <p>${it.description || ''}</p>
            </div>
          `;
          list.appendChild(card);
        }
      } catch {
        const errorText = localStorage.getItem('language') === 'en' ? 'Error loading purchases.' : '×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¨×›×™×©×•×ª.';
        list.innerHTML = `<p class="empty">${errorText}</p>`;
      }
    }

    loadUICustomization();
    loadMyItems();
  </script>
</body>
</html>