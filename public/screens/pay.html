<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×ª×©×œ×•× (×“××•)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/styles.css" />
  <style>
    .payment-container {
      max-width: 500px;
      margin: 0 auto;
      background: var(--bg-card);
      padding: 30px;
      border-radius: 20px;
      box-shadow: var(--shadow-lg);
    }
    .payment-form {
      display: grid;
      gap: 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .form-group label {
      font-weight: 600;
      color: var(--text-primary);
    }
    .form-group input {
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: var(--bg-primary);
    }
    .form-group input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
      background: white;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    .pay-button {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }
    .pay-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    .pay-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .demo-notice {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid #ffc107;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
      color: #856404;
      font-size: 14px;
    }
    .error-message {
      background: #ffe6e6;
      border: 1px solid #ff9999;
      color: #cc0000;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: none;
    }
    
    /* ×§×•×¤×•×Ÿ ×”× ×—×” */
    .coupon-section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px dashed #ccc;
    }
    .coupon-input-row {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }
    .coupon-input-row input {
      flex: 1;
    }
    .coupon-apply-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
      font-size: 14px;
    }
    .coupon-apply-btn:hover {
      background: #218838;
    }
    .coupon-apply-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .coupon-message {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }
    .coupon-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .coupon-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    /* ×¡×™×›×•× ×¢×œ×•×™×•×ª */
    .summary-box {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #e2e8f0;
    }
    .summary-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      padding: 8px 0;
      font-size: 16px;
    }
    .summary-total {
      font-weight: 700;
      font-size: 20px;
      color: var(--primary-color);
      border-top: 2px solid var(--primary-color);
      padding-top: 15px;
      margin-top: 15px;
    }
    .shipping-line {
      color: #666;
      font-size: 15px;
    }
    .discount-line {
      color: #28a745;
      font-weight: 600;
    }
    .strikethrough {
      text-decoration: line-through;
      color: #999;
    }
  </style>
</head>
<body>
  <nav>
    <a href="store.html">×—× ×•×ª</a>
    <a href="cart.html">×¡×œ ×”×§× ×™×•×ª</a>
    <a href="checkout.html">×‘×—×™×¨×ª ×¤×¨×™×˜×™×</a>
    <a href="myitems.html">×”×¨×›×™×©×•×ª ×©×œ×™</a>
    <a href="cake-designer.html">×¢×™×¦×•×‘ ×¢×•×’×”</a>
    <a id="login-link" href="login.html">×”×ª×—×‘×¨×•×ª</a>
    <button id="logout" style="display:none">×”×ª× ×ª×§×•×ª</button>
    <a href="admin.html" id="admin-link" style="display:none">× ×™×”×•×œ</a>
    <button id="theme-toggle">ğŸŒ™ ××¦×‘ ×›×”×”</button>
    <button id="language-toggle">ğŸŒ English</button>
  </nav>

  <div class="payment-container">
    <h1>×ª×©×œ×•× (×“××•)</h1>
    
    <div class="demo-notice">
      ×–×”×• ×ª×©×œ×•× ×“××• ×œ×¦×•×¨×›×™ ×ª×¨×’×•×œ ×‘×œ×‘×“ - ××™×Ÿ ×©××™×¨×” ×©×œ ×¤×¨×˜×™ ×›×¨×˜×™×¡
    </div>

    <div id="error-message" class="error-message"></div>

    <!-- ×§×•×¤×•×Ÿ ×”× ×—×” - ×§×•×“× -->
    <div class="coupon-section">
      <div class="form-group">
        <label for="coupon-code">×§×•×¤×•×Ÿ ×”× ×—×” (××•×¤×¦×™×•× ×œ×™)</label>
        <div class="coupon-input-row">
          <input type="text" id="coupon-code" placeholder="×”×›× ×¡ ×§×•×“ ×§×•×¤×•×Ÿ" maxlength="20">
          <button type="button" id="apply-coupon-btn" class="coupon-apply-btn">×”×—×œ</button>
        </div>
      </div>
      <div id="coupon-message" class="coupon-message" style="display: none;"></div>
    </div>

    <!-- ×¢×œ×•×ª ×›×•×œ×œ×ª - ××—×¨×™ ×”×§×•×¤×•×Ÿ -->
    <div class="summary-box" id="order-summary">
      <h3>×¢×œ×•×ª ×›×•×œ×œ×ª</h3>
      <div id="summary-content">
        <div class="summary-line">
          <span>×¢×œ×•×ª ×”×¤×¨×™×˜×™×:</span>
          <span id="items-cost">â‚ª0</span>
        </div>
        <div class="summary-line shipping-line">
          <span>×¢×œ×•×ª ××©×œ×•×—:</span>
          <span id="shipping-cost">â‚ª29</span>
        </div>
        <div id="discount-line" class="summary-line discount-line" style="display: none;">
          <span id="discount-text">×”× ×—×”:</span>
          <span id="discount-amount">-â‚ª0</span>
        </div>
        <div class="summary-line summary-total">
          <span>×¡×”"×› ×œ×ª×©×œ×•×:</span>
          <span id="total-cost">â‚ª29</span>
        </div>
      </div>
    </div>

    <form class="payment-form" id="payment-form">
      <div class="form-group">
        <label for="cardNumber">××¡×¤×¨ ×›×¨×˜×™×¡</label>
        <input type="text" id="cardNumber" name="cardNumber" 
               placeholder="1234 5678 9012 3456" 
               inputmode="numeric" 
               autocomplete="cc-number" required>
      </div>

      <div class="form-group">
        <label for="cardName">×©× ×‘×¢×œ/×ª ×”×›×¨×˜×™×¡</label>
        <input type="text" id="cardName" name="cardName" 
               placeholder="×©× ××œ×" 
               autocomplete="cc-name" required>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="expiry">×ª×•×§×£ (MM/YY)</label>
          <input type="text" id="expiry" name="expiry" 
                 placeholder="12/27" 
                 inputmode="numeric" 
                 autocomplete="cc-exp" required>
        </div>
        <div class="form-group">
          <label for="cvv">CVV</label>
          <input type="text" id="cvv" name="cvv" 
                 placeholder="123" 
                 inputmode="numeric" 
                 autocomplete="cc-csc" required>
        </div>
      </div>

      <button type="submit" class="pay-button" id="pay-btn">
        ×©×œ× ×¢×›×©×™×•
      </button>
    </form>
  </div>

  <script>
    // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨
    const nis = n => `â‚ª${n}`;
    const slug = s => String(s||'').trim().toLowerCase().replace(/[^\p{L}\p{N} ]/gu,'').replace(/\s+/g,'-');

    // ×”×’×“×¨×•×ª ×§×•×¤×•× ×™× ×•××©×œ×•×—
    const SHIPPING_COST = 29;
    const COUPONS = {
      'WELCOME10': { discount: 10, type: 'percent', description: '×”× ×—×” ×©×œ 10%' },
      'SAVE20': { discount: 20, type: 'fixed', description: '×”× ×—×” ×©×œ 20 â‚ª' },
      'FREESHIP': { discount: 29, type: 'shipping', description: '××©×œ×•×— ×—×™× ×' },
      'VIP15': { discount: 15, type: 'percent', description: '×”× ×—×” ×©×œ 15% ×œ×œ×§×•×—×•×ª VIP' }
    };

    // ××—×™×¨×•×Ÿ ×•×©××•×ª ××•×¦×¨×™× (×‘×”×ª×× ×œ×¤×¨×•×™×™×§×˜ ×©×œ×š)
    const PRICE_MAP = {
      'chocolate-cake':150, 'cookies-box':125, 'cupcakes':160, 'minnie-mous-cake':300,
      'nutella-box':70, 'pizza-cookie':120, 'orange-cake':70, 'white-design-cake':140
    };
    
    const NAME_HE = {
      'chocolate-cake':'×¢×•×’×ª ×©×•×§×•×œ×“','cookies-box':'×××¨×– ×¢×•×’×™×•×ª','cupcakes':'×§××¤×§×™×™×§×¡',
      'minnie-mous-cake':'×¢×•×’×ª ××™× ×™ ×××•×¡','nutella-box':'×××¨×– × ×•×˜×œ×”','pizza-cookie':'×¤×™×¦×ª ×©×•×§×•×œ×“',
      'orange-cake':'×¢×•×’×ª ×ª×¤×•×–×™×','white-design-cake':'×¢×•×’×” ××¢×•×¦×‘×ª ×œ×‘× ×”',
      'bagle-cookie':'×¢×•×’×™×™×ª ×‘×™×™×’×œ','caramel-cookie':'×¢×•×’×™×™×ª ×§×¨××œ','kinder-cookie':'×¢×•×’×™×™×ª ×§×™× ×“×¨',
      'lotus-cookie':'×¢×•×’×™×™×ª ×œ×•×˜×•×¡','nutella-cookie':'×¢×•×’×™×™×ª × ×•×˜×œ×”','white-chocolate-cookie':'×¢×•×’×™×™×ª ×©×•×§×•×œ×“ ×œ×‘×Ÿ'
    };

    const priceOf = (p) => {
      const id = String(p.id || p.title || '');
      const keys = [id, slug(id), p.title, slug(p.title)];
      const hit = keys.find(k => k && PRICE_MAP[k] != null);
      return hit ? PRICE_MAP[hit] : (/(cookie)/i.test(String(id)+String(p.title)) ? 17 : 0);
    };

    const nameHe = (p) => {
      const id = String(p.id || p.title || '');
      const keys = [id, slug(id), p.title, slug(p.title)];
      const hit = keys.find(k => k && NAME_HE[k]);
      return hit ? NAME_HE[hit] : (p.title || id);
    };

    let currentCoupon = null;
    let orderData = {
      subtotal: 0,
      shipping: SHIPPING_COST,
      discount: 0,
      total: 0,
      items: []
    };

    // ××ª×—×•×œ ×”×“×£
    (async function setupAuth(){
      try{
        const r = await fetch('/api/session');
        if (r.ok){
          const d = await r.json();
          document.getElementById('login-link').style.display = 'none';
          document.getElementById('logout').style.display = '';
          if (d.username === 'admin') document.getElementById('admin-link').style.display = '';
        }
      }catch{}
    })();

    document.getElementById('logout').onclick = async () => { 
      try { await fetch('/api/logout', { method:'POST' }); } 
      finally { location.href='login.html'; } 
    };

    // ×”××¨×ª ×ª×’×•×‘×ª /api/cart ×œ××¤×” {id:qty}
    function toQtyMap(payload) {
      if (payload && typeof payload === 'object' && Array.isArray(payload.items)) payload = payload.items;
      const q = {};
      if (Array.isArray(payload)) {
        for (const it of payload) {
          if (typeof it === 'string') { 
            q[it] = (q[it] || 0) + 1; 
            continue; 
          }
          if (it && typeof it === 'object') {
            const id = it.id || it.productId;
            const qty = Number(it.qty ?? it.quantity ?? 1);
            if (id) q[id] = (q[id] || 0) + qty;
          }
        }
      } else if (payload && typeof payload === 'object') {
        for (const [id, val] of Object.entries(payload)) {
          q[id] = typeof val === 'number' ? val : Number(val?.qty ?? val?.quantity ?? 1);
        }
      }
      return q;
    }

    // ×˜×¢×™× ×ª × ×ª×•× ×™ ××•×¦×¨×™×
    let PRODUCTS = [];
    async function loadProducts() {
      try {
        const r = await fetch('/api/products');
        PRODUCTS = r.ok ? await r.json() : [];
      } catch {}
    }

    // ×§×‘×œ×ª ×¤×¨×˜×™ ×”×”×–×× ×” ××”×¢×’×œ×”
    async function loadOrderSummary() {
      try {
        // ×˜×¢×™× ×ª × ×ª×•× ×™ ×”×¢×’×œ×” ×œ×¡×™×›×•×
        const res = await fetch('/api/cart-with-custom');
        if (res.status === 401) {
          location.href = 'login.html';
          return;
        }

        let cartData;
        if (res.ok) {
          cartData = await res.json();
        } else {
          // fallback ×œAPI ×”×™×©×Ÿ
          const oldRes = await fetch('/api/cart');
          if (oldRes.status === 401) {
            location.href = 'login.html';
            return;
          }
          const quantities = toQtyMap(await oldRes.json());
          cartData = { regularItems: quantities, customCakes: [] };
        }

        const { regularItems = {}, customCakes = [] } = cartData;
        
        let subtotal = 0;
        let itemCount = 0;
        orderData.items = [];

        // ×—×™×©×•×‘ ××•×¦×¨×™× ×¨×’×™×œ×™×
        for (const [id, qty] of Object.entries(regularItems)) {
          const p = PRODUCTS.find(x => String(x.id) === String(id)) || { id, title: id };
          const price = priceOf(p);
          const itemSubtotal = price * qty;
          subtotal += itemSubtotal;
          itemCount += qty;
          
          orderData.items.push({
            id,
            name: nameHe(p),
            qty,
            price,
            subtotal: itemSubtotal,
            type: 'regular'
          });
        }

        // ×—×™×©×•×‘ ×¢×•×’×•×ª ××•×ª×××•×ª
        if (customCakes.length > 0) {
          const grouped = {};
          customCakes.forEach(cake => {
            const key = `${cake.design.size}-${cake.design.color}`;
            if (!grouped[key]) {
              grouped[key] = { cake: cake, count: 0 };
            }
            grouped[key].count++;
          });

          for (const group of Object.values(grouped)) {
            const cake = group.cake;
            const itemSubtotal = cake.design.price * group.count;
            subtotal += itemSubtotal;
            itemCount += group.count;
            const sizeText = cake.design.size === 'bento' ? '×‘× ×˜×•' : '×’×“×•×œ×”';
            const itemName = `×¢×•×’×” ××•×ª×××ª ${sizeText}`;
            
            orderData.items.push({
              id: `custom-${cake.id}`,
              name: itemName,
              qty: group.count,
              price: cake.design.price,
              subtotal: itemSubtotal,
              type: 'custom'
            });
          }
        }

        if (itemCount === 0) {
          document.getElementById('items-cost').textContent = 'â‚ª0';
          document.getElementById('total-cost').textContent = nis(SHIPPING_COST);
          document.getElementById('pay-btn').textContent = `×©×œ× ${nis(SHIPPING_COST)}`;
          document.getElementById('pay-btn').disabled = true;
          return;
        }

        orderData.subtotal = subtotal;
        updateOrderDisplay();

      } catch (error) {
        console.error('Error loading order summary:', error);
        document.getElementById('items-cost').textContent = '×©×’×™××”';
      }
    }

    // ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª ×”×¢×œ×•×™×•×ª
    function updateOrderDisplay() {
      let discount = 0;
      let shippingCost = orderData.shipping;
      let discountText = '';
      
      if (currentCoupon) {
        const couponData = COUPONS[currentCoupon];
        if (couponData.type === 'percent') {
          discount = Math.round(orderData.subtotal * couponData.discount / 100);
          discountText = `×”× ×—×” ×©×œ ${couponData.discount}% ×¢×œ ×”×¤×¨×™×˜×™×`;
        } else if (couponData.type === 'fixed') {
          discount = Math.min(couponData.discount, orderData.subtotal);
          discountText = `×”× ×—×” ×©×œ ${discount} â‚ª ×¢×œ ×”×¤×¨×™×˜×™×`;
        } else if (couponData.type === 'shipping') {
          shippingCost = 0;
          discountText = '××©×œ×•×— ×—×™× ×';
        }
      }

      orderData.discount = discount;
      orderData.total = orderData.subtotal - discount + shippingCost;

      // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
      document.getElementById('items-cost').textContent = nis(orderData.subtotal);
      
      // ×¢×“×›×•×Ÿ ××©×œ×•×—
      const shippingElement = document.getElementById('shipping-cost');
      if (shippingCost === 0 && currentCoupon && COUPONS[currentCoupon].type === 'shipping') {
        shippingElement.innerHTML = '<span class="strikethrough">â‚ª29</span> ×—×™× ×!';
        shippingElement.style.color = '#28a745';
      } else {
        shippingElement.textContent = 'â‚ª29';
        shippingElement.style.color = '#666';
      }
      
      // ×¢×“×›×•×Ÿ ×”× ×—×”
      const discountLine = document.getElementById('discount-line');
      if (discount > 0) {
        document.getElementById('discount-text').textContent = discountText + ':';
        document.getElementById('discount-amount').textContent = `-${nis(discount)}`;
        discountLine.style.display = 'flex';
      } else if (currentCoupon && COUPONS[currentCoupon].type === 'shipping' && shippingCost === 0) {
        document.getElementById('discount-text').textContent = discountText + ':';
        document.getElementById('discount-amount').textContent = '×”×•×—×œ';
        discountLine.style.display = 'flex';
      } else {
        discountLine.style.display = 'none';
      }
      
      // ×¢×“×›×•×Ÿ ×¡×”"×›
      document.getElementById('total-cost').textContent = nis(orderData.total);
      document.getElementById('pay-btn').textContent = `×©×œ× ${nis(orderData.total)}`;
    }

    // ×˜×™×¤×•×œ ×‘×§×•×¤×•×Ÿ ×”× ×—×”
    document.getElementById('apply-coupon-btn').addEventListener('click', applyCoupon);
    document.getElementById('coupon-code').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') applyCoupon();
    });

    function applyCoupon() {
      const couponCode = document.getElementById('coupon-code').value.trim().toUpperCase();
      const messageDiv = document.getElementById('coupon-message');
      const btn = document.getElementById('apply-coupon-btn');
      
      if (!couponCode) {
        showCouponMessage('×× × ×”×›× ×¡ ×§×•×“ ×§×•×¤×•×Ÿ', 'error');
        return;
      }

      btn.disabled = true;
      btn.textContent = '×‘×•×“×§...';

      // ×¡×™××•×œ×¦×™×” ×©×œ ×‘×“×™×§×ª ×§×•×¤×•×Ÿ
      setTimeout(() => {
        if (COUPONS[couponCode]) {
          currentCoupon = couponCode;
          const coupon = COUPONS[couponCode];
          showCouponMessage(`âœ… ×”×§×•×¤×•×Ÿ ×”×•×—×œ ×‘×”×¦×œ×—×”! ${coupon.description}`, 'success');
          document.getElementById('coupon-code').disabled = true;
          btn.textContent = '×”×•×—×œ';
          updateOrderDisplay();
        } else {
          showCouponMessage('âŒ ×§×•×“ ×§×•×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ', 'error');
          btn.disabled = false;
          btn.textContent = '×”×—×œ';
        }
      }, 1000);
    }

    function showCouponMessage(message, type) {
      const messageDiv = document.getElementById('coupon-message');
      messageDiv.className = `coupon-message ${type === 'success' ? 'coupon-success' : 'coupon-error'}`;
      messageDiv.innerHTML = message;
      messageDiv.style.display = 'block';
    }

    // ×˜×™×¤×•×œ ×‘×˜×•×¤×¡ ×”×ª×©×œ×•×
    document.getElementById('payment-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('pay-btn');
      const errorMsg = document.getElementById('error-message');
      const form = e.target;
      
      // ×”×¡×ª×¨×ª ×©×’×™××•×ª ×§×•×“××•×ª
      errorMsg.style.display = 'none';
      
      // ×•×œ×™×“×¦×™×” ×‘×¡×™×¡×™×ª
      const cardName = form.cardName.value.trim();
      const cardNumber = form.cardNumber.value.replace(/[\s-]/g, '');
      const expiry = form.expiry.value.trim();
      const cvv = form.cvv.value.trim();
      
      if (!cardName) {
        showError('× × ×œ××œ× ×©× ×‘×¢×œ ×”×›×¨×˜×™×¡');
        return;
      }
      
      if (!/^\d{12,19}$/.test(cardNumber)) {
        showError('××¡×¤×¨ ×›×¨×˜×™×¡ ×œ× ×ª×§×™×Ÿ (12-19 ×¡×¤×¨×•×ª)');
        return;
      }
      
      if (!/^\d{2}\/\d{2}$/.test(expiry)) {
        showError('×ª×•×§×£ ×œ× ×ª×§×™×Ÿ (×¤×•×¨××˜: MM/YY)');
        return;
      }
      
      if (!/^\d{3,4}$/.test(cvv)) {
        showError('CVV ×œ× ×ª×§×™×Ÿ (3-4 ×¡×¤×¨×•×ª)');
        return;
      }
      
      // ×”×ª×—×œ×ª ×ª×”×œ×™×š ×”×ª×©×œ×•×
      btn.disabled = true;
      btn.textContent = '××¢×‘×“ ×ª×©×œ×•×...';
      
      try {
        // ×©×œ×™×—×ª ×‘×§×©×ª ×ª×©×œ×•×
        const response = await fetch('/api/pay', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cardName,
            cardNumber,
            expiry,
            cvv,
            orderData: orderData,
            coupon: currentCoupon
          })
        });

        if (response.ok) {
          // ×”×ª×©×œ×•× ×”×¦×œ×™×—
          location.href = 'thankyou.html';
        } else {
          const error = await response.json().catch(() => ({}));
          showError(error.error || '×©×’×™××” ×‘×ª×©×œ×•×. × ×¡×” ×©×•×‘.');
          btn.disabled = false;
          btn.textContent = `×©×œ× ${nis(orderData.total)}`;
        }
      } catch (error) {
        console.error('Payment error:', error);
        showError('×©×’×™××ª ×¨×©×ª. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×•× ×¡×” ×©×•×‘.');
        btn.disabled = false;
        btn.textContent = `×©×œ× ${nis(orderData.total)}`;
      }
    });

    function showError(message) {
      const errorMsg = document.getElementById('error-message');
      errorMsg.textContent = message;
      errorMsg.style.display = 'block';
      errorMsg.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // ×¤×•×¨××˜ ××•×˜×•××˜×™ ×œ××¡×¤×¨ ×›×¨×˜×™×¡
    document.getElementById('cardNumber').addEventListener('input', (e) => {
      let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
      value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
      e.target.value = value;
    });

    // ×¤×•×¨××˜ ××•×˜×•××˜×™ ×œ×ª×•×§×£
    document.getElementById('expiry').addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2, 4);
      }
      e.target.value = value;
    });

    // ×¤×•×¨××˜ ××•×˜×•××˜×™ ×œ-CVV
    document.getElementById('cvv').addEventListener('input', (e) => {
      e.target.value = e.target.value.replace(/\D/g, '').substring(0, 4);
    });

    // ×˜×¢×™× ×” ×¨××©×•× ×™×ª
    (async() => { 
      await loadProducts(); 
      setupAuth();
      await loadOrderSummary();
    })();
  </script>
</body>
</html>